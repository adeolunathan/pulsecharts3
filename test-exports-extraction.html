<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test ChartExports Extraction</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        .pass { background: #d4edda; color: #155724; }
        .fail { background: #f8d7da; color: #721c24; }
        #test-chart {
            width: 800px;
            height: 500px;
            border: 1px solid #ddd;
            margin: 10px 0;
        }
        .export-demo {
            padding: 10px;
            margin: 5px;
            border: 1px solid #ccc;
            display: inline-block;
            font-family: monospace;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
    </style>
</head>
<body>
    <h1>Test ChartExports Extraction</h1>
    <p>Testing that ChartExports works as extracted export functions and SankeyChart still renders and exports.</p>
    
    <div id="result" class="test-result">Testing...</div>
    
    <h2>Export Function Tests</h2>
    <div>
        <button onclick="testPNGExport()">Test PNG Export</button>
        <button onclick="testSVGExport()">Test SVG Export</button>
        <button onclick="testCSVExport()">Test CSV Export</button>
        <button onclick="testGenerateFileName()">Test Generate Filename</button>
    </div>
    <div id="export-test"></div>
    
    <h2>Chart Rendering Test</h2>
    <div id="test-chart"></div>

    <!-- Load Dependencies -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/d3-sankey@0.12.3/dist/d3-sankey.min.js"></script>
    
    <!-- Load Core Dependencies -->
    <script src="js/utils/ExportUtils.js"></script>
    
    <!-- Load Utilities and Chart -->
    <script src="js/utils/ChartUtils.js"></script>
    <script src="js/utils/ChartExports.js"></script>
    <script src="js/charts/sankey/SankeyChartConfig.js"></script>
    <script src="js/charts/sankey/SankeyChart.js"></script>

    <script>
        // Test data
        const testData = {
            "metadata": {
                "title": "Export Test Chart",
                "company": "Test Company",
                "period": "2024-Q1",
                "currency": "USD",
                "unit": "thousands"
            },
            "nodes": [
                {"id": "Revenue", "depth": 0, "value": 1000, "category": "revenue"},
                {"id": "Expenses", "depth": 1, "value": 600, "category": "expense"},
                {"id": "Profit", "depth": 2, "value": 400, "category": "profit"}
            ],
            "links": [
                {"source": "Revenue", "target": "Expenses", "value": 600},
                {"source": "Revenue", "target": "Profit", "value": 400}
            ]
        };

        let chart;

        try {
            // Test ChartExports availability
            if (typeof ChartExports === 'undefined') {
                throw new Error('ChartExports not loaded');
            }
            
            console.log('ChartExports available:', ChartExports);
            
            // Test chart creation with external export utilities
            chart = new PulseSankeyChart('test-chart');
            
            // Test rendering
            chart.render(testData).then(() => {
                // Check if chart rendered properly
                const svg = document.querySelector('#test-chart svg');
                const nodes = svg ? svg.querySelectorAll('.sankey-node') : [];
                const links = svg ? svg.querySelectorAll('.sankey-link') : [];
                
                if (svg && nodes.length > 0 && links.length > 0) {
                    document.getElementById('result').className = 'test-result pass';
                    document.getElementById('result').textContent = 
                        `✅ SUCCESS: ChartExports extraction works! Chart rendered with ${nodes.length} nodes and ${links.length} links. Export functions available.`;
                        
                    // Enable export buttons
                    const buttons = document.querySelectorAll('button');
                    buttons.forEach(btn => btn.disabled = false);
                } else {
                    throw new Error('Chart did not render properly');
                }
            }).catch(error => {
                document.getElementById('result').className = 'test-result fail';
                document.getElementById('result').textContent = `❌ RENDER FAILED: ${error.message}`;
            });
            
        } catch (error) {
            document.getElementById('result').className = 'test-result fail';
            document.getElementById('result').textContent = `❌ EXPORTS TEST FAILED: ${error.message}`;
        }

        function testGenerateFileName() {
            try {
                const filename = chart.generateFileName('png');
                console.log('Generated filename:', filename);
                
                // Test that filename has expected format: company_period_timestamp.extension
                if (filename.includes('TestCompany') && filename.includes('2024Q1') && filename.endsWith('.png')) {
                    document.getElementById('export-test').innerHTML += 
                        `<div class="export-demo">✅ Filename generation: ${filename}</div>`;
                } else {
                    throw new Error('Filename format incorrect: ' + filename);
                }
            } catch (error) {
                document.getElementById('export-test').innerHTML += 
                    `<div class="export-demo">❌ Filename generation failed: ${error.message}</div>`;
            }
        }

        function testPNGExport() {
            try {
                // Test that PNG export function exists and can be called
                if (typeof chart.exportToPNG !== 'function') {
                    throw new Error('exportToPNG function not available');
                }
                
                console.log('Testing PNG export (this will trigger a download)...');
                chart.exportToPNG();
                
                document.getElementById('export-test').innerHTML += 
                    `<div class="export-demo">✅ PNG export function works (download should have started)</div>`;
            } catch (error) {
                document.getElementById('export-test').innerHTML += 
                    `<div class="export-demo">❌ PNG export failed: ${error.message}</div>`;
            }
        }

        function testSVGExport() {
            try {
                // Test that SVG export function exists and can be called
                if (typeof chart.exportToSVG !== 'function') {
                    throw new Error('exportToSVG function not available');
                }
                
                console.log('Testing SVG export (this will trigger a download)...');
                chart.exportToSVG();
                
                document.getElementById('export-test').innerHTML += 
                    `<div class="export-demo">✅ SVG export function works (download should have started)</div>`;
            } catch (error) {
                document.getElementById('export-test').innerHTML += 
                    `<div class="export-demo">❌ SVG export failed: ${error.message}</div>`;
            }
        }

        function testCSVExport() {
            try {
                // Test that CSV export function exists and can be called
                if (typeof chart.exportDataToCSV !== 'function') {
                    throw new Error('exportDataToCSV function not available');
                }
                
                console.log('Testing CSV export (this will trigger a download)...');
                chart.exportDataToCSV(testData);
                
                document.getElementById('export-test').innerHTML += 
                    `<div class="export-demo">✅ CSV export function works (download should have started)</div>`;
            } catch (error) {
                document.getElementById('export-test').innerHTML += 
                    `<div class="export-demo">❌ CSV export failed: ${error.message}</div>`;
            }
        }
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Business Flow Designer - Pulse Analytics</title>
    
    <!-- Consolidated Application Styles -->
    <link rel="stylesheet" href="css/pulse-analytics.css">
    
    <style>
        /* Sticky Action Bar */
        .action-bar {
            position: sticky;
            top: 0;
            z-index: 100;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 16px 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }
        
        .action-bar-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .action-title {
            font-size: 18px;
            font-weight: 600;
            margin: 0;
        }
        
        .action-buttons {
            display: flex;
            gap: 12px;
            align-items: center;
        }
        
        .action-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .action-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-1px);
        }
        
        .action-btn.primary {
            background: #f59e0b;
            border-color: #f59e0b;
        }
        
        .action-btn.primary:hover {
            background: #d97706;
            border-color: #d97706;
        }

        /* Single Column Layout - Centered */
        .template-container {
            max-width: 1800px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
            width: 100%;
            display: flex;
            justify-content: center;
        }
        
        .template-main {
            width: 100%;
            max-width: 1600px;
            margin: 0 auto;
        }
        
        /* Statement Type Selector */
        .statement-type-selector {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            overflow: hidden;
            margin-bottom: 20px;
        }
        
        .statement-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #e1e5e9;
        }
        
        .statement-tab {
            flex: 1;
            padding: 16px 20px;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #6b7280;
            transition: all 0.2s ease;
            border-bottom: 3px solid transparent;
        }
        
        .statement-tab:hover {
            background: #e9ecef;
            color: #374151;
        }
        
        .statement-tab.active {
            background: white;
            color: #667eea;
            border-bottom-color: #667eea;
            font-weight: 600;
        }
        
        .statement-info {
            padding: 16px 20px;
            background: #f8f9fa;
            border-top: 1px solid #e1e5e9;
        }
        
        .statement-description {
            font-size: 13px;
            color: #6b7280;
            line-height: 1.4;
        }
        
        /* Collapsible Sections */
        .collapsible-section {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            overflow: hidden;
            margin-bottom: 20px;
        }
        
        .collapsible-header {
            background: #f8f9fa;
            padding: 16px 20px;
            border-bottom: 1px solid #e1e5e9;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.2s ease;
        }
        
        .collapsible-header:hover {
            background: #e9ecef;
        }
        
        .collapsible-header.collapsed {
            border-bottom: none;
        }
        
        .collapsible-title {
            font-size: 16px;
            font-weight: 600;
            color: #1f2937;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .collapsible-chevron {
            transition: transform 0.2s ease;
            color: #6b7280;
        }
        
        .collapsible-header.collapsed .collapsible-chevron {
            transform: rotate(-90deg);
        }
        
        .collapsible-content {
            transition: all 0.3s ease;
            overflow: hidden;
        }
        
        .collapsible-content.collapsed {
            height: 0 !important;
            padding: 0 !important;
        }
        
        /* Color Picker Section */
        .color-customization {
            padding: 20px;
        }
        
        .color-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }
        
        .color-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 6px;
            border: 1px solid #e1e5e9;
        }
        
        .color-picker {
            width: 40px;
            height: 40px;
            border: 2px solid #d1d5db;
            border-radius: 6px;
            cursor: pointer;
            background: none;
            padding: 0;
            transition: all 0.2s ease;
        }
        
        .color-picker:hover {
            border-color: #667eea;
            transform: scale(1.05);
        }
        
        .color-info {
            flex: 1;
        }
        
        .color-label {
            font-weight: 600;
            color: #374151;
            margin-bottom: 2px;
        }
        
        .color-description {
            font-size: 12px;
            color: #6b7280;
        }
        
        .color-presets {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid #e1e5e9;
        }
        
        .preset-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .preset-btn {
            background: #f8f9fa;
            border: 1px solid #d1d5db;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
        }
        
        .preset-btn:hover {
            background: #e5e7eb;
        }
        
        /* Flow Management */
        .flow-controls {
            display: flex;
            gap: 4px;
            align-items: center;
        }
        
        .flow-control-btn {
            background: #6b7280;
            color: white;
            border: none;
            width: 20px;
            height: 20px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        
        .flow-control-btn:hover {
            background: #4b5563;
            transform: scale(1.1);
        }
        
        .flow-control-btn.up:hover { background: #059669; }
        .flow-control-btn.down:hover { background: #dc2626; }
        .flow-control-btn.duplicate:hover { background: #0369a1; }
        .flow-control-btn.remove:hover { background: #dc2626; }
        
        /* Flow Table Styles */
        .flow-table-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            overflow: hidden;
            margin-bottom: 20px;
        }
        
        .flow-table-header {
            background: #f8f9fa;
            padding: 16px 20px;
            border-bottom: 1px solid #e1e5e9;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .flow-table-title {
            font-size: 16px;
            font-weight: 600;
            color: #1f2937;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .flow-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        
        .flow-table th {
            background: #f8f9fa;
            padding: 12px 8px;
            text-align: left;
            font-weight: 600;
            color: #374151;
            border-bottom: 2px solid #e1e5e9;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .flow-table td {
            padding: 8px;
            border-bottom: 1px solid #f1f3f4;
            vertical-align: middle;
        }
        
        .flow-table tr:hover {
            background: #f8f9fa;
        }
        
        .flow-input {
            width: 100%;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            padding: 6px 8px;
            font-size: 12px;
            background: white;
        }
        
        .flow-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
        }
        
        .flow-input.number {
            text-align: right;
        }
        
        .flow-select {
            width: 100%;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            padding: 6px 8px;
            font-size: 12px;
            background: white;
        }
        
        .add-flow-btn {
            background: #10b981;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .add-flow-btn:hover {
            background: #059669;
        }
        
        /* Balance Indicator */
        .balance-indicator {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
        }
        
        .balance-indicator.balanced {
            background: #d1fae5;
            color: #065f46;
        }
        
        .balance-indicator.unbalanced {
            background: #fee2e2;
            color: #991b1b;
        }
        
        /* Template Quick Actions */
        .template-actions {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
        }
        
        .template-btn {
            background: #f8f9fa;
            border: 1px solid #d1d5db;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
        }
        
        .template-btn:hover {
            background: #e5e7eb;
        }
        
        /* Stats Display */
        .stats-bar {
            background: #e7f3ff;
            border: 1px solid #0ea5e9;
            border-radius: 6px;
            padding: 12px 16px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
        }
        
        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }
        
        .stat-value {
            font-size: 16px;
            font-weight: 600;
            color: #0369a1;
        }
        
        .stat-label {
            color: #6b7280;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        /* Responsive adjustments */
        @media (max-width: 1200px) {
            .flow-table {
                font-size: 12px;
            }
            
            .flow-table th,
            .flow-table td {
                padding: 6px 4px;
            }
            
            .flow-input,
            .flow-select {
                font-size: 11px;
                padding: 4px 6px;
            }
        }
        
        @media (max-width: 768px) {
            .action-bar-content {
                flex-direction: column;
                gap: 12px;
            }
            
            .action-buttons {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .stats-bar {
                flex-direction: column;
                gap: 12px;
            }
            
            .color-grid {
                grid-template-columns: 1fr;
            }
            
            .statement-tabs {
                flex-direction: column;
            }
        }
    </style>
</head>
<body style="background: #f8f9fa;">
    <!-- Sticky Action Bar -->
    <div class="action-bar">
        <div class="action-bar-content">
            <div>
                <h1 class="action-title">üí∞ Business Flow Designer</h1>
                <div style="font-size: 12px; opacity: 0.8; margin-top: 2px;">
                    Build financial flows: Income Statement, Balance Sheet & Cash Flow
                </div>
            </div>
            <div class="action-buttons">
                <button class="action-btn" onclick="validateFlows()">‚úÖ Validate</button>
                <button class="action-btn" onclick="exportToCSV()">üìÑ Export</button>
                <button class="action-btn" onclick="importFromCSV()">üìÇ Import</button>
                <button class="action-btn primary" onclick="generateChart()">üöÄ Generate Chart</button>
            </div>
        </div>
    </div>

    <div class="template-container">
        <div class="template-main">
            <div class="template-content" style="padding: 20px;">
                <!-- Statement Type Selector -->
                <div class="statement-type-selector">
                    <div class="statement-tabs">
                        <button class="statement-tab active" data-type="income" onclick="switchStatementType('income')">
                            üìä Income Statement
                        </button>
                        <button class="statement-tab" data-type="balance" onclick="switchStatementType('balance')">
                            ‚öñÔ∏è Balance Sheet
                        </button>
                        <button class="statement-tab" data-type="cashflow" onclick="switchStatementType('cashflow')">
                            üí∏ Cash Flow
                        </button>
                    </div>
                    <div class="statement-info">
                        <div class="statement-description" id="statement-description">
                            Shows revenue flows through costs and expenses to arrive at net income. Ideal for understanding profitability and operational efficiency.
                        </div>
                    </div>
                </div>

                <!-- Quick Stats -->
                <div class="stats-bar">
                    <div class="stat-item">
                        <div class="stat-value" id="flow-count">0</div>
                        <div class="stat-label">Business Flows</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="node-count">0</div>
                        <div class="stat-label">Generated Nodes</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="layer-count">0</div>
                        <div class="stat-label">Layers</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="balance-score">0%</div>
                        <div class="stat-label">Balance Score</div>
                    </div>
                </div>

                <!-- Template Quick Actions -->
                <div class="template-actions">
                    <button class="template-btn" onclick="loadSimpleTemplate()">üìä Simple Template</button>
                    <button class="template-btn" onclick="loadBlankFlows()">üìÑ Blank Template</button>
                </div>

                <!-- Company Information Section -->
                <div class="collapsible-section">
                    <div class="collapsible-header" onclick="toggleSection('company')">
                        <h3 class="collapsible-title">üè¢ Company Information</h3>
                        <span class="collapsible-chevron">‚ñº</span>
                    </div>
                    <div class="collapsible-content" id="company-content">
                        <div style="padding: 20px;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                                <div>
                                    <label style="display: block; font-size: 12px; font-weight: 500; color: #374151; margin-bottom: 4px;">Company Name</label>
                                    <input type="text" class="flow-input" id="company-name" value="Your Company" onchange="updateMetadata()">
                                </div>
                                <div>
                                    <label style="display: block; font-size: 12px; font-weight: 500; color: #374151; margin-bottom: 4px;">Period</label>
                                    <input type="text" class="flow-input" id="period" value="Q3 2025" onchange="updateMetadata()">
                                </div>
                                <div>
                                    <label style="display: block; font-size: 12px; font-weight: 500; color: #374151; margin-bottom: 4px;">Currency</label>
                                    <select class="flow-select" id="currency" onchange="updateMetadata()">
                                        <option value="USD">USD ($)</option>
                                        <option value="EUR">EUR (‚Ç¨)</option>
                                        <option value="GBP">GBP (¬£)</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="display: block; font-size: 12px; font-weight: 500; color: #374151; margin-bottom: 4px;">Units</label>
                                    <select class="flow-select" id="units" onchange="updateMetadata()">
                                        <option value="millions">Millions</option>
                                        <option value="billions">Billions</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Color Customization Section -->
                <div class="collapsible-section">
                    <div class="collapsible-header" onclick="toggleSection('colors')">
                        <h3 class="collapsible-title">üé® Color Customization</h3>
                        <span class="collapsible-chevron">‚ñº</span>
                    </div>
                    <div class="collapsible-content" id="colors-content">
                        <div class="color-customization">
                            <div class="color-grid" id="color-grid">
                                <!-- Colors will be dynamically populated based on statement type -->
                            </div>
                            
                            <div class="color-presets">
                                <div style="font-weight: 600; margin-bottom: 8px; color: #374151;">Color Presets:</div>
                                <div class="preset-buttons">
                                    <button class="preset-btn" onclick="applyColorPreset('default')">Default</button>
                                    <button class="preset-btn" onclick="applyColorPreset('vibrant')">Vibrant</button>
                                    <button class="preset-btn" onclick="applyColorPreset('professional')">Professional</button>
                                    <button class="preset-btn" onclick="applyColorPreset('monochrome')">Monochrome</button>
                                    <button class="preset-btn" onclick="randomizeColors()">üé≤ Random</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Business Flows Section -->
                <div class="collapsible-section">
                    <div class="collapsible-header" onclick="toggleSection('flows')">
                        <h3 class="collapsible-title">
                            üí∞ Business Flows
                            <span style="background: #e7f3ff; color: #0369a1; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: 500;">Dynamic</span>
                        </h3>
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <button class="add-flow-btn" onclick="addFlow()">+ Add Flow</button>
                            <span class="collapsible-chevron">‚ñº</span>
                        </div>
                    </div>
                    <div class="collapsible-content" id="flows-content">
                        <div style="overflow-x: auto;">
                            <table class="flow-table">
                                <thead>
                                    <tr>
                                        <th style="width: 80px;">Actions</th>
                                        <th style="width: 240px;">From (Source)</th>
                                        <th style="width: 240px;">To (Target)</th>
                                        <th style="width: 100px;">Amount</th>
                                        <th style="width: 90px;">Src Layer</th>
                                        <th style="width: 90px;">Tgt Layer</th>
                                        <th style="width: 140px;">Flow Type</th>
                                        <th style="width: 140px;">Source Cat</th>
                                        <th style="width: 140px;">Target Cat</th>
                                        <th style="width: 300px;">Description</th>
                                        <th style="width: 60px;">‚úì</th>
                                    </tr>
                                </thead>
                                <tbody id="flows-tbody">
                                    <!-- Flows will be dynamically generated -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden file input -->
    <input type="file" id="csv-file-input" style="display: none;" accept=".csv,.json" onchange="handleFileImport(event)">

    <!-- Core Scripts -->
    <script src="js/utils/ExportUtils.js"></script>

    <script>
        // Global data structure
        let currentStatementType = 'income';
        let flowData = {
            metadata: {
                title: "Your Company Financial Flow",
                subtitle: "",  // REMOVED: No longer using subtitle
                currency: "USD",
                unit: "millions",
                company: "Your Company",
                period: "Q3 2025",
                statementType: "income",
                colorPalette: {}
            },
            flows: []
        };

        let flowIdCounter = 0;

        // Flow structure definition
        class BusinessFlow {
            constructor(options = {}) {
                this.id = options.id || `flow_${++flowIdCounter}`;
                this.source = options.source || '';
                this.target = options.target || '';
                this.value = options.value || 0;
                this.flowType = options.flowType || 'revenue_flow';
                this.sourceLayer = options.sourceLayer || 0;
                this.targetLayer = options.targetLayer || 1;
                this.sourceOrder = options.sourceOrder || 1;
                this.targetOrder = options.targetOrder || 1;
                this.sourceCategory = options.sourceCategory || 'revenue';
                this.targetCategory = options.targetCategory || 'revenue';
                this.description = options.description || '';
            }
        }

        // Statement Type Configuration
        const statementConfigs = {
            income: {
                title: "Income Statement",
                description: "Shows revenue flows through costs and expenses to arrive at net income. Ideal for understanding profitability and operational efficiency.",
                colorCategories: {
                    revenue: { label: "Revenue", description: "Revenue nodes and flows", default: "#3498db" },
                    cost: { label: "Cost", description: "Cost of revenue nodes", default: "#e74c3c" },
                    profit: { label: "Profit", description: "Profit nodes and flows", default: "#27ae60" },
                    expense: { label: "Expense & Tax", description: "Operating expenses and tax nodes", default: "#e67e22" },
                    income: { label: "Income", description: "Final income nodes", default: "#9b59b6" }
                }
            },
            balance: {
                title: "Balance Sheet",
                description: "Shows how assets are financed by liabilities and equity. Visualizes the fundamental accounting equation: Assets = Liabilities + Equity.",
                colorCategories: {
                    asset: { label: "Assets", description: "Current and non-current assets", default: "#3498db" },
                    liability: { label: "Liabilities", description: "Current and long-term liabilities", default: "#e74c3c" },
                    equity: { label: "Equity", description: "Shareholders' equity components", default: "#27ae60" },
                    current: { label: "Current Items", description: "Short-term assets and liabilities", default: "#f39c12" },
                    noncurrent: { label: "Non-Current Items", description: "Long-term assets and liabilities", default: "#9b59b6" }
                }
            },
            cashflow: {
                title: "Cash Flow Statement",
                description: "Tracks cash movements from operating, investing, and financing activities. Shows how cash is generated and used across business activities.",
                colorCategories: {
                    operating: { label: "Operating", description: "Cash from core business operations", default: "#3498db" },
                    investing: { label: "Investing", description: "Cash from investment activities", default: "#e74c3c" },
                    financing: { label: "Financing", description: "Cash from financing activities", default: "#27ae60" },
                    inflow: { label: "Cash Inflow", description: "Sources of cash", default: "#2ecc71" },
                    outflow: { label: "Cash Outflow", description: "Uses of cash", default: "#e67e22" }
                }
            }
        };

        // Statement Type Management
        function switchStatementType(type) {
            if (type === currentStatementType) return;
            
            console.log(`üîÑ Switching statement type from ${currentStatementType} to ${type}`);
            
            // Update active tab
            document.querySelectorAll('.statement-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-type="${type}"]`).classList.add('active');
            
            // Update description
            const config = statementConfigs[type];
            document.getElementById('statement-description').textContent = config.description;
            
            // Update current type
            currentStatementType = type;
            flowData.metadata.statementType = type;
            flowData.metadata.title = `${flowData.metadata.company} ${config.title}`;
            
            // Update color palette
            updateColorPalette();
            
            // Load appropriate template if income statement, otherwise show blank
            if (type === 'income') {
                loadSimpleTemplate();
            } else {
                loadBlankFlows();
            }
        }

        function updateColorPalette() {
            const config = statementConfigs[currentStatementType];
            const colorGrid = document.getElementById('color-grid');
            
            // Clear existing colors
            colorGrid.innerHTML = '';
            
            // Reset color palette
            flowData.metadata.colorPalette = {};
            
            // Add colors for current statement type
            Object.entries(config.colorCategories).forEach(([category, info]) => {
                flowData.metadata.colorPalette[category] = info.default;
                
                const colorItem = document.createElement('div');
                colorItem.className = 'color-item';
                colorItem.innerHTML = `
                    <input type="color" class="color-picker" id="${category}-color" value="${info.default}" onchange="updateColor('${category}', this.value)">
                    <div class="color-info">
                        <div class="color-label">${info.label}</div>
                        <div class="color-description">${info.description}</div>
                    </div>
                `;
                colorGrid.appendChild(colorItem);
            });
        }

        // Color Management Functions
        function updateColor(category, color) {
            flowData.metadata.colorPalette[category] = color;
            console.log(`üé® Updated ${category} color to ${color}`);
        }

        function applyColorPreset(presetName) {
            const config = statementConfigs[currentStatementType];
            const categories = Object.keys(config.colorCategories);
            
            const presets = {
                default: (categories) => {
                    const defaultColors = {};
                    categories.forEach(cat => {
                        defaultColors[cat] = config.colorCategories[cat].default;
                    });
                    return defaultColors;
                },
                vibrant: (categories) => {
                    const vibrantColors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#f9ca24', '#6c5ce7'];
                    const colors = {};
                    categories.forEach((cat, index) => {
                        colors[cat] = vibrantColors[index % vibrantColors.length];
                    });
                    return colors;
                },
                professional: (categories) => {
                    const professionalColors = ['#2c3e50', '#95a5a6', '#27ae60', '#e67e22', '#3498db'];
                    const colors = {};
                    categories.forEach((cat, index) => {
                        colors[cat] = professionalColors[index % professionalColors.length];
                    });
                    return colors;
                },
                monochrome: (categories) => {
                    const monochromeColors = ['#2c3e50', '#7f8c8d', '#34495e', '#95a5a6', '#2c3e50'];
                    const colors = {};
                    categories.forEach((cat, index) => {
                        colors[cat] = monochromeColors[index % monochromeColors.length];
                    });
                    return colors;
                }
            };

            const preset = presets[presetName];
            if (preset) {
                const colors = preset(categories);
                
                // Apply colors to data
                Object.entries(colors).forEach(([category, color]) => {
                    flowData.metadata.colorPalette[category] = color;
                });
                
                // Update UI
                Object.entries(colors).forEach(([category, color]) => {
                    const picker = document.getElementById(`${category}-color`);
                    if (picker) {
                        picker.value = color;
                    }
                });
                
                console.log(`üé® Applied ${presetName} color preset for ${currentStatementType}`);
            }
        }

        function randomizeColors() {
            const config = statementConfigs[currentStatementType];
            const categories = Object.keys(config.colorCategories);
            
            categories.forEach(category => {
                const randomColor = '#' + Math.floor(Math.random()*16777215).toString(16).padStart(6, '0');
                flowData.metadata.colorPalette[category] = randomColor;
                
                const picker = document.getElementById(`${category}-color`);
                if (picker) {
                    picker.value = randomColor;
                }
            });
            
            console.log('üé≤ Randomized all colors');
        }

        // Collapsible Section Management
        function toggleSection(sectionName) {
            const header = document.querySelector(`[onclick="toggleSection('${sectionName}')"]`);
            const content = document.getElementById(`${sectionName}-content`);
            
            if (content.classList.contains('collapsed')) {
                content.classList.remove('collapsed');
                content.style.height = 'auto';
                header.classList.remove('collapsed');
            } else {
                content.style.height = content.scrollHeight + 'px';
                setTimeout(() => {
                    content.classList.add('collapsed');
                    header.classList.add('collapsed');
                }, 10);
            }
        }

        // SIMPLIFIED TEMPLATES - Only basic income statement example, no hardcoded data for other types
        function loadSimpleTemplate() {
            if (currentStatementType === 'income') {
                flowData.metadata.company = "Your Company";
                flowData.metadata.title = "Your Company Income Statement";
                
                // Simple income statement structure - users can modify amounts
                flowData.flows = [
                    new BusinessFlow({
                        source: "Product Sales",
                        target: "Total Revenue",
                        value: 1000,
                        flowType: "revenue_flow",
                        sourceLayer: 0,
                        targetLayer: 1,
                        sourceCategory: "revenue",
                        targetCategory: "revenue",
                        description: "Revenue from product sales"
                    }),
                    new BusinessFlow({
                        source: "Service Revenue",
                        target: "Total Revenue",
                        value: 500,
                        flowType: "revenue_flow",
                        sourceLayer: 0,
                        targetLayer: 1,
                        sourceCategory: "revenue",
                        targetCategory: "revenue",
                        description: "Revenue from services"
                    }),
                    new BusinessFlow({
                        source: "Total Revenue",
                        target: "Gross Profit",
                        value: 1200,
                        flowType: "profit_flow",
                        sourceLayer: 1,
                        targetLayer: 2,
                        sourceCategory: "revenue",
                        targetCategory: "profit",
                        description: "Revenue after cost of revenue"
                    }),
                    new BusinessFlow({
                        source: "Total Revenue",
                        target: "Cost of Revenue",
                        value: 300,
                        flowType: "cost_flow",
                        sourceLayer: 1,
                        targetLayer: 2,
                        sourceCategory: "revenue",
                        targetCategory: "cost",
                        description: "Direct costs to deliver services"
                    }),
                    new BusinessFlow({
                        source: "Gross Profit",
                        target: "Operating Profit",
                        value: 400,
                        flowType: "profit_flow",
                        sourceLayer: 2,
                        targetLayer: 3,
                        sourceCategory: "profit",
                        targetCategory: "profit",
                        description: "Profit from core operations"
                    }),
                    new BusinessFlow({
                        source: "Gross Profit",
                        target: "Operating Expenses",
                        value: 800,
                        flowType: "expense_flow",
                        sourceLayer: 2,
                        targetLayer: 3,
                        sourceCategory: "profit",
                        targetCategory: "expense",
                        description: "Total operating expenses"
                    }),
                    new BusinessFlow({
                        source: "Operating Expenses",
                        target: "Sales & Marketing",
                        value: 400,
                        flowType: "expense_flow",
                        sourceLayer: 3,
                        targetLayer: 4,
                        sourceCategory: "expense",
                        targetCategory: "expense",
                        description: "Customer acquisition costs"
                    }),
                    new BusinessFlow({
                        source: "Operating Expenses",
                        target: "R&D",
                        value: 250,
                        flowType: "expense_flow",
                        sourceLayer: 3,
                        targetLayer: 4,
                        sourceCategory: "expense",
                        targetCategory: "expense",
                        description: "Research and development"
                    }),
                    new BusinessFlow({
                        source: "Operating Expenses",
                        target: "General & Admin",
                        value: 150,
                        flowType: "expense_flow",
                        sourceLayer: 3,
                        targetLayer: 4,
                        sourceCategory: "expense",
                        targetCategory: "expense",
                        description: "Administrative costs"
                    }),
                    new BusinessFlow({
                        source: "Operating Profit",
                        target: "Net Income",
                        value: 300,
                        flowType: "final_flow",
                        sourceLayer: 3,
                        targetLayer: 4,
                        sourceCategory: "profit",
                        targetCategory: "income",
                        description: "Final net income"
                    }),
                    new BusinessFlow({
                        source: "Operating Profit",
                        target: "Tax Expense",
                        value: 100,
                        flowType: "expense_flow",
                        sourceLayer: 3,
                        targetLayer: 4,
                        sourceCategory: "profit",
                        targetCategory: "expense",
                        description: "Corporate income tax"
                    })
                ];
                
                document.getElementById('company-name').value = flowData.metadata.company;
                renderFlowTable();
                updateAllStats();
            } else {
                // For non-income statements, show basic structure
                loadBlankFlows();
            }
        }

        function loadBlankFlows() {
            if (confirm('This will clear all current flows. Continue?')) {
                const startingFlows = {
                    income: () => [
                        new BusinessFlow({
                            source: "Revenue Source",
                            target: "Total Revenue",
                            value: 100,
                            description: "Start building your income statement here"
                        })
                    ],
                    balance: () => [
                        new BusinessFlow({
                            source: "Asset Item",
                            target: "Total Assets",
                            value: 100,
                            sourceCategory: "asset",
                            targetCategory: "asset",
                            description: "Start building your balance sheet here"
                        })
                    ],
                    cashflow: () => [
                        new BusinessFlow({
                            source: "Cash Source",
                            target: "Operating Cash Flow",
                            value: 100,
                            sourceCategory: "inflow",
                            targetCategory: "operating",
                            description: "Start building your cash flow statement here"
                        })
                    ]
                };
                
                flowData.flows = startingFlows[currentStatementType]();
                renderFlowTable();
                updateAllStats();
            }
        }

        function renderFlowTable() {
            const tbody = document.getElementById('flows-tbody');
            tbody.innerHTML = '';
            
            if (flowData.flows.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="11" style="text-align: center; padding: 40px; color: #6b7280;">
                            <div style="font-size: 16px; margin-bottom: 8px;">üí°</div>
                            <div>No flows defined. Click "Add Flow" to start building your financial structure.</div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            flowData.flows.forEach((flow, index) => {
                const row = createFlowRow(flow, index);
                tbody.appendChild(row);
            });
        }

        function createFlowRow(flow, index) {
            const config = statementConfigs[currentStatementType];
            const categories = Object.keys(config.colorCategories);
            
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>
                    <div class="flow-controls">
                        <button class="flow-control-btn up" onclick="moveFlowUp(${index})" title="Move Up" ${index === 0 ? 'disabled' : ''}>‚Üë</button>
                        <button class="flow-control-btn down" onclick="moveFlowDown(${index})" title="Move Down" ${index === flowData.flows.length - 1 ? 'disabled' : ''}>‚Üì</button>
                        <button class="flow-control-btn duplicate" onclick="duplicateFlow(${index})" title="Duplicate">‚ßâ</button>
                        <button class="flow-control-btn remove" onclick="removeFlow(${index})" title="Remove">√ó</button>
                    </div>
                </td>
                <td>
                    <input type="text" class="flow-input" value="${flow.source}" 
                           onchange="updateFlow(${index}, 'source', this.value)">
                </td>
                <td>
                    <input type="text" class="flow-input" value="${flow.target}" 
                           onchange="updateFlow(${index}, 'target', this.value)">
                </td>
                <td>
                    <input type="number" class="flow-input number" value="${flow.value}" 
                           onchange="updateFlow(${index}, 'value', parseFloat(this.value) || 0)">
                </td>
                <td>
                    <input type="number" class="flow-input number" value="${flow.sourceLayer}" min="0" max="20"
                           onchange="updateFlow(${index}, 'sourceLayer', parseInt(this.value) || 0)">
                </td>
                <td>
                    <input type="number" class="flow-input number" value="${flow.targetLayer}" min="0" max="20"
                           onchange="updateFlow(${index}, 'targetLayer', parseInt(this.value) || 0)">
                </td>
                <td>
                    <select class="flow-select" onchange="updateFlow(${index}, 'flowType', this.value)">
                        ${getFlowTypeOptions(flow.flowType)}
                    </select>
                </td>
                <td>
                    <select class="flow-select" onchange="updateFlow(${index}, 'sourceCategory', this.value)">
                        ${getCategoryOptions(categories, flow.sourceCategory)}
                    </select>
                </td>
                <td>
                    <select class="flow-select" onchange="updateFlow(${index}, 'targetCategory', this.value)">
                        ${getCategoryOptions(categories, flow.targetCategory)}
                    </select>
                </td>
                <td>
                    <input type="text" class="flow-input" value="${flow.description}" 
                           onchange="updateFlow(${index}, 'description', this.value)"
                           placeholder="Flow description">
                </td>
                <td>
                    ${getFlowBalanceIndicator(flow)}
                </td>
            `;
            return tr;
        }

        function getFlowTypeOptions(selected) {
            const options = [
                { value: 'revenue_flow', label: 'Revenue' },
                { value: 'cost_flow', label: 'Cost' },
                { value: 'profit_flow', label: 'Profit' },
                { value: 'expense_flow', label: 'Expense' },
                { value: 'asset_flow', label: 'Asset' },
                { value: 'liability_flow', label: 'Liability' },
                { value: 'equity_flow', label: 'Equity' },
                { value: 'operating_flow', label: 'Operating' },
                { value: 'investing_flow', label: 'Investing' },
                { value: 'financing_flow', label: 'Financing' },
                { value: 'cash_flow', label: 'Cash' },
                { value: 'final_flow', label: 'Final' }
            ];
            
            return options.map(opt => 
                `<option value="${opt.value}" ${opt.value === selected ? 'selected' : ''}>${opt.label}</option>`
            ).join('');
        }

        function getCategoryOptions(categories, selected) {
            return categories.map(cat => 
                `<option value="${cat}" ${cat === selected ? 'selected' : ''}>${cat}</option>`
            ).join('');
        }

        function getFlowBalanceIndicator(flow) {
            const isValid = flow.source && flow.target && flow.value !== 0 && flow.sourceLayer < flow.targetLayer;
            return `<div class="balance-indicator ${isValid ? 'balanced' : 'unbalanced'}">${isValid ? '‚úì' : '‚ö†'}</div>`;
        }

        // Flow Management Functions
        function addFlow() {
            const defaultCategories = {
                income: { source: 'revenue', target: 'revenue' },
                balance: { source: 'asset', target: 'asset' },
                cashflow: { source: 'inflow', target: 'operating' }
            };
            
            const defaults = defaultCategories[currentStatementType];
            
            const newFlow = new BusinessFlow({
                source: "New Source",
                target: "New Target",
                value: 100,
                sourceLayer: 0,
                targetLayer: 1,
                sourceCategory: defaults.source,
                targetCategory: defaults.target
            });
            
            flowData.flows.push(newFlow);
            renderFlowTable();
            updateAllStats();
        }

        function removeFlow(index) {
            flowData.flows.splice(index, 1);
            renderFlowTable();
            updateAllStats();
        }

        function moveFlowUp(index) {
            if (index > 0) {
                [flowData.flows[index], flowData.flows[index - 1]] = [flowData.flows[index - 1], flowData.flows[index]];
                renderFlowTable();
                updateAllStats();
            }
        }

        function moveFlowDown(index) {
            if (index < flowData.flows.length - 1) {
                [flowData.flows[index], flowData.flows[index + 1]] = [flowData.flows[index + 1], flowData.flows[index]];
                renderFlowTable();
                updateAllStats();
            }
        }

        function duplicateFlow(index) {
            const originalFlow = flowData.flows[index];
            const duplicatedFlow = new BusinessFlow({
                source: originalFlow.source + " Copy",
                target: originalFlow.target,
                value: originalFlow.value,
                flowType: originalFlow.flowType,
                sourceLayer: originalFlow.sourceLayer,
                targetLayer: originalFlow.targetLayer,
                sourceCategory: originalFlow.sourceCategory,
                targetCategory: originalFlow.targetCategory,
                description: originalFlow.description + " (Copy)"
            });
            
            flowData.flows.splice(index + 1, 0, duplicatedFlow);
            renderFlowTable();
            updateAllStats();
        }

        function updateFlow(index, field, value) {
            if (flowData.flows[index]) {
                flowData.flows[index][field] = value;
                updateAllStats();
                
                const row = document.querySelectorAll('#flows-tbody tr')[index];
                if (row) {
                    const balanceCell = row.lastElementChild;
                    balanceCell.innerHTML = getFlowBalanceIndicator(flowData.flows[index]);
                }
            }
        }

        function updateMetadata() {
            flowData.metadata.company = document.getElementById('company-name').value;
            flowData.metadata.period = document.getElementById('period').value;
            flowData.metadata.currency = document.getElementById('currency').value;
            flowData.metadata.unit = document.getElementById('units').value;
            
            const config = statementConfigs[currentStatementType];
            flowData.metadata.title = `${flowData.metadata.company} ${config.title}`;
        }

        function generateNodesAndLinksFromFlows() {
            const nodeMap = new Map();
            const links = [];
            
            flowData.flows.forEach(flow => {
                if (!nodeMap.has(flow.source)) {
                    nodeMap.set(flow.source, {
                        id: flow.source,
                        depth: flow.sourceLayer,
                        value: 0,
                        category: flow.sourceCategory,
                        description: `Source: ${flow.description}`,
                        sort_order: flow.sourceOrder || 1
                    });
                }
                
                if (!nodeMap.has(flow.target)) {
                    nodeMap.set(flow.target, {
                        id: flow.target,
                        depth: flow.targetLayer,
                        value: 0,
                        category: flow.targetCategory,
                        description: `Target: ${flow.description}`,
                        sort_order: flow.targetOrder || 1
                    });
                }
                
                const targetNode = nodeMap.get(flow.target);
                targetNode.value += Math.abs(flow.value);
                
                links.push({
                    source: flow.source,
                    target: flow.target,
                    value: Math.abs(flow.value),
                    type: flow.flowType,
                    description: flow.description,
                    colorCategory: flow.targetCategory
                });
            });
            
            flowData.flows.forEach(flow => {
                const sourceNode = nodeMap.get(flow.source);
                if (sourceNode.value === 0) {
                    const outflows = flowData.flows.filter(f => f.source === flow.source);
                    sourceNode.value = outflows.reduce((sum, f) => sum + Math.abs(f.value), 0);
                }
            });
            
            return {
                metadata: {
                    ...flowData.metadata
                },
                nodes: Array.from(nodeMap.values()),
                links: links
            };
        }

        function updateAllStats() {
            const nodeMap = new Map();
            
            flowData.flows.forEach(flow => {
                nodeMap.set(flow.source, flow.sourceLayer);
                nodeMap.set(flow.target, flow.targetLayer);
            });
            
            const flowCount = flowData.flows.length;
            const nodeCount = nodeMap.size;
            const layerCount = new Set(Array.from(nodeMap.values())).size;
            
            let balancedFlows = 0;
            flowData.flows.forEach(flow => {
                const isValid = flow.source && flow.target && flow.value !== 0 && flow.sourceLayer < flow.targetLayer;
                if (isValid) balancedFlows++;
            });
            
            const balanceScore = flowCount > 0 ? Math.round((balancedFlows / flowCount) * 100) : 0;
            
            document.getElementById('flow-count').textContent = flowCount;
            document.getElementById('node-count').textContent = nodeCount;
            document.getElementById('layer-count').textContent = layerCount;
            document.getElementById('balance-score').textContent = balanceScore + '%';
        }

        function validateFlows() {
            const errors = [];
            const warnings = [];
            
            if (flowData.flows.length === 0) {
                errors.push('No flows defined');
            }
            
            flowData.flows.forEach((flow, index) => {
                if (!flow.source || !flow.target) {
                    errors.push(`Flow ${index + 1}: Missing source or target`);
                }
                
                if (flow.value === 0) {
                    warnings.push(`Flow ${index + 1}: Zero value flow`);
                }
                
                if (flow.sourceLayer >= flow.targetLayer) {
                    errors.push(`Flow ${index + 1}: Source layer (${flow.sourceLayer}) must be less than target layer (${flow.targetLayer})`);
                }
                
                if (flow.source === flow.target) {
                    errors.push(`Flow ${index + 1}: Source and target cannot be the same`);
                }
            });
            
            let message = `‚úÖ ${statementConfigs[currentStatementType].title} Validation Results\n\n`;
            
            if (errors.length > 0) {
                message += '‚ùå Errors:\n' + errors.map(e => `‚Ä¢ ${e}`).join('\n') + '\n\n';
            }
            
            if (warnings.length > 0) {
                message += '‚ö†Ô∏è Warnings:\n' + warnings.map(w => `‚Ä¢ ${w}`).join('\n') + '\n\n';
            }
            
            if (errors.length === 0 && warnings.length === 0) {
                message += 'Perfect! All flows are valid.\n\n';
            }
            
            const balanceScore = document.getElementById('balance-score').textContent;
            message += `üìä Summary:\n‚Ä¢ ${flowData.flows.length} flows\n‚Ä¢ Statement Type: ${currentStatementType}\n‚Ä¢ Balance Score: ${balanceScore}`;
            
            alert(message);
        }

        // UPDATED: Export functions using ExportUtils.js
        function exportToCSV() {
            if (!window.ExportUtils) {
                console.error('ExportUtils not loaded');
                alert('Export functionality not available. Please refresh the page.');
                return;
            }
            
            window.ExportUtils.exportFinancialFlowsToCSV(flowData);
        }

        function exportToJSON() {
            if (!window.ExportUtils) {
                console.error('ExportUtils not loaded');
                alert('Export functionality not available. Please refresh the page.');
                return;
            }
            
            window.ExportUtils.exportFinancialFlowsToJSON(flowData);
        }

        function importFromCSV() {
            document.getElementById('csv-file-input').click();
        }

        function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                const content = e.target.result;
                
                if (file.name.endsWith('.json')) {
                    try {
                        const data = JSON.parse(content);
                        if (data.flows) {
                            flowData = data;
                            if (data.metadata && data.metadata.statementType) {
                                switchStatementType(data.metadata.statementType);
                            }
                        } else if (data.nodes && data.links) {
                            // Convert from nodes/links to flows format (simplified)
                            alert('‚ö†Ô∏è Please use the Flow Builder format for imports. Nodes/links format not supported here.');
                            return;
                        }
                        renderFlowTable();
                        updateAllStats();
                        alert('‚úÖ Successfully imported flows!');
                    } catch (error) {
                        alert('‚ùå Error parsing JSON: ' + error.message);
                    }
                } else if (file.name.endsWith('.csv')) {
                    parseCSVFlows(content);
                }
            };
            reader.readAsText(file);
        }

        function parseCSVFlows(csvContent) {
            const lines = csvContent.split('\n').filter(line => line.trim() && !line.startsWith('#'));
            if (lines.length < 2) {
                alert('‚ùå CSV file must have header and at least one data row');
                return;
            }
            
            const flows = [];
            let detectedStatementType = null;
            
            for (let i = 1; i < lines.length; i++) {
                const values = parseCSVLine(lines[i]);
                if (values.length >= 10) {
                    if (!detectedStatementType && values[0]) {
                        detectedStatementType = values[0];
                    }
                    
                    flows.push(new BusinessFlow({
                        source: values[1],
                        target: values[2],
                        value: parseFloat(values[3]) || 0,
                        flowType: values[4] || 'revenue_flow',
                        sourceLayer: parseInt(values[5]) || 0,
                        targetLayer: parseInt(values[6]) || 1,
                        sourceCategory: values[7] || 'revenue',
                        targetCategory: values[8] || 'revenue',
                        description: values[9] || ''
                    }));
                }
            }
            
            if (flows.length > 0) {
                if (detectedStatementType && detectedStatementType !== currentStatementType) {
                    switchStatementType(detectedStatementType);
                }
                
                flowData.flows = flows;
                renderFlowTable();
                updateAllStats();
                alert(`‚úÖ Successfully imported ${flows.length} flows from CSV!`);
            } else {
                alert('‚ùå No valid flows found in CSV file');
            }
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current.trim());
            return result.map(field => field.replace(/^"|"$/g, ''));
        }

        function generateChart() {
            const sankeyData = generateNodesAndLinksFromFlows();
            
            if (sankeyData.nodes.length === 0) {
                alert('‚ùå No nodes generated. Please add flows first.');
                return;
            }
            
            const urlParams = new URLSearchParams(window.location.search);
            const chartType = urlParams.get('chartType') || 'sankey';
            const returnTo = urlParams.get('returnTo');
            
            if (returnTo === 'guided') {
                const dataString = encodeURIComponent(JSON.stringify(sankeyData));
                window.location.href = `guided.html?step=3&chartType=${chartType}&data=${dataString}&dataInput=template`;
            } else {
                const dataString = encodeURIComponent(JSON.stringify(sankeyData));
                window.location.href = `chart.html?chartType=${chartType}&data=${dataString}`;
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            switchStatementType('income');
            loadSimpleTemplate();
        });
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Business Flow Designer - Pulse Analytics</title>
    
    <!-- Consolidated Application Styles -->
    <link rel="stylesheet" href="css/pulse-analytics.css">
    
    <!-- D3.js Library -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-sankey/0.12.3/d3-sankey.min.js"></script>
    
    <!-- Sankey Chart Component -->
    <script src="js/charts/sankey/SankeyChart.js"></script>
</head>
<body style="background: #f8f9fa;">
    <!-- Sticky Action Bar -->
    <div class="action-bar">
        <div class="action-bar-content">
            <div>
                <h1 class="action-title">üí∞ Business Flow Designer</h1>
                <div style="font-size: 12px; opacity: 0.8; margin-top: 2px;">
                    Build financial flows: Income Statement & Balance Sheet with period comparison
                </div>
            </div>
            <div class="action-buttons">
                <button class="action-btn" onclick="validateFlows()">‚úÖ Validate</button>
                <button class="action-btn" onclick="exportToCSV()">üìÑ Export</button>
                <button class="action-btn" onclick="importFromCSV()">üìÇ Import</button>
                <button class="action-btn primary" onclick="generateChart()">üöÄ Generate Chart</button>
            </div>
        </div>
    </div>

    <div class="template-container">
        <div class="template-main">
            <div class="template-content" style="padding: 20px;">
                <!-- Statement Type Selector -->
                <div class="statement-type-selector">
                    <div class="statement-tabs">
                        <button class="statement-tab active" data-type="income" onclick="switchStatementType('income')">
                            üìä Income Statement
                        </button>
                        <button class="statement-tab" data-type="balance" onclick="switchStatementType('balance')">
                            ‚öñÔ∏è Balance Sheet
                        </button>
                    </div>
                    <div class="statement-info">
                        <div class="statement-description" id="statement-description">
                            Shows revenue flows through costs and expenses to arrive at net income. Ideal for understanding profitability and operational efficiency.
                        </div>
                    </div>
                </div>

                <!-- Comparison Mode Toggle -->
                <div class="comparison-toggle">
                    <div class="comparison-toggle-content">
                        <input type="checkbox" class="comparison-checkbox" id="comparison-mode" onchange="toggleComparisonMode()">
                        <div>
                            <div class="comparison-label">üìà Period-over-Period Comparison</div>
                            <div class="comparison-description">Compare current period vs. previous period values</div>
                        </div>
                    </div>
                    <div style="font-size: 11px; color: #6b7280;">
                        Shows variance % and trends on chart nodes
                    </div>
                </div>

                <!-- Quick Stats -->
                <div class="stats-bar">
                    <div class="stat-item">
                        <div class="stat-value" id="flow-count">0</div>
                        <div class="stat-label">Business Flows</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="node-count">0</div>
                        <div class="stat-label">Generated Nodes</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="layer-count">0</div>
                        <div class="stat-label">Layers</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="balance-score">0%</div>
                        <div class="stat-label">Balance Score</div>
                    </div>
                    <div class="stat-item" id="comparison-stats" style="display: none;">
                        <div class="stat-value" id="avg-growth">0%</div>
                        <div class="stat-label">Avg Growth</div>
                    </div>
                </div>

                <!-- Template Quick Actions -->
                <div class="template-actions">
                    <button class="template-btn" onclick="loadSimpleTemplate()">üìä Simple Template</button>
                    <button class="template-btn" onclick="loadBlankFlows()">üìÑ Blank Template</button>
                </div>

                <!-- Company Information Section -->
                <div class="collapsible-section">
                    <div class="collapsible-header" onclick="toggleSection('company')">
                        <h3 class="collapsible-title">üè¢ Company Information</h3>
                        <span class="collapsible-chevron">‚ñº</span>
                    </div>
                    <div class="collapsible-content" id="company-content">
                        <div class="period-section">
                            <div class="period-header">üìÖ Current Period</div>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                                <div>
                                    <label style="display: block; font-size: 12px; font-weight: 500; color: #374151; margin-bottom: 4px;">Company Name</label>
                                    <input type="text" class="flow-input" id="company-name" value="Your Company" onchange="updateMetadata()">
                                </div>
                                <div>
                                    <label style="display: block; font-size: 12px; font-weight: 500; color: #374151; margin-bottom: 4px;">Current Period</label>
                                    <input type="text" class="flow-input" id="period" value="Q3 2025" onchange="updateMetadata()">
                                </div>
                                <div>
                                    <label style="display: block; font-size: 12px; font-weight: 500; color: #374151; margin-bottom: 4px;">Currency</label>
                                    <select class="flow-select" id="currency" onchange="updateMetadata()">
                                        <option value="USD">USD ($)</option>
                                        <option value="EUR">EUR (‚Ç¨)</option>
                                        <option value="GBP">GBP (¬£)</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="display: block; font-size: 12px; font-weight: 500; color: #374151; margin-bottom: 4px;">Units</label>
                                    <select class="flow-select" id="units" onchange="updateMetadata()">
                                        <option value="millions">Millions</option>
                                        <option value="billions">Billions</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="period-section" id="previous-period-section" style="display: none;">
                            <div class="period-header">üìä Previous Period (for Comparison)</div>
                            <div class="period-description">
                                Enter previous period information to enable period-over-period comparison on the chart
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                                <div>
                                    <label style="display: block; font-size: 12px; font-weight: 500; color: #374151; margin-bottom: 4px;">Previous Period</label>
                                    <input type="text" class="flow-input" id="previous-period" value="Q2 2025" onchange="updateMetadata()">
                                </div>
                                <div>
                                    <label style="display: block; font-size: 12px; font-weight: 500; color: #374151; margin-bottom: 4px;">Data Source</label>
                                    <select class="flow-select" id="comparison-source" onchange="updateMetadata()">
                                        <option value="manual">Manual Entry</option>
                                        <option value="import">Imported Data</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Color Customization Section -->
                <div class="collapsible-section">
                    <div class="collapsible-header" onclick="toggleSection('colors')">
                        <h3 class="collapsible-title">üé® Color Customization</h3>
                        <span class="collapsible-chevron">‚ñº</span>
                    </div>
                    <div class="collapsible-content" id="colors-content">
                        <div class="color-customization">
                            <div class="color-grid" id="color-grid">
                                <!-- Colors will be dynamically populated based on statement type -->
                            </div>
                            
                            <div class="color-presets">
                                <div style="font-weight: 600; margin-bottom: 8px; color: #374151;">Color Presets:</div>
                                <div class="preset-buttons">
                                    <button class="preset-btn" onclick="applyColorPreset('default')">Default</button>
                                    <button class="preset-btn" onclick="applyColorPreset('vibrant')">Vibrant</button>
                                    <button class="preset-btn" onclick="applyColorPreset('professional')">Professional</button>
                                    <button class="preset-btn" onclick="applyColorPreset('monochrome')">Monochrome</button>
                                    <button class="preset-btn" onclick="randomizeColors()">üé≤ Random</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Business Flows Section -->
                <div class="collapsible-section">
                    <div class="collapsible-header" onclick="toggleSection('flows')">
                        <h3 class="collapsible-title">
                            üí∞ Business Flows
                            <span style="background: #e7f3ff; color: #0369a1; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: 500;">Dynamic</span>
                        </h3>
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <button class="add-flow-btn" onclick="addFlow()">+ Add Flow</button>
                            <span class="collapsible-chevron">‚ñº</span>
                        </div>
                    </div>
                    <div class="collapsible-content" id="flows-content">
                        <div style="overflow-x: auto;">
                            <table class="flow-table">
                                <thead>
                                    <tr>
                                        <th style="width: 80px;">Actions</th>
                                        <th style="width: 200px;">From (Source)</th>
                                        <th style="width: 200px;">To (Target)</th>
                                        <th style="width: 100px;">Current Value</th>
                                        <th style="width: 100px;" id="previous-value-header">Previous Value</th>
                                        <th style="width: 80px;" id="variance-header">Variance</th>
                                        <th style="width: 90px;">Src Layer</th>
                                        <th style="width: 90px;">Tgt Layer</th>
                                        <th style="width: 140px;">Flow Type</th>
                                        <th style="width: 140px;">Source Cat</th>
                                        <th style="width: 140px;">Target Cat</th>
                                        <th style="width: 300px;">Description</th>
                                        <th style="width: 60px;">‚úì</th>
                                    </tr>
                                </thead>
                                <tbody id="flows-tbody">
                                    <!-- Flows will be dynamically generated -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden file input -->
    <input type="file" id="csv-file-input" style="display: none;" accept=".csv,.json" onchange="handleFileImport(event)">

    <!-- Core Scripts -->
    <script src="js/utils/ExportUtils.js"></script>

    <script>
        // Global data structure
        let currentStatementType = 'income';
        let comparisonMode = false;
        let flowData = {
            metadata: {
                title: "Your Company Financial Flow",
                subtitle: "",
                currency: "USD",
                unit: "millions",
                company: "Your Company",
                period: "Q3 2025",
                previousPeriod: "Q2 2025",
                statementType: "income",
                comparisonMode: false,
                colorPalette: {}
            },
            flows: []
        };

        let flowIdCounter = 0;

        // Enhanced Flow structure with previous period data
        class BusinessFlow {
            constructor(options = {}) {
                this.id = options.id || `flow_${++flowIdCounter}`;
                this.source = options.source || '';
                this.target = options.target || '';
                this.value = options.value || 0;
                this.previousValue = options.previousValue || 0;
                this.flowType = options.flowType || 'revenue_flow';
                this.sourceLayer = options.sourceLayer || 0;
                this.targetLayer = options.targetLayer || 1;
                this.sourceOrder = options.sourceOrder || 1;
                this.targetOrder = options.targetOrder || 1;
                this.sourceCategory = options.sourceCategory || 'revenue';
                this.targetCategory = options.targetCategory || 'revenue';
                this.description = options.description || '';
            }
            
            // Calculate variance between current and previous period
            getVariance() {
                if (this.previousValue === 0) {
                    return this.value > 0 ? { amount: this.value, percentage: 100, trend: 'new' } : { amount: 0, percentage: 0, trend: 'none' };
                }
                
                const amount = this.value - this.previousValue;
                const percentage = (amount / Math.abs(this.previousValue)) * 100;
                let trend = 'none';
                
                if (percentage > 0.1) trend = 'up';
                else if (percentage < -0.1) trend = 'down';
                
                return { amount, percentage, trend };
            }
            
            // Get formatted variance display
            getVarianceDisplay() {
                const variance = this.getVariance();
                if (variance.trend === 'none') return '‚Üí 0%';
                if (variance.trend === 'new') return 'üÜï New';
                
                const symbol = variance.trend === 'up' ? '‚ÜóÔ∏è' : '‚ÜòÔ∏è';
                const sign = variance.percentage > 0 ? '+' : '';
                return `${symbol} ${sign}${variance.percentage.toFixed(1)}%`;
            }
        }

        const statementConfigs = {
            income: {
                title: "Income Statement",
                description: "Shows revenue flows through costs and expenses to arrive at net income. Ideal for understanding profitability and operational efficiency.",
                colorCategories: {
                    revenue: { label: "Revenue", description: "Revenue nodes and flows", default: "#3498db" },
                    cost: { label: "Cost", description: "Cost of revenue nodes", default: "#e74c3c" },
                    profit: { label: "Profit", description: "Profit nodes and flows", default: "#27ae60" },
                    expense: { label: "Expense & Tax", description: "Operating expenses and tax nodes", default: "#e67e22" },
                    income: { label: "Income", description: "Final income nodes", default: "#9b59b6" }
                }
            },
            balance: {
                title: "Balance Sheet",
                description: "Shows how assets are financed by liabilities and equity. Visualizes the fundamental accounting equation: Assets = Liabilities + Equity.",
                colorCategories: {
                    asset: { label: "Assets", description: "Current and non-current assets", default: "#3498db" },
                    liability: { label: "Liabilities", description: "Current and long-term liabilities", default: "#e74c3c" },
                    equity: { label: "Equity", description: "Shareholders' equity components", default: "#27ae60" },
                    current: { label: "Current Items", description: "Short-term assets and liabilities", default: "#f39c12" },
                    noncurrent: { label: "Non-Current Items", description: "Long-term assets and liabilities", default: "#9b59b6" }
                }
            }
        };

        // Comparison Mode Management
        function toggleComparisonMode() {
            comparisonMode = document.getElementById('comparison-mode').checked;
            flowData.metadata.comparisonMode = comparisonMode;
            
            // Show/hide previous period sections
            const previousPeriodSection = document.getElementById('previous-period-section');
            const previousValueHeader = document.getElementById('previous-value-header');
            const varianceHeader = document.getElementById('variance-header');
            const comparisonStats = document.getElementById('comparison-stats');
            
            if (comparisonMode) {
                previousPeriodSection.style.display = 'block';
                previousValueHeader.style.display = 'table-cell';
                varianceHeader.style.display = 'table-cell';
                comparisonStats.style.display = 'flex';
            } else {
                previousPeriodSection.style.display = 'none';
                previousValueHeader.style.display = 'none';
                varianceHeader.style.display = 'none';
                comparisonStats.style.display = 'none';
            }
            
            // Re-render table to show/hide comparison columns
            renderFlowTable();
            updateAllStats();
            
            console.log(`üìà Comparison mode ${comparisonMode ? 'ENABLED' : 'DISABLED'}`);
        }

        // Statement Type Management
        function switchStatementType(type) {
            if (type === currentStatementType) return;
            
            console.log(`üîÑ Switching statement type from ${currentStatementType} to ${type}`);
            
            // Update active tab
            document.querySelectorAll('.statement-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-type="${type}"]`).classList.add('active');
            
            // Update description
            const config = statementConfigs[type];
            document.getElementById('statement-description').textContent = config.description;
            
            // Update current type
            currentStatementType = type;
            flowData.metadata.statementType = type;
            flowData.metadata.title = `${flowData.metadata.company} ${config.title}`;
            
            // Update color palette
            updateColorPalette();
            
            // Load appropriate template if income statement, otherwise show blank
            if (type === 'income') {
                loadSimpleTemplate();
            } else {
                loadBlankFlows();
            }
        }

        function updateColorPalette() {
            const config = statementConfigs[currentStatementType];
            const colorGrid = document.getElementById('color-grid');
            
            // Clear existing colors
            colorGrid.innerHTML = '';
            
            // Reset color palette
            flowData.metadata.colorPalette = {};
            
            // Add colors for current statement type
            Object.entries(config.colorCategories).forEach(([category, info]) => {
                flowData.metadata.colorPalette[category] = info.default;
                
                const colorItem = document.createElement('div');
                colorItem.className = 'color-item';
                colorItem.innerHTML = `
                    <input type="color" class="color-picker" id="${category}-color" value="${info.default}" onchange="updateColor('${category}', this.value)">
                    <div class="color-info">
                        <div class="color-label">${info.label}</div>
                        <div class="color-description">${info.description}</div>
                    </div>
                `;
                colorGrid.appendChild(colorItem);
            });
        }

        // Color Management Functions
        function updateColor(category, color) {
            flowData.metadata.colorPalette[category] = color;
            console.log(`üé® Updated ${category} color to ${color}`);
        }

        function applyColorPreset(presetName) {
            const config = statementConfigs[currentStatementType];
            const categories = Object.keys(config.colorCategories);
            
            // Create temporary chart with proper statement type detection
            const tempChart = new PulseSankeyChart('temp');
            tempChart.statementType = currentStatementType;
            const colors = tempChart.applyColorPreset(presetName, categories);
            
            if (colors) {
                // Apply colors to data
                Object.entries(colors).forEach(([category, color]) => {
                    flowData.metadata.colorPalette[category] = color;
                });
                
                // Update UI
                Object.entries(colors).forEach(([category, color]) => {
                    const picker = document.getElementById(`${category}-color`);
                    if (picker) {
                        picker.value = color;
                    }
                });
                
                console.log(`üé® Applied ${presetName} color preset for ${currentStatementType}`);
            }
        }

        function randomizeColors() {
            const config = statementConfigs[currentStatementType];
            const categories = Object.keys(config.colorCategories);
            
            // Create temporary chart with proper statement type detection
            const tempChart = new PulseSankeyChart('temp');
            tempChart.statementType = currentStatementType;
            const colors = tempChart.randomizeColors(categories);
            
            // Apply colors to data and update UI
            Object.entries(colors).forEach(([category, color]) => {
                flowData.metadata.colorPalette[category] = color;
                
                const picker = document.getElementById(`${category}-color`);
                if (picker) {
                    picker.value = color;
                }
            });
            
            console.log('üé≤ Randomized all colors');
        }

        // Collapsible Section Management
        function toggleSection(sectionName) {
            const header = document.querySelector(`[onclick="toggleSection('${sectionName}')"]`);
            const content = document.getElementById(`${sectionName}-content`);
            
            if (content.classList.contains('collapsed')) {
                content.classList.remove('collapsed');
                content.style.height = 'auto';
                header.classList.remove('collapsed');
            } else {
                content.style.height = content.scrollHeight + 'px';
                setTimeout(() => {
                    content.classList.add('collapsed');
                    header.classList.add('collapsed');
                }, 10);
            }
        }

        // SIMPLIFIED TEMPLATES - Only basic income statement example
        function loadSimpleTemplate() {
            if (currentStatementType === 'income') {
                flowData.metadata.company = "Your Company";
                flowData.metadata.title = "Your Company Income Statement";
                
                // Simple income statement structure with previous period data
                flowData.flows = [
                    new BusinessFlow({
                        source: "Product Sales",
                        target: "Total Revenue",
                        value: 1000,
                        previousValue: 850,
                        flowType: "revenue_flow",
                        sourceLayer: 0,
                        targetLayer: 1,
                        sourceCategory: "revenue",
                        targetCategory: "revenue",
                        description: "Revenue from product sales"
                    }),
                    new BusinessFlow({
                        source: "Service Revenue",
                        target: "Total Revenue",
                        value: 500,
                        previousValue: 480,
                        flowType: "revenue_flow",
                        sourceLayer: 0,
                        targetLayer: 1,
                        sourceCategory: "revenue",
                        targetCategory: "revenue",
                        description: "Revenue from services"
                    }),
                    new BusinessFlow({
                        source: "Total Revenue",
                        target: "Gross Profit",
                        value: 1200,
                        previousValue: 1060,
                        flowType: "profit_flow",
                        sourceLayer: 1,
                        targetLayer: 2,
                        sourceCategory: "revenue",
                        targetCategory: "profit",
                        description: "Revenue after cost of revenue"
                    }),
                    new BusinessFlow({
                        source: "Total Revenue",
                        target: "Cost of Revenue",
                        value: 300,
                        previousValue: 270,
                        flowType: "cost_flow",
                        sourceLayer: 1,
                        targetLayer: 2,
                        sourceCategory: "revenue",
                        targetCategory: "cost",
                        description: "Direct costs to deliver services"
                    }),
                    new BusinessFlow({
                        source: "Gross Profit",
                        target: "Operating Profit",
                        value: 400,
                        previousValue: 350,
                        flowType: "profit_flow",
                        sourceLayer: 2,
                        targetLayer: 3,
                        sourceCategory: "profit",
                        targetCategory: "profit",
                        description: "Profit from core operations"
                    }),
                    new BusinessFlow({
                        source: "Gross Profit",
                        target: "Operating Expenses",
                        value: 800,
                        previousValue: 710,
                        flowType: "expense_flow",
                        sourceLayer: 2,
                        targetLayer: 3,
                        sourceCategory: "profit",
                        targetCategory: "expense",
                        description: "Total operating expenses"
                    }),
                    new BusinessFlow({
                        source: "Operating Expenses",
                        target: "Sales & Marketing",
                        value: 400,
                        previousValue: 360,
                        flowType: "expense_flow",
                        sourceLayer: 3,
                        targetLayer: 4,
                        sourceCategory: "expense",
                        targetCategory: "expense",
                        description: "Customer acquisition costs"
                    }),
                    new BusinessFlow({
                        source: "Operating Expenses",
                        target: "R&D",
                        value: 250,
                        previousValue: 220,
                        flowType: "expense_flow",
                        sourceLayer: 3,
                        targetLayer: 4,
                        sourceCategory: "expense",
                        targetCategory: "expense",
                        description: "Research and development"
                    }),
                    new BusinessFlow({
                        source: "Operating Expenses",
                        target: "General & Admin",
                        value: 150,
                        previousValue: 130,
                        flowType: "expense_flow",
                        sourceLayer: 3,
                        targetLayer: 4,
                        sourceCategory: "expense",
                        targetCategory: "expense",
                        description: "Administrative costs"
                    }),
                    new BusinessFlow({
                        source: "Operating Profit",
                        target: "Net Income",
                        value: 300,
                        previousValue: 260,
                        flowType: "final_flow",
                        sourceLayer: 3,
                        targetLayer: 4,
                        sourceCategory: "profit",
                        targetCategory: "income",
                        description: "Final net income"
                    }),
                    new BusinessFlow({
                        source: "Operating Profit",
                        target: "Tax Expense",
                        value: 100,
                        previousValue: 90,
                        flowType: "expense_flow",
                        sourceLayer: 3,
                        targetLayer: 4,
                        sourceCategory: "profit",
                        targetCategory: "expense",
                        description: "Corporate income tax"
                    })
                ];
                
                document.getElementById('company-name').value = flowData.metadata.company;
                renderFlowTable();
                updateAllStats();
            } else {
                loadBlankFlows();
            }
        }

        function loadBlankFlows() {
            if (confirm('This will clear all current flows. Continue?')) {
                const startingFlows = {
                    income: () => [
                        new BusinessFlow({
                            source: "Revenue Source",
                            target: "Total Revenue",
                            value: 100,
                            previousValue: 0,
                            description: "Start building your income statement here"
                        })
                    ],
                    balance: () => [
                        new BusinessFlow({
                            source: "Asset Item",
                            target: "Total Assets",
                            value: 100,
                            previousValue: 0,
                            sourceCategory: "asset",
                            targetCategory: "asset",
                            description: "Start building your balance sheet here"
                        })
                    ]
                };
                
                flowData.flows = startingFlows[currentStatementType]();
                renderFlowTable();
                updateAllStats();
            }
        }

        function renderFlowTable() {
            const tbody = document.getElementById('flows-tbody');
            tbody.innerHTML = '';
            
            if (flowData.flows.length === 0) {
                const colSpan = comparisonMode ? 13 : 11;
                tbody.innerHTML = `
                    <tr>
                        <td colspan="${colSpan}" style="text-align: center; padding: 40px; color: #6b7280;">
                            <div style="font-size: 16px; margin-bottom: 8px;">üí°</div>
                            <div>No flows defined. Click "Add Flow" to start building your financial structure.</div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            flowData.flows.forEach((flow, index) => {
                const row = createFlowRow(flow, index);
                tbody.appendChild(row);
            });
        }

        function createFlowRow(flow, index) {
            const config = statementConfigs[currentStatementType];
            const categories = Object.keys(config.colorCategories);
            
            const tr = document.createElement('tr');
            
            // Build row HTML with conditional previous value and variance columns
            let rowHTML = `
                <td>
                    <div class="flow-controls">
                        <button class="flow-control-btn up" onclick="moveFlowUp(${index})" title="Move Up" ${index === 0 ? 'disabled' : ''}>‚Üë</button>
                        <button class="flow-control-btn down" onclick="moveFlowDown(${index})" title="Move Down" ${index === flowData.flows.length - 1 ? 'disabled' : ''}>‚Üì</button>
                        <button class="flow-control-btn duplicate" onclick="duplicateFlow(${index})" title="Duplicate">‚ßâ</button>
                        <button class="flow-control-btn remove" onclick="removeFlow(${index})" title="Remove">√ó</button>
                    </div>
                </td>
                <td>
                    <input type="text" class="flow-input" value="${flow.source}" 
                           onchange="updateFlow(${index}, 'source', this.value)">
                </td>
                <td>
                    <input type="text" class="flow-input" value="${flow.target}" 
                           onchange="updateFlow(${index}, 'target', this.value)">
                </td>
                <td>
                    <input type="number" class="flow-input number" value="${flow.value}" 
                           onchange="updateFlow(${index}, 'value', parseFloat(this.value) || 0)">
                </td>`;
            
            // Add previous value column if comparison mode is enabled
            if (comparisonMode) {
                rowHTML += `
                <td>
                    <input type="number" class="flow-input number" value="${flow.previousValue}" 
                           onchange="updateFlow(${index}, 'previousValue', parseFloat(this.value) || 0)">
                </td>
                <td>
                    <div class="variance-indicator ${getVarianceClass(flow)}">${flow.getVarianceDisplay()}</div>
                </td>`;
            }
            
            rowHTML += `
                <td>
                    <input type="number" class="flow-input number" value="${flow.sourceLayer}" min="0" max="20"
                           onchange="updateFlow(${index}, 'sourceLayer', parseInt(this.value) || 0)">
                </td>
                <td>
                    <input type="number" class="flow-input number" value="${flow.targetLayer}" min="0" max="20"
                           onchange="updateFlow(${index}, 'targetLayer', parseInt(this.value) || 0)">
                </td>
                <td>
                    <select class="flow-select" onchange="updateFlow(${index}, 'flowType', this.value)">
                        ${getFlowTypeOptions(flow.flowType)}
                    </select>
                </td>
                <td>
                    <select class="flow-select" onchange="updateFlow(${index}, 'sourceCategory', this.value)">
                        ${getCategoryOptions(categories, flow.sourceCategory)}
                    </select>
                </td>
                <td>
                    <select class="flow-select" onchange="updateFlow(${index}, 'targetCategory', this.value)">
                        ${getCategoryOptions(categories, flow.targetCategory)}
                    </select>
                </td>
                <td>
                    <input type="text" class="flow-input" value="${flow.description}" 
                           onchange="updateFlow(${index}, 'description', this.value)"
                           placeholder="Flow description">
                </td>
                <td>
                    ${getFlowBalanceIndicator(flow)}
                </td>
            `;
            
            tr.innerHTML = rowHTML;
            return tr;
        }

        function getVarianceClass(flow) {
            const variance = flow.getVariance();
            if (variance.trend === 'up') return 'positive';
            if (variance.trend === 'down') return 'negative';
            if (variance.trend === 'new') return 'new';
            return 'neutral';
        }

        function getFlowTypeOptions(selected) {
            const options = [
                { value: 'revenue_flow', label: 'Revenue' },
                { value: 'cost_flow', label: 'Cost' },
                { value: 'profit_flow', label: 'Profit' },
                { value: 'expense_flow', label: 'Expense' },
                { value: 'asset_flow', label: 'Asset' },
                { value: 'liability_flow', label: 'Liability' },
                { value: 'equity_flow', label: 'Equity' },
                { value: 'final_flow', label: 'Final' }
            ];
            
            return options.map(opt => 
                `<option value="${opt.value}" ${opt.value === selected ? 'selected' : ''}>${opt.label}</option>`
            ).join('');
        }

        function getCategoryOptions(categories, selected) {
            return categories.map(cat => 
                `<option value="${cat}" ${cat === selected ? 'selected' : ''}>${cat}</option>`
            ).join('');
        }

        function getFlowBalanceIndicator(flow) {
            const isValid = flow.source && flow.target && flow.value !== 0 && flow.sourceLayer < flow.targetLayer;
            return `<div class="balance-indicator ${isValid ? 'balanced' : 'unbalanced'}">${isValid ? '‚úì' : '‚ö†'}</div>`;
        }

        // Flow Management Functions
        function addFlow() {
            const defaultCategories = {
                income: { source: 'revenue', target: 'revenue' },
                balance: { source: 'asset', target: 'asset' }
            };
            
            const defaults = defaultCategories[currentStatementType];
            
            const newFlow = new BusinessFlow({
                source: "New Source",
                target: "New Target",
                value: 100,
                previousValue: 0,
                sourceLayer: 0,
                targetLayer: 1,
                sourceCategory: defaults.source,
                targetCategory: defaults.target
            });
            
            flowData.flows.push(newFlow);
            renderFlowTable();
            updateAllStats();
        }

        function removeFlow(index) {
            flowData.flows.splice(index, 1);
            renderFlowTable();
            updateAllStats();
        }

        function moveFlowUp(index) {
            if (index > 0) {
                [flowData.flows[index], flowData.flows[index - 1]] = [flowData.flows[index - 1], flowData.flows[index]];
                renderFlowTable();
                updateAllStats();
            }
        }

        function moveFlowDown(index) {
            if (index < flowData.flows.length - 1) {
                [flowData.flows[index], flowData.flows[index + 1]] = [flowData.flows[index + 1], flowData.flows[index]];
                renderFlowTable();
                updateAllStats();
            }
        }

        function duplicateFlow(index) {
            const originalFlow = flowData.flows[index];
            const duplicatedFlow = new BusinessFlow({
                source: originalFlow.source + " Copy",
                target: originalFlow.target,
                value: originalFlow.value,
                previousValue: originalFlow.previousValue,
                flowType: originalFlow.flowType,
                sourceLayer: originalFlow.sourceLayer,
                targetLayer: originalFlow.targetLayer,
                sourceCategory: originalFlow.sourceCategory,
                targetCategory: originalFlow.targetCategory,
                description: originalFlow.description + " (Copy)"
            });
            
            flowData.flows.splice(index + 1, 0, duplicatedFlow);
            renderFlowTable();
            updateAllStats();
        }

        function updateFlow(index, field, value) {
            if (flowData.flows[index]) {
                flowData.flows[index][field] = value;
                updateAllStats();
                
                // Update variance display if we're in comparison mode
                if (comparisonMode && (field === 'value' || field === 'previousValue')) {
                    renderFlowTable();
                } else {
                    const row = document.querySelectorAll('#flows-tbody tr')[index];
                    if (row) {
                        const balanceCell = row.lastElementChild;
                        balanceCell.innerHTML = getFlowBalanceIndicator(flowData.flows[index]);
                    }
                }
            }
        }

        function updateMetadata() {
            flowData.metadata.company = document.getElementById('company-name').value;
            flowData.metadata.period = document.getElementById('period').value;
            flowData.metadata.currency = document.getElementById('currency').value;
            flowData.metadata.unit = document.getElementById('units').value;
            
            const config = statementConfigs[currentStatementType];
            flowData.metadata.title = `${flowData.metadata.company} ${config.title}`;
            
            // Update previous period if field exists
            const previousPeriodField = document.getElementById('previous-period');
            if (previousPeriodField) {
                flowData.metadata.previousPeriod = previousPeriodField.value;
            }
        }

        function generateNodesAndLinksFromFlows() {
            // Use the static method from SankeyChart for data processing
            return PulseSankeyChart.generateNodesAndLinksFromFlows(flowData, comparisonMode);
        }

        function updateAllStats() {
            const nodeMap = new Map();
            
            flowData.flows.forEach(flow => {
                nodeMap.set(flow.source, flow.sourceLayer);
                nodeMap.set(flow.target, flow.targetLayer);
            });
            
            const flowCount = flowData.flows.length;
            const nodeCount = nodeMap.size;
            const layerCount = new Set(Array.from(nodeMap.values())).size;
            
            let balancedFlows = 0;
            flowData.flows.forEach(flow => {
                const isValid = flow.source && flow.target && flow.value !== 0 && flow.sourceLayer < flow.targetLayer;
                if (isValid) balancedFlows++;
            });
            
            const balanceScore = flowCount > 0 ? Math.round((balancedFlows / flowCount) * 100) : 0;
            
            // Calculate average growth if comparison mode is enabled
            let avgGrowth = 0;
            if (comparisonMode && flowCount > 0) {
                const totalGrowth = flowData.flows.reduce((sum, flow) => {
                    const variance = flow.getVariance();
                    return sum + variance.percentage;
                }, 0);
                avgGrowth = totalGrowth / flowCount;
            }
            
            document.getElementById('flow-count').textContent = flowCount;
            document.getElementById('node-count').textContent = nodeCount;
            document.getElementById('layer-count').textContent = layerCount;
            document.getElementById('balance-score').textContent = balanceScore + '%';
            
            if (comparisonMode) {
                const avgGrowthElement = document.getElementById('avg-growth');
                if (avgGrowthElement) {
                    const sign = avgGrowth > 0 ? '+' : '';
                    avgGrowthElement.textContent = `${sign}${avgGrowth.toFixed(1)}%`;
                }
            }
        }

        function validateFlows() {
            const errors = [];
            const warnings = [];
            
            if (flowData.flows.length === 0) {
                errors.push('No flows defined');
            }
            
            flowData.flows.forEach((flow, index) => {
                if (!flow.source || !flow.target) {
                    errors.push(`Flow ${index + 1}: Missing source or target`);
                }
                
                if (flow.value === 0) {
                    warnings.push(`Flow ${index + 1}: Zero value flow`);
                }
                
                if (flow.sourceLayer >= flow.targetLayer) {
                    errors.push(`Flow ${index + 1}: Source layer (${flow.sourceLayer}) must be less than target layer (${flow.targetLayer})`);
                }
                
                if (flow.source === flow.target) {
                    errors.push(`Flow ${index + 1}: Source and target cannot be the same`);
                }
                
                if (comparisonMode && flow.previousValue < 0) {
                    warnings.push(`Flow ${index + 1}: Negative previous value may cause display issues`);
                }
            });
            
            let message = `‚úÖ ${statementConfigs[currentStatementType].title} Validation Results\n\n`;
            
            if (errors.length > 0) {
                message += '‚ùå Errors:\n' + errors.map(e => `‚Ä¢ ${e}`).join('\n') + '\n\n';
            }
            
            if (warnings.length > 0) {
                message += '‚ö†Ô∏è Warnings:\n' + warnings.map(w => `‚Ä¢ ${w}`).join('\n') + '\n\n';
            }
            
            if (errors.length === 0 && warnings.length === 0) {
                message += 'Perfect! All flows are valid.\n\n';
            }
            
            const balanceScore = document.getElementById('balance-score').textContent;
            message += `üìä Summary:\n‚Ä¢ ${flowData.flows.length} flows\n‚Ä¢ Statement Type: ${currentStatementType}\n‚Ä¢ Balance Score: ${balanceScore}`;
            
            if (comparisonMode) {
                const avgGrowth = document.getElementById('avg-growth').textContent;
                message += `\n‚Ä¢ Average Growth: ${avgGrowth}`;
            }
            
            alert(message);
        }

        // Export functions using ExportUtils.js
        function exportToCSV() {
            if (!window.ExportUtils) {
                console.error('ExportUtils not loaded');
                alert('Export functionality not available. Please refresh the page.');
                return;
            }
            
            window.ExportUtils.exportFinancialFlowsToCSV(flowData);
        }

        function exportToJSON() {
            if (!window.ExportUtils) {
                console.error('ExportUtils not loaded');
                alert('Export functionality not available. Please refresh the page.');
                return;
            }
            
            window.ExportUtils.exportFinancialFlowsToJSON(flowData);
        }

        function importFromCSV() {
            document.getElementById('csv-file-input').click();
        }

        function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                const content = e.target.result;
                
                if (file.name.endsWith('.json')) {
                    try {
                        const data = JSON.parse(content);
                        if (data.flows) {
                            flowData = data;
                            if (data.metadata && data.metadata.statementType) {
                                switchStatementType(data.metadata.statementType);
                            }
                            if (data.metadata && data.metadata.comparisonMode) {
                                document.getElementById('comparison-mode').checked = data.metadata.comparisonMode;
                                toggleComparisonMode();
                            }
                        } else if (data.nodes && data.links) {
                            alert('‚ö†Ô∏è Please use the Flow Builder format for imports. Nodes/links format not supported here.');
                            return;
                        }
                        renderFlowTable();
                        updateAllStats();
                        alert('‚úÖ Successfully imported flows!');
                    } catch (error) {
                        alert('‚ùå Error parsing JSON: ' + error.message);
                    }
                } else if (file.name.endsWith('.csv')) {
                    parseCSVFlows(content);
                }
            };
            reader.readAsText(file);
        }

        function parseCSVFlows(csvContent) {
            const lines = csvContent.split('\n').filter(line => line.trim() && !line.startsWith('#'));
            if (lines.length < 2) {
                alert('‚ùå CSV file must have header and at least one data row');
                return;
            }
            
            const flows = [];
            let detectedStatementType = null;
            
            for (let i = 1; i < lines.length; i++) {
                const values = parseCSVLine(lines[i]);
                if (values.length >= 10) {
                    if (!detectedStatementType && values[0]) {
                        detectedStatementType = values[0];
                    }
                    
                    flows.push(new BusinessFlow({
                        source: values[1],
                        target: values[2],
                        value: parseFloat(values[3]) || 0,
                        previousValue: parseFloat(values[4]) || 0, // Support previous value in CSV
                        flowType: values[5] || 'revenue_flow',
                        sourceLayer: parseInt(values[6]) || 0,
                        targetLayer: parseInt(values[7]) || 1,
                        sourceCategory: values[8] || 'revenue',
                        targetCategory: values[9] || 'revenue',
                        description: values[10] || ''
                    }));
                }
            }
            
            if (flows.length > 0) {
                if (detectedStatementType && detectedStatementType !== currentStatementType) {
                    switchStatementType(detectedStatementType);
                }
                
                flowData.flows = flows;
                
                // Enable comparison mode if any previous values exist
                const hasPreviousValues = flows.some(flow => flow.previousValue > 0);
                if (hasPreviousValues) {
                    document.getElementById('comparison-mode').checked = true;
                    toggleComparisonMode();
                }
                
                renderFlowTable();
                updateAllStats();
                alert(`‚úÖ Successfully imported ${flows.length} flows from CSV!`);
            } else {
                alert('‚ùå No valid flows found in CSV file');
            }
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current.trim());
            return result.map(field => field.replace(/^"|"$/g, ''));
        }

        function generateChart() {
            const urlParams = new URLSearchParams(window.location.search);
            const chartType = urlParams.get('chartType') || 'sankey';
            const returnTo = urlParams.get('returnTo');
            
            // Use the static method from SankeyChart for chart generation
            PulseSankeyChart.generateChartFromFlows(flowData, comparisonMode, chartType, returnTo);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            switchStatementType('income');
            loadSimpleTemplate();
            
            // Initialize comparison mode toggle visibility
            toggleComparisonMode();
        });
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Business Flow Designer - Pulse Analytics</title>
    
    <!-- Consolidated Application Styles -->
    <link rel="stylesheet" href="css/pulse-analytics.css">
    
    <style>
        /* Sticky Action Bar */
        .action-bar {
            position: sticky;
            top: 0;
            z-index: 100;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 16px 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }
        
        .action-bar-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1600px;
            margin: 0 auto;
        }
        
        .action-title {
            font-size: 18px;
            font-weight: 600;
            margin: 0;
        }
        
        .action-buttons {
            display: flex;
            gap: 12px;
            align-items: center;
        }
        
        .action-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .action-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-1px);
        }
        
        .action-btn.primary {
            background: #f59e0b;
            border-color: #f59e0b;
        }
        
        .action-btn.primary:hover {
            background: #d97706;
            border-color: #d97706;
        }

        /* Preview Toggle Button - Always Visible */
        .preview-toggle-btn {
            position: fixed;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            background: #667eea;
            color: white;
            border: none;
            width: 40px;
            height: 80px;
            border-radius: 20px 0 0 20px;
            cursor: pointer;
            font-size: 18px;
            z-index: 200;
            box-shadow: -2px 0 8px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }
        
        .preview-toggle-btn:hover {
            background: #5a6fd8;
            transform: translateY(-50%) translateX(-2px);
        }
        
        .template-container.preview-hidden .preview-toggle-btn {
            right: 0;
            border-radius: 0 20px 20px 0;
            box-shadow: 2px 0 8px rgba(0,0,0,0.2);
        }
        
        /* Collapsible Sections */
        .collapsible-section {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            overflow: hidden;
            margin-bottom: 20px;
        }
        
        .collapsible-header {
            background: #f8f9fa;
            padding: 16px 20px;
            border-bottom: 1px solid #e1e5e9;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.2s ease;
        }
        
        .collapsible-header:hover {
            background: #e9ecef;
        }
        
        .collapsible-header.collapsed {
            border-bottom: none;
        }
        
        .collapsible-title {
            font-size: 16px;
            font-weight: 600;
            color: #1f2937;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .collapsible-chevron {
            transition: transform 0.2s ease;
            color: #6b7280;
        }
        
        .collapsible-header.collapsed .collapsible-chevron {
            transform: rotate(-90deg);
        }
        
        .collapsible-content {
            transition: all 0.3s ease;
            overflow: hidden;
        }
        
        .collapsible-content.collapsed {
            height: 0 !important;
            padding: 0 !important;
        }
        
        /* Flow Management */
        .flow-controls {
            display: flex;
            gap: 4px;
            align-items: center;
        }
        
        .flow-control-btn {
            background: #6b7280;
            color: white;
            border: none;
            width: 20px;
            height: 20px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        
        .flow-control-btn:hover {
            background: #4b5563;
            transform: scale(1.1);
        }
        
        .flow-control-btn.up:hover { background: #059669; }
        .flow-control-btn.down:hover { background: #dc2626; }
        .flow-control-btn.duplicate:hover { background: #0369a1; }
        .flow-control-btn.remove:hover { background: #dc2626; }
        
        /* Flow Table Styles */
        .flow-table-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            overflow: hidden;
            margin-bottom: 20px;
        }
        
        .flow-table-header {
            background: #f8f9fa;
            padding: 16px 20px;
            border-bottom: 1px solid #e1e5e9;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .flow-table-title {
            font-size: 16px;
            font-weight: 600;
            color: #1f2937;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .flow-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        
        .flow-table th {
            background: #f8f9fa;
            padding: 12px 8px;
            text-align: left;
            font-weight: 600;
            color: #374151;
            border-bottom: 2px solid #e1e5e9;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .flow-table td {
            padding: 8px;
            border-bottom: 1px solid #f1f3f4;
            vertical-align: middle;
        }
        
        .flow-table tr:hover {
            background: #f8f9fa;
        }
        
        .flow-input {
            width: 100%;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            padding: 6px 8px;
            font-size: 12px;
            background: white;
        }
        
        .flow-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
        }
        
        .flow-input.number {
            text-align: right;
        }
        
        .flow-select {
            width: 100%;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            padding: 6px 8px;
            font-size: 12px;
            background: white;
        }
        
        .add-flow-btn {
            background: #10b981;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .add-flow-btn:hover {
            background: #059669;
        }
        
        /* Balance Indicator */
        .balance-indicator {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
        }
        
        .balance-indicator.balanced {
            background: #d1fae5;
            color: #065f46;
        }
        
        .balance-indicator.unbalanced {
            background: #fee2e2;
            color: #991b1b;
        }
        
        /* Template Quick Actions */
        .template-actions {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
        }
        
        .template-btn {
            background: #f8f9fa;
            border: 1px solid #d1d5db;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
        }
        
        .template-btn:hover {
            background: #e5e7eb;
        }
        
        /* Stats Display */
        .stats-bar {
            background: #e7f3ff;
            border: 1px solid #0ea5e9;
            border-radius: 6px;
            padding: 12px 16px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
        }
        
        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }
        
        .stat-value {
            font-size: 16px;
            font-weight: 600;
            color: #0369a1;
        }
        
        .stat-label {
            color: #6b7280;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        /* Responsive adjustments */
        @media (max-width: 1200px) {
            .flow-table {
                font-size: 12px;
            }
            
            .flow-table th,
            .flow-table td {
                padding: 6px 4px;
            }
            
            .flow-input,
            .flow-select {
                font-size: 11px;
                padding: 4px 6px;
            }
        }
        
        @media (max-width: 768px) {
            .action-bar-content {
                flex-direction: column;
                gap: 12px;
            }
            
            .action-buttons {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .stats-bar {
                flex-direction: column;
                gap: 12px;
            }
            
            .preview-toggle-btn {
                display: none;
            }
        }
    </style>
</head>
<body style="background: #f8f9fa;">
    <!-- Sticky Action Bar -->
    <div class="action-bar">
        <div class="action-bar-content">
            <div>
                <h1 class="action-title">💰 Business Flow Designer</h1>
                <div style="font-size: 12px; opacity: 0.8; margin-top: 2px;">
                    Build financial flows: "From Revenue to Profit"
                </div>
            </div>
            <div class="action-buttons">
                <button class="action-btn" onclick="validateFlows()">✅ Validate</button>
                <button class="action-btn" onclick="exportToCSV()">📄 Export</button>
                <button class="action-btn" onclick="importFromCSV()">📂 Import</button>
                <button class="action-btn primary" onclick="generateChart()">🚀 Generate Chart</button>
            </div>
        </div>
    </div>

    <!-- Fixed Preview Toggle Button -->
    <button class="preview-toggle-btn" onclick="togglePreviewPanel()" title="Toggle Preview Panel">
        <span id="preview-toggle-icon">◀</span>
    </button>

    <div class="template-container">
        <div class="template-main">
            <div class="template-content" style="padding-top: 20px;">
                <!-- Quick Stats -->
                <div class="stats-bar">
                    <div class="stat-item">
                        <div class="stat-value" id="flow-count">0</div>
                        <div class="stat-label">Business Flows</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="node-count">0</div>
                        <div class="stat-label">Generated Nodes</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="layer-count">0</div>
                        <div class="stat-label">Layers</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="balance-score">0%</div>
                        <div class="stat-label">Balance Score</div>
                    </div>
                </div>

                <!-- Template Quick Actions -->
                <div class="template-actions">
                    <button class="template-btn" onclick="loadCompleteTemplate()">📊 Complete Template</button>
                    <button class="template-btn" onclick="loadBlankFlows()">📄 Blank Template</button>
                </div>

                <!-- Company Information Section -->
                <div class="collapsible-section">
                    <div class="collapsible-header" onclick="toggleSection('company')">
                        <h3 class="collapsible-title">🏢 Company Information</h3>
                        <span class="collapsible-chevron">▼</span>
                    </div>
                    <div class="collapsible-content" id="company-content">
                        <div style="padding: 20px;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                                <div>
                                    <label style="display: block; font-size: 12px; font-weight: 500; color: #374151; margin-bottom: 4px;">Company Name</label>
                                    <input type="text" class="flow-input" id="company-name" value="TechFlow Corporation" onchange="updateMetadata()">
                                </div>
                                <div>
                                    <label style="display: block; font-size: 12px; font-weight: 500; color: #374151; margin-bottom: 4px;">Period</label>
                                    <input type="text" class="flow-input" id="period" value="Q3 2025" onchange="updateMetadata()">
                                </div>
                                <div>
                                    <label style="display: block; font-size: 12px; font-weight: 500; color: #374151; margin-bottom: 4px;">Currency</label>
                                    <select class="flow-select" id="currency" onchange="updateMetadata()">
                                        <option value="USD">USD ($)</option>
                                        <option value="EUR">EUR (€)</option>
                                        <option value="GBP">GBP (£)</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="display: block; font-size: 12px; font-weight: 500; color: #374151; margin-bottom: 4px;">Units</label>
                                    <select class="flow-select" id="units" onchange="updateMetadata()">
                                        <option value="millions">Millions</option>
                                        <option value="billions">Billions</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Business Flows Section -->
                <div class="collapsible-section">
                    <div class="collapsible-header" onclick="toggleSection('flows')">
                        <h3 class="collapsible-title">
                            💰 Business Flows
                            <span style="background: #e7f3ff; color: #0369a1; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: 500;">Dynamic</span>
                        </h3>
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <button class="add-flow-btn" onclick="addFlow()">+ Add Flow</button>
                            <span class="collapsible-chevron">▼</span>
                        </div>
                    </div>
                    <div class="collapsible-content" id="flows-content">
                        <div style="overflow-x: auto;">
                            <table class="flow-table">
                                <thead>
                                    <tr>
                                        <th style="width: 50px;">Actions</th>
                                        <th style="width: 180px;">From (Source)</th>
                                        <th style="width: 180px;">To (Target)</th>
                                        <th style="width: 80px;">Amount</th>
                                        <th style="width: 70px;">Src Layer</th>
                                        <th style="width: 70px;">Tgt Layer</th>
                                        <th style="width: 100px;">Flow Type</th>
                                        <th style="width: 90px;">Source Cat</th>
                                        <th style="width: 90px;">Target Cat</th>
                                        <th style="width: 200px;">Description</th>
                                        <th style="width: 50px;">✓</th>
                                    </tr>
                                </thead>
                                <tbody id="flows-tbody">
                                    <!-- Flows will be dynamically generated -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Preview Panel -->
        <div class="preview-panel" id="preview-panel">
            <div class="preview-header">
                📊 Live Preview & Validation
            </div>
            <div class="preview-tabs">
                <button class="preview-tab active" onclick="switchTab('structure')">Structure</button>
                <button class="preview-tab" onclick="switchTab('json')">JSON Data</button>
                <button class="preview-tab" onclick="switchTab('validation')">Validation</button>
            </div>
            <div class="preview-content">
                <div id="structure-tab" class="tab-content">
                    <div class="layer-preview" id="structure-preview">
                        <!-- Structure analysis will be populated here -->
                    </div>
                </div>
                <div id="json-tab" class="tab-content" style="display: none;">
                    <textarea class="json-preview" id="json-preview" readonly></textarea>
                </div>
                <div id="validation-tab" class="tab-content" style="display: none;">
                    <div class="layer-preview" id="validation-preview">
                        <!-- Validation results will be populated here -->
                    </div>
                </div>
            </div>
            <div class="json-stats" id="json-stats">
                Ready to build flows
            </div>
        </div>
    </div>

    <!-- Hidden file input -->
    <input type="file" id="csv-file-input" style="display: none;" accept=".csv,.json" onchange="handleFileImport(event)">

    <script>
        // Global data structure
        let flowData = {
            metadata: {
                title: "TechFlow Financial Flow",
                subtitle: "Multi-Layer Business Model",
                currency: "USD",
                unit: "millions",
                company: "TechFlow Corporation",
                period: "Q3 2025"
            },
            flows: []
        };

        let currentTab = 'structure';
        let flowIdCounter = 0;

        // Flow structure definition
        class BusinessFlow {
            constructor(options = {}) {
                this.id = options.id || `flow_${++flowIdCounter}`;
                this.source = options.source || '';
                this.target = options.target || '';
                this.value = options.value || 0;
                this.flowType = options.flowType || 'revenue_flow';
                this.sourceLayer = options.sourceLayer || 0;
                this.targetLayer = options.targetLayer || 1;
                this.sourceOrder = options.sourceOrder || 1;
                this.targetOrder = options.targetOrder || 1;
                this.sourceCategory = options.sourceCategory || 'revenue';
                this.targetCategory = options.targetCategory || 'revenue';
                this.description = options.description || '';
            }
        }

        // Collapsible Section Management
        function toggleSection(sectionName) {
            const header = document.querySelector(`[onclick="toggleSection('${sectionName}')"]`);
            const content = document.getElementById(`${sectionName}-content`);
            
            if (content.classList.contains('collapsed')) {
                content.classList.remove('collapsed');
                content.style.height = 'auto';
                header.classList.remove('collapsed');
            } else {
                content.style.height = content.scrollHeight + 'px';
                setTimeout(() => {
                    content.classList.add('collapsed');
                    header.classList.add('collapsed');
                }, 10);
            }
        }

        function loadCompleteTemplate() {
            flowData.metadata.company = "TechFlow Corporation";
            flowData.metadata.title = "TechFlow Financial Flow";
            flowData.metadata.subtitle = "Multi-Layer Business Model";
            
            flowData.flows = [
                new BusinessFlow({
                    source: "Creative Cloud",
                    target: "Subscription",
                    value: 2800,
                    flowType: "revenue_flow",
                    sourceLayer: 0,
                    targetLayer: 1,
                    sourceCategory: "revenue",
                    targetCategory: "revenue",
                    description: "Photoshop, Illustrator, and creative tools"
                }),
                new BusinessFlow({
                    source: "Document Cloud",
                    target: "Subscription",
                    value: 600,
                    flowType: "revenue_flow",
                    sourceLayer: 0,
                    targetLayer: 1,
                    sourceCategory: "revenue",
                    targetCategory: "revenue",
                    description: "Acrobat, Sign, and document services"
                }),
                new BusinessFlow({
                    source: "Experience Cloud",
                    target: "Subscription",
                    value: 1200,
                    flowType: "revenue_flow",
                    sourceLayer: 0,
                    targetLayer: 1,
                    sourceCategory: "revenue",
                    targetCategory: "revenue",
                    description: "Analytics, Commerce, and marketing tools"
                }),
                new BusinessFlow({
                    source: "Products",
                    target: "Total Revenue",
                    value: 900,
                    flowType: "revenue_flow",
                    sourceLayer: 1,
                    targetLayer: 2,
                    sourceCategory: "revenue",
                    targetCategory: "revenue",
                    description: "Product-based revenue"
                }),
                new BusinessFlow({
                    source: "Subscription",
                    target: "Total Revenue",
                    value: 4600,
                    flowType: "revenue_flow",
                    sourceLayer: 1,
                    targetLayer: 2,
                    sourceCategory: "revenue",
                    targetCategory: "revenue",
                    description: "All subscription-based revenue"
                }),
                new BusinessFlow({
                    source: "Total Revenue",
                    target: "Gross Profit",
                    value: 3800,
                    flowType: "profit_flow",
                    sourceLayer: 2,
                    targetLayer: 3,
                    sourceCategory: "revenue",
                    targetCategory: "profit",
                    description: "Revenue after cost of revenue"
                }),
                new BusinessFlow({
                    source: "Total Revenue",
                    target: "Cost of Revenue",
                    value: 800,
                    flowType: "cost_flow",
                    sourceLayer: 2,
                    targetLayer: 3,
                    sourceCategory: "revenue",
                    targetCategory: "cost",
                    description: "Direct costs to deliver services"
                }),
                new BusinessFlow({
                    source: "Gross Profit",
                    target: "Operating Profit",
                    value: 1400,
                    flowType: "profit_flow",
                    sourceLayer: 3,
                    targetLayer: 4,
                    sourceCategory: "profit",
                    targetCategory: "profit",
                    description: "Profit from core operations"
                }),
                new BusinessFlow({
                    source: "Gross Profit",
                    target: "Operating Expenses",
                    value: 2400,
                    flowType: "expense_flow",
                    sourceLayer: 3,
                    targetLayer: 4,
                    sourceCategory: "profit",
                    targetCategory: "expense",
                    description: "Total operating expenses"
                }),
                new BusinessFlow({
                    source: "Operating Expenses",
                    target: "R&D",
                    value: 1200,
                    flowType: "expense_flow",
                    sourceLayer: 4,
                    targetLayer: 5,
                    sourceCategory: "expense",
                    targetCategory: "expense",
                    description: "Research and development investment"
                }),
                new BusinessFlow({
                    source: "Operating Expenses",
                    target: "Sales & Marketing",
                    value: 800,
                    flowType: "expense_flow",
                    sourceLayer: 4,
                    targetLayer: 5,
                    sourceCategory: "expense",
                    targetCategory: "expense",
                    description: "Customer acquisition and marketing"
                }),
                new BusinessFlow({
                    source: "Operating Expenses",
                    target: "General & Admin",
                    value: 400,
                    flowType: "expense_flow",
                    sourceLayer: 4,
                    targetLayer: 5,
                    sourceCategory: "expense",
                    targetCategory: "expense",
                    description: "Administrative and overhead costs"
                }),
                new BusinessFlow({
                    source: "Operating Profit",
                    target: "Net Income",
                    value: 1100,
                    flowType: "final_flow",
                    sourceLayer: 4,
                    targetLayer: 5,
                    sourceCategory: "profit",
                    targetCategory: "income",
                    description: "Final net income after all expenses"
                }),
                new BusinessFlow({
                    source: "Operating Profit",
                    target: "Tax Expense",
                    value: 300,
                    flowType: "expense_flow",
                    sourceLayer: 4,
                    targetLayer: 5,
                    sourceCategory: "profit",
                    targetCategory: "expense",
                    description: "Corporate income tax"
                })
            ];
            
            document.getElementById('company-name').value = flowData.metadata.company;
            renderFlowTable();
            updateAllStats();
            updateAllPreviews();
        }

        function loadBlankFlows() {
            if (confirm('This will clear all current flows. Continue?')) {
                flowData.flows = [
                    new BusinessFlow({
                        source: "Revenue Source",
                        target: "Total Revenue",
                        value: 100,
                        description: "Start building your flow here"
                    })
                ];
                
                renderFlowTable();
                updateAllStats();
                updateAllPreviews();
            }
        }

        function renderFlowTable() {
            const tbody = document.getElementById('flows-tbody');
            tbody.innerHTML = '';
            
            if (flowData.flows.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="11" style="text-align: center; padding: 40px; color: #6b7280;">
                            <div style="font-size: 16px; margin-bottom: 8px;">💡</div>
                            <div>No flows defined. Click "Add Flow" to start building your financial structure.</div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            flowData.flows.forEach((flow, index) => {
                const row = createFlowRow(flow, index);
                tbody.appendChild(row);
            });
        }

        function createFlowRow(flow, index) {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>
                    <div class="flow-controls">
                        <button class="flow-control-btn up" onclick="moveFlowUp(${index})" title="Move Up" ${index === 0 ? 'disabled' : ''}>↑</button>
                        <button class="flow-control-btn down" onclick="moveFlowDown(${index})" title="Move Down" ${index === flowData.flows.length - 1 ? 'disabled' : ''}>↓</button>
                        <button class="flow-control-btn duplicate" onclick="duplicateFlow(${index})" title="Duplicate">⧉</button>
                        <button class="flow-control-btn remove" onclick="removeFlow(${index})" title="Remove">×</button>
                    </div>
                </td>
                <td>
                    <input type="text" class="flow-input" value="${flow.source}" 
                           onchange="updateFlow(${index}, 'source', this.value)">
                </td>
                <td>
                    <input type="text" class="flow-input" value="${flow.target}" 
                           onchange="updateFlow(${index}, 'target', this.value)">
                </td>
                <td>
                    <input type="number" class="flow-input number" value="${flow.value}" 
                           onchange="updateFlow(${index}, 'value', parseFloat(this.value) || 0)">
                </td>
                <td>
                    <input type="number" class="flow-input number" value="${flow.sourceLayer}" min="0" max="20"
                           onchange="updateFlow(${index}, 'sourceLayer', parseInt(this.value) || 0)">
                </td>
                <td>
                    <input type="number" class="flow-input number" value="${flow.targetLayer}" min="0" max="20"
                           onchange="updateFlow(${index}, 'targetLayer', parseInt(this.value) || 0)">
                </td>
                <td>
                    <select class="flow-select" onchange="updateFlow(${index}, 'flowType', this.value)">
                        <option value="revenue_flow" ${flow.flowType === 'revenue_flow' ? 'selected' : ''}>Revenue</option>
                        <option value="cost_flow" ${flow.flowType === 'cost_flow' ? 'selected' : ''}>Cost</option>
                        <option value="profit_flow" ${flow.flowType === 'profit_flow' ? 'selected' : ''}>Profit</option>
                        <option value="expense_flow" ${flow.flowType === 'expense_flow' ? 'selected' : ''}>Expense</option>
                        <option value="final_flow" ${flow.flowType === 'final_flow' ? 'selected' : ''}>Final</option>
                    </select>
                </td>
                <td>
                    <select class="flow-select" onchange="updateFlow(${index}, 'sourceCategory', this.value)">
                        <option value="revenue" ${flow.sourceCategory === 'revenue' ? 'selected' : ''}>Revenue</option>
                        <option value="cost" ${flow.sourceCategory === 'cost' ? 'selected' : ''}>Cost</option>
                        <option value="profit" ${flow.sourceCategory === 'profit' ? 'selected' : ''}>Profit</option>
                        <option value="expense" ${flow.sourceCategory === 'expense' ? 'selected' : ''}>Expense</option>
                        <option value="income" ${flow.sourceCategory === 'income' ? 'selected' : ''}>Income</option>
                    </select>
                </td>
                <td>
                    <select class="flow-select" onchange="updateFlow(${index}, 'targetCategory', this.value)">
                        <option value="revenue" ${flow.targetCategory === 'revenue' ? 'selected' : ''}>Revenue</option>
                        <option value="cost" ${flow.targetCategory === 'cost' ? 'selected' : ''}>Cost</option>
                        <option value="profit" ${flow.targetCategory === 'profit' ? 'selected' : ''}>Profit</option>
                        <option value="expense" ${flow.targetCategory === 'expense' ? 'selected' : ''}>Expense</option>
                        <option value="income" ${flow.targetCategory === 'income' ? 'selected' : ''}>Income</option>
                    </select>
                </td>
                <td>
                    <input type="text" class="flow-input" value="${flow.description}" 
                           onchange="updateFlow(${index}, 'description', this.value)"
                           placeholder="Flow description">
                </td>
                <td>
                    ${getFlowBalanceIndicator(flow)}
                </td>
            `;
            return tr;
        }

        function getFlowBalanceIndicator(flow) {
            const isValid = flow.source && flow.target && flow.value > 0 && flow.sourceLayer < flow.targetLayer;
            return `<div class="balance-indicator ${isValid ? 'balanced' : 'unbalanced'}">${isValid ? '✓' : '⚠'}</div>`;
        }

        // Flow Management Functions
        function addFlow() {
            const newFlow = new BusinessFlow({
                source: "New Source",
                target: "New Target",
                value: 100,
                sourceLayer: 0,
                targetLayer: 1
            });
            
            flowData.flows.push(newFlow);
            renderFlowTable();
            updateAllStats();
            updateAllPreviews();
        }

        function removeFlow(index) {
            flowData.flows.splice(index, 1);
            renderFlowTable();
            updateAllStats();
            updateAllPreviews();
        }

        function moveFlowUp(index) {
            if (index > 0) {
                [flowData.flows[index], flowData.flows[index - 1]] = [flowData.flows[index - 1], flowData.flows[index]];
                renderFlowTable();
                updateAllPreviews();
            }
        }

        function moveFlowDown(index) {
            if (index < flowData.flows.length - 1) {
                [flowData.flows[index], flowData.flows[index + 1]] = [flowData.flows[index + 1], flowData.flows[index]];
                renderFlowTable();
                updateAllPreviews();
            }
        }

        function duplicateFlow(index) {
            const originalFlow = flowData.flows[index];
            const duplicatedFlow = new BusinessFlow({
                source: originalFlow.source + " Copy",
                target: originalFlow.target,
                value: originalFlow.value,
                flowType: originalFlow.flowType,
                sourceLayer: originalFlow.sourceLayer,
                targetLayer: originalFlow.targetLayer,
                sourceCategory: originalFlow.sourceCategory,
                targetCategory: originalFlow.targetCategory,
                description: originalFlow.description + " (Copy)"
            });
            
            flowData.flows.splice(index + 1, 0, duplicatedFlow);
            renderFlowTable();
            updateAllStats();
            updateAllPreviews();
        }

        function updateFlow(index, field, value) {
            if (flowData.flows[index]) {
                flowData.flows[index][field] = value;
                updateAllStats();
                updateAllPreviews();
                
                const row = document.querySelectorAll('#flows-tbody tr')[index];
                if (row) {
                    const balanceCell = row.lastElementChild;
                    balanceCell.innerHTML = getFlowBalanceIndicator(flowData.flows[index]);
                }
            }
        }

        function updateMetadata() {
            flowData.metadata.company = document.getElementById('company-name').value;
            flowData.metadata.period = document.getElementById('period').value;
            flowData.metadata.currency = document.getElementById('currency').value;
            flowData.metadata.unit = document.getElementById('units').value;
            flowData.metadata.title = `${flowData.metadata.company} Financial Flow`;
            flowData.metadata.subtitle = `${flowData.metadata.period} Business Model`;
            
            updateAllPreviews();
        }

        function generateNodesAndLinksFromFlows() {
            const nodeMap = new Map();
            const links = [];
            
            flowData.flows.forEach(flow => {
                if (!nodeMap.has(flow.source)) {
                    nodeMap.set(flow.source, {
                        id: flow.source,
                        depth: flow.sourceLayer,
                        value: 0,
                        category: flow.sourceCategory,
                        description: `Source: ${flow.description}`,
                        sort_order: flow.sourceOrder || 1
                    });
                }
                
                if (!nodeMap.has(flow.target)) {
                    nodeMap.set(flow.target, {
                        id: flow.target,
                        depth: flow.targetLayer,
                        value: 0,
                        category: flow.targetCategory,
                        description: `Target: ${flow.description}`,
                        sort_order: flow.targetOrder || 1
                    });
                }
                
                const targetNode = nodeMap.get(flow.target);
                targetNode.value += flow.value;
                
                links.push({
                    source: flow.source,
                    target: flow.target,
                    value: flow.value,
                    type: flow.flowType,
                    description: flow.description
                });
            });
            
            flowData.flows.forEach(flow => {
                const sourceNode = nodeMap.get(flow.source);
                if (sourceNode.value === 0) {
                    const outflows = flowData.flows.filter(f => f.source === flow.source);
                    sourceNode.value = outflows.reduce((sum, f) => sum + f.value, 0);
                }
            });
            
            return {
                metadata: {
                    ...flowData.metadata
                },
                nodes: Array.from(nodeMap.values()),
                links: links
            };
        }

        function updateAllStats() {
            const nodeMap = new Map();
            
            flowData.flows.forEach(flow => {
                nodeMap.set(flow.source, flow.sourceLayer);
                nodeMap.set(flow.target, flow.targetLayer);
            });
            
            const flowCount = flowData.flows.length;
            const nodeCount = nodeMap.size;
            const layerCount = new Set(Array.from(nodeMap.values())).size;
            
            let balancedFlows = 0;
            flowData.flows.forEach(flow => {
                const isValid = flow.source && flow.target && flow.value > 0 && flow.sourceLayer < flow.targetLayer;
                if (isValid) balancedFlows++;
            });
            
            const balanceScore = flowCount > 0 ? Math.round((balancedFlows / flowCount) * 100) : 0;
            
            document.getElementById('flow-count').textContent = flowCount;
            document.getElementById('node-count').textContent = nodeCount;
            document.getElementById('layer-count').textContent = layerCount;
            document.getElementById('balance-score').textContent = balanceScore + '%';
        }

        function validateFlows() {
            const errors = [];
            const warnings = [];
            
            if (flowData.flows.length === 0) {
                errors.push('No flows defined');
            }
            
            flowData.flows.forEach((flow, index) => {
                if (!flow.source || !flow.target) {
                    errors.push(`Flow ${index + 1}: Missing source or target`);
                }
                
                if (flow.value <= 0) {
                    errors.push(`Flow ${index + 1}: Invalid value (${flow.value})`);
                }
                
                if (flow.sourceLayer >= flow.targetLayer) {
                    errors.push(`Flow ${index + 1}: Source layer (${flow.sourceLayer}) must be less than target layer (${flow.targetLayer})`);
                }
                
                if (flow.source === flow.target) {
                    errors.push(`Flow ${index + 1}: Source and target cannot be the same`);
                }
            });
            
            const flowSignatures = new Set();
            flowData.flows.forEach((flow, index) => {
                const signature = `${flow.source}->${flow.target}`;
                if (flowSignatures.has(signature)) {
                    warnings.push(`Flow ${index + 1}: Duplicate flow from ${flow.source} to ${flow.target}`);
                }
                flowSignatures.add(signature);
            });
            
            let message = '✅ Flow Validation Results\n\n';
            
            if (errors.length > 0) {
                message += '❌ Errors:\n' + errors.map(e => `• ${e}`).join('\n') + '\n\n';
            }
            
            if (warnings.length > 0) {
                message += '⚠️ Warnings:\n' + warnings.map(w => `• ${w}`).join('\n') + '\n\n';
            }
            
            if (errors.length === 0 && warnings.length === 0) {
                message += 'Perfect! All flows are valid.\n\n';
            }
            
            const balanceScore = document.getElementById('balance-score').textContent;
            message += `📊 Summary:\n• ${flowData.flows.length} flows\n• Balance Score: ${balanceScore}`;
            
            alert(message);
        }

        function exportToCSV() {
            let csv = 'Source,Target,Amount,Flow Type,Source Layer,Target Layer,Source Category,Target Category,Description\n';
            
            flowData.flows.forEach(flow => {
                csv += `"${flow.source}","${flow.target}",${flow.value},"${flow.flowType}",${flow.sourceLayer},${flow.targetLayer},"${flow.sourceCategory}","${flow.targetCategory}","${flow.description}"\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `${flowData.metadata.company.replace(/[^a-zA-Z0-9]/g, '').toLowerCase()}-flows.csv`;
            link.click();
            URL.revokeObjectURL(url);
        }

        function importFromCSV() {
            document.getElementById('csv-file-input').click();
        }

        function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                const content = e.target.result;
                
                if (file.name.endsWith('.json')) {
                    try {
                        const data = JSON.parse(content);
                        if (data.flows) {
                            flowData = data;
                        } else if (data.nodes && data.links) {
                            flowData.flows = convertFromNodesLinks(data);
                        }
                        renderFlowTable();
                        updateAllStats();
                        updateAllPreviews();
                        alert('✅ Successfully imported flows!');
                    } catch (error) {
                        alert('❌ Error parsing JSON: ' + error.message);
                    }
                } else if (file.name.endsWith('.csv')) {
                    parseCSVFlows(content);
                }
            };
            reader.readAsText(file);
        }

        function parseCSVFlows(csvContent) {
            const lines = csvContent.split('\n').filter(line => line.trim());
            if (lines.length < 2) {
                alert('❌ CSV file must have header and at least one data row');
                return;
            }
            
            const flows = [];
            
            for (let i = 1; i < lines.length; i++) {
                const values = parseCSVLine(lines[i]);
                if (values.length >= 9) {
                    flows.push(new BusinessFlow({
                        source: values[0],
                        target: values[1],
                        value: parseFloat(values[2]) || 0,
                        flowType: values[3] || 'revenue_flow',
                        sourceLayer: parseInt(values[4]) || 0,
                        targetLayer: parseInt(values[5]) || 1,
                        sourceCategory: values[6] || 'revenue',
                        targetCategory: values[7] || 'revenue',
                        description: values[8] || ''
                    }));
                }
            }
            
            if (flows.length > 0) {
                flowData.flows = flows;
                renderFlowTable();
                updateAllStats();
                updateAllPreviews();
                alert(`✅ Successfully imported ${flows.length} flows from CSV!`);
            } else {
                alert('❌ No valid flows found in CSV file');
            }
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current.trim());
            return result.map(field => field.replace(/^"|"$/g, ''));
        }

        function generateChart() {
            const sankeyData = generateNodesAndLinksFromFlows();
            
            if (sankeyData.nodes.length === 0) {
                alert('❌ No nodes generated. Please add flows first.');
                return;
            }
            
            const urlParams = new URLSearchParams(window.location.search);
            const chartType = urlParams.get('chartType') || 'sankey';
            const returnTo = urlParams.get('returnTo');
            
            if (returnTo === 'guided') {
                const dataString = encodeURIComponent(JSON.stringify(sankeyData));
                window.location.href = `guided.html?step=3&chartType=${chartType}&data=${dataString}&dataInput=template`;
            } else {
                const dataString = encodeURIComponent(JSON.stringify(sankeyData));
                window.location.href = `chart.html?chartType=${chartType}&data=${dataString}`;
            }
        }

        // Preview Panel Functions
        function togglePreviewPanel() {
            const container = document.querySelector('.template-container');
            const icon = document.getElementById('preview-toggle-icon');
            
            container.classList.toggle('preview-hidden');
            
            if (container.classList.contains('preview-hidden')) {
                icon.textContent = '▶';
            } else {
                icon.textContent = '◀';
            }
        }

        function switchTab(tabName) {
            currentTab = tabName;
            
            document.querySelectorAll('.preview-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');
            
            document.querySelectorAll('.tab-content').forEach(content => {
                content.style.display = 'none';
            });
            document.getElementById(`${tabName}-tab`).style.display = 'block';
            
            updateTabContent(tabName);
        }

        function updateTabContent(tabName) {
            switch (tabName) {
                case 'structure':
                    updateStructurePreview();
                    break;
                case 'json':
                    updateJsonPreview();
                    break;
                case 'validation':
                    updateValidationPreview();
                    break;
            }
        }

        function updateStructurePreview() {
            const preview = document.getElementById('structure-preview');
            const sankeyData = generateNodesAndLinksFromFlows();
            
            let html = '<h4>📊 Generated Structure</h4>';
            
            const layerMap = new Map();
            sankeyData.nodes.forEach(node => {
                if (!layerMap.has(node.depth)) {
                    layerMap.set(node.depth, []);
                }
                layerMap.get(node.depth).push(node);
            });
            
            const sortedLayers = Array.from(layerMap.entries()).sort((a, b) => a[0] - b[0]);
            
            sortedLayers.forEach(([depth, nodes]) => {
                const totalValue = nodes.reduce((sum, n) => sum + (n.value || 0), 0);
                const categories = [...new Set(nodes.map(n => n.category))];
                
                html += `
                    <div class="layer-item">
                        <strong>Layer ${depth}</strong> (${nodes.length} nodes, $${totalValue}M)<br>
                        Categories: ${categories.join(', ')}<br>
                        Nodes: ${nodes.map(n => n.id).join(', ')}
                    </div>
                `;
            });
            
            html += '<h4 style="margin-top: 20px;">💰 Business Flows</h4>';
            if (flowData.flows.length === 0) {
                html += '<div style="color: #f59e0b;">No flows defined</div>';
            } else {
                flowData.flows.slice(0, 10).forEach(flow => {
                    const isValid = flow.source && flow.target && flow.value > 0 && flow.sourceLayer < flow.targetLayer;
                    
                    html += `
                        <div style="margin: 4px 0; padding: 4px 8px; background: ${isValid ? '#374151' : '#7f1d1d'}; border-radius: 4px;">
                            ${flow.source} → ${flow.target} ($${flow.value}M)
                            ${!isValid ? ' <span style="color: #ef4444;">[INVALID]</span>' : ''}
                        </div>
                    `;
                });
                
                if (flowData.flows.length > 10) {
                    html += `<div style="color: #6b7280; margin-top: 8px;">... and ${flowData.flows.length - 10} more flows</div>`;
                }
            }
            
            preview.innerHTML = html;
        }

        function updateJsonPreview() {
            const preview = document.getElementById('json-preview');
            const sankeyData = generateNodesAndLinksFromFlows();
            preview.textContent = JSON.stringify(sankeyData, null, 2);
        }

        function updateValidationPreview() {
            const preview = document.getElementById('validation-preview');
            
            const errors = [];
            const warnings = [];
            
            flowData.flows.forEach((flow, index) => {
                if (!flow.source || !flow.target) {
                    errors.push(`Flow ${index + 1}: Missing source or target`);
                }
                if (flow.value <= 0) {
                    errors.push(`Flow ${index + 1}: Invalid value`);
                }
                if (flow.sourceLayer >= flow.targetLayer) {
                    errors.push(`Flow ${index + 1}: Invalid layer sequence`);
                }
            });
            
            let html = '<h4>✅ Validation Results</h4>';
            
            if (errors.length === 0) {
                html += '<div style="color: #059669; margin: 8px 0;">All flows are valid!</div>';
            } else {
                html += '<div style="color: #dc2626; margin: 8px 0;">Issues found:</div>';
                errors.forEach(error => {
                    html += `<div style="color: #dc2626; font-size: 12px; margin: 2px 0;">• ${error}</div>`;
                });
            }
            
            preview.innerHTML = html;
        }

        function updateAllPreviews() {
            updateTabContent(currentTab);
            updateJsonStats();
        }

        function updateJsonStats() {
            const stats = document.getElementById('json-stats');
            const sankeyData = generateNodesAndLinksFromFlows();
            
            const flowCount = flowData.flows.length;
            const nodeCount = sankeyData.nodes.length;
            const linkCount = sankeyData.links.length;
            const layerCount = new Set(sankeyData.nodes.map(n => n.depth)).size;
            
            stats.textContent = `Flows: ${flowCount} | Nodes: ${nodeCount} | Links: ${linkCount} | Layers: ${layerCount}`;
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadCompleteTemplate();
        });
    </script>
</body>
</html>
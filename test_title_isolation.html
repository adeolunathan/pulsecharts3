<!DOCTYPE html>
<html>
<head>
    <title>Test Title Control Isolation</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
</head>
<body>
    <h1>Title Control Isolation Test</h1>
    <div id="test-area"></div>
    <div id="controls">
        <button onclick="testTitleFont()">Test Title Font Change</button>
        <button onclick="testTitleSize()">Test Title Size Change</button>
        <button onclick="testTitleColor()">Test Title Color Change</button>
        <button onclick="checkNodeContamination()">Check Node Contamination</button>
    </div>
    <div id="results"></div>

    <script src="js/utils/TitleControlIsolation.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Create a mock chart with SVG and title/node elements
            const testArea = document.getElementById('test-area');
            
            const svg = d3.select(testArea)
                .append('svg')
                .attr('width', 800)
                .attr('height', 400);
            
            // Add chart title
            svg.append('text')
                .attr('class', 'main-chart-title')
                .attr('x', 400)
                .attr('y', 50)
                .attr('text-anchor', 'middle')
                .attr('font-size', '24px')
                .attr('font-family', 'Arial')
                .attr('fill', '#000000')
                .text('Test Chart Title');
            
            // Add mock node labels that should NOT be affected
            svg.append('text')
                .attr('class', 'sankey-node text')
                .attr('x', 100)
                .attr('y', 150)
                .attr('font-size', '14px')
                .attr('font-family', 'Arial')
                .attr('fill', '#333333')
                .text('Node Label 1');
                
            svg.append('text')
                .attr('class', 'node-label')
                .attr('x', 200)
                .attr('y', 200)
                .attr('font-size', '14px')
                .attr('font-family', 'Arial')
                .attr('fill', '#333333')
                .text('Node Label 2');
            
            // Mock chart object
            window.mockChart = {
                svg: svg,
                config: {
                    titleFont: 'Arial',
                    titleSize: 24,
                    titleColor: '#000000'
                }
            };
            
            console.log('Mock chart setup complete');
        });
        
        function testTitleFont() {
            console.log('Testing title font change...');
            if (window.TitleControlIsolation) {
                window.TitleControlIsolation.applyTitleFont(window.mockChart, 'Georgia');
                updateResults('Font test: Applied Georgia to title');
            } else {
                updateResults('Error: TitleControlIsolation not available');
            }
        }
        
        function testTitleSize() {
            console.log('Testing title size change...');
            if (window.TitleControlIsolation) {
                window.TitleControlIsolation.applyTitleSize(window.mockChart, 32);
                updateResults('Size test: Applied 32px to title');
            } else {
                updateResults('Error: TitleControlIsolation not available');
            }
        }
        
        function testTitleColor() {
            console.log('Testing title color change...');
            if (window.TitleControlIsolation) {
                window.TitleControlIsolation.applyTitleColor(window.mockChart, '#ff0000');
                updateResults('Color test: Applied red to title');
            } else {
                updateResults('Error: TitleControlIsolation not available');
            }
        }
        
        function checkNodeContamination() {
            console.log('Checking for node label contamination...');
            const nodeLabels = d3.selectAll('.sankey-node text, .node-label');
            let contaminated = false;
            
            nodeLabels.each(function() {
                const element = d3.select(this);
                const font = element.style('font-family');
                const size = element.style('font-size');
                const color = element.style('fill');
                
                if (font.includes('Georgia') || size === '32px' || color === 'rgb(255, 0, 0)') {
                    contaminated = true;
                    console.log('❌ Contamination detected in node:', this, 'font:', font, 'size:', size, 'color:', color);
                }
            });
            
            if (contaminated) {
                updateResults('❌ Node contamination detected! Title controls affected node labels.');
            } else {
                updateResults('✅ No contamination detected. Node labels remain unchanged.');
            }
        }
        
        function updateResults(message) {
            const results = document.getElementById('results');
            const timestamp = new Date().toLocaleTimeString();
            results.innerHTML += `<div style="margin: 5px 0; padding: 5px; border: 1px solid #ccc; border-radius: 3px;">[${timestamp}] ${message}</div>`;
        }
    </script>
</body>
</html>
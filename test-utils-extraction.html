<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Utils Extraction</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        .pass { background: #d4edda; color: #155724; }
        .fail { background: #f8d7da; color: #721c24; }
        #test-chart {
            width: 800px;
            height: 500px;
            border: 1px solid #ddd;
            margin: 10px 0;
        }
        .color-demo {
            padding: 10px;
            margin: 5px;
            border: 1px solid #ccc;
            display: inline-block;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <h1>Test ChartUtils Extraction</h1>
    <p>Testing that ChartUtils works as extracted utilities and SankeyChart still renders.</p>
    
    <div id="result" class="test-result">Testing...</div>
    
    <h2>ChartUtils Function Tests</h2>
    <div id="utils-test"></div>
    
    <h2>Chart Rendering Test</h2>
    <div id="test-chart"></div>

    <!-- Load Dependencies -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/d3-sankey@0.12.3/dist/d3-sankey.min.js"></script>
    
    <!-- Load Utilities and Chart -->
    <script src="js/utils/ChartUtils.js"></script>
    <script src="js/utils/ChartExports.js"></script>
    <script src="js/charts/sankey/SankeyChartConfig.js"></script>
    <script src="js/charts/sankey/SankeyChart.js"></script>

    <script>
        // Test data
        const testData = {
            "metadata": {
                "title": "Utils Test",
                "currency": "USD",
                "unit": "thousands"
            },
            "nodes": [
                {"id": "Revenue", "depth": 0, "value": 1000, "category": "revenue"},
                {"id": "Expenses", "depth": 1, "value": 600, "category": "expense"},
                {"id": "Profit", "depth": 2, "value": 400, "category": "profit"}
            ],
            "links": [
                {"source": "Revenue", "target": "Expenses", "value": 600},
                {"source": "Revenue", "target": "Profit", "value": 400}
            ]
        };

        try {
            // Test ChartUtils availability
            if (typeof ChartUtils === 'undefined') {
                throw new Error('ChartUtils not loaded');
            }
            
            console.log('ChartUtils available:', ChartUtils);
            
            // Test lightenColor function
            const originalColor = '#ff0000';
            const lightenedColor = ChartUtils.lightenColor(originalColor, 20);
            console.log('lightenColor test:', originalColor, '->', lightenedColor);
            
            if (!lightenedColor || lightenedColor === originalColor) {
                throw new Error('lightenColor function not working');
            }
            
            // Test hexToRgba function
            const rgbaColor = ChartUtils.hexToRgba(originalColor, 0.5);
            console.log('hexToRgba test:', originalColor, '->', rgbaColor);
            
            if (!rgbaColor || !rgbaColor.includes('rgba')) {
                throw new Error('hexToRgba function not working');
            }
            
            // Test wrapText function
            const longText = 'This is a very long piece of text that should be wrapped';
            const wrappedText = ChartUtils.wrapText(longText, 10);
            console.log('wrapText test:', longText, '->', wrappedText);
            
            if (!Array.isArray(wrappedText) || wrappedText.length === 0) {
                throw new Error('wrapText function not working');
            }
            
            // Display utility test results
            document.getElementById('utils-test').innerHTML = `
                <div class="color-demo" style="background-color: ${originalColor}">Original: ${originalColor}</div>
                <div class="color-demo" style="background-color: ${lightenedColor}">Lightened: ${lightenedColor}</div>
                <div class="color-demo" style="background-color: ${rgbaColor}">RGBA: ${rgbaColor}</div>
                <div>Wrapped text: ${wrappedText.join(' | ')}</div>
            `;
            
            // Test chart creation with external utilities
            const chart = new PulseSankeyChart('test-chart');
            
            // Test rendering
            chart.render(testData).then(() => {
                // Check if chart rendered properly
                const svg = document.querySelector('#test-chart svg');
                const nodes = svg ? svg.querySelectorAll('.sankey-node') : [];
                const links = svg ? svg.querySelectorAll('.sankey-link') : [];
                
                if (svg && nodes.length > 0 && links.length > 0) {
                    document.getElementById('result').className = 'test-result pass';
                    document.getElementById('result').textContent = 
                        `✅ SUCCESS: ChartUtils extraction works! Chart rendered with ${nodes.length} nodes and ${links.length} links. All utility functions working.`;
                } else {
                    throw new Error('Chart did not render properly');
                }
            }).catch(error => {
                document.getElementById('result').className = 'test-result fail';
                document.getElementById('result').textContent = `❌ RENDER FAILED: ${error.message}`;
            });
            
        } catch (error) {
            document.getElementById('result').className = 'test-result fail';
            document.getElementById('result').textContent = `❌ UTILS TEST FAILED: ${error.message}`;
        }
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pulse Analytics Platform</title>
    
    <!-- External Dependencies -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-sankey/0.12.3/d3-sankey.min.js"></script>
    
    <!-- Consolidated Application Styles -->
    <link rel="stylesheet" href="css/pulse-analytics.css">
    
    <style>
        .main-tabs {
            display: flex;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 0 20px;
        }
        
        .main-tab {
            background: transparent;
            border: none;
            color: rgba(255,255,255,0.7);
            padding: 16px 24px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
            border-bottom: 3px solid transparent;
        }
        
        .main-tab:hover {
            color: rgba(255,255,255,0.9);
            background: rgba(255,255,255,0.1);
        }
        
        .main-tab.active {
            color: white;
            border-bottom-color: #f59e0b;
            background: rgba(255,255,255,0.1);
        }
        
        .tab-content {
            display: none;
            min-height: calc(100vh - 140px);
        }
        
        .tab-content.active {
            display: block;
        }

        .realtime-controls {
            background: #f0f9ff;
            border: 1px solid #0ea5e9;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .realtime-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }

        .realtime-indicator.live {
            background-color: #ef4444;
        }

        .realtime-indicator.manual {
            background-color: #6b7280;
            animation: none;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        /* Flow Builder Styles */
        .flow-builder-container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
            background: #f8f9fa;
        }
        
        .flow-table-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            overflow: hidden;
            margin-bottom: 20px;
        }
        
        .flow-table-header {
            background: #f8f9fa;
            padding: 16px 20px;
            border-bottom: 1px solid #e1e5e9;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .flow-table-title {
            font-size: 16px;
            font-weight: 600;
            color: #1f2937;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .flow-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        
        .flow-table th {
            background: #f8f9fa;
            padding: 12px 8px;
            text-align: left;
            font-weight: 600;
            color: #374151;
            border-bottom: 2px solid #e1e5e9;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .flow-table td {
            padding: 8px;
            border-bottom: 1px solid #f1f3f4;
            vertical-align: middle;
        }
        
        .flow-table tr:hover {
            background: #f8f9fa;
        }
        
        .flow-input {
            width: 100%;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            padding: 6px 8px;
            font-size: 12px;
            background: white;
        }
        
        .flow-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
        }
        
        .flow-input.number {
            text-align: right;
        }
        
        .flow-select {
            width: 100%;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            padding: 6px 8px;
            font-size: 12px;
            background: white;
        }
        
        .remove-flow-btn {
            background: #ef4444;
            color: white;
            border: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .remove-flow-btn:hover {
            background: #dc2626;
        }
        
        .add-flow-btn {
            background: #10b981;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .add-flow-btn:hover {
            background: #059669;
        }
        
        .balance-indicator {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
        }
        
        .balance-indicator.balanced {
            background: #d1fae5;
            color: #065f46;
        }
        
        .balance-indicator.unbalanced {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .stats-bar {
            background: #e7f3ff;
            border: 1px solid #0ea5e9;
            border-radius: 6px;
            padding: 12px 16px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
        }
        
        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }
        
        .stat-value {
            font-size: 16px;
            font-weight: 600;
            color: #0369a1;
        }
        
        .stat-label {
            color: #6b7280;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .color-palette-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            overflow: hidden;
            margin-bottom: 20px;
        }
        
        .color-palette-header {
            background: #f8f9fa;
            padding: 16px 20px;
            border-bottom: 1px solid #e1e5e9;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .color-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
            padding: 20px;
        }
        
        .color-control {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .color-label {
            font-size: 12px;
            font-weight: 500;
            color: #374151;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .color-input-container {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .color-picker {
            width: 60px;
            height: 32px;
            border: 2px solid #d1d5db;
            border-radius: 6px;
            cursor: pointer;
            background: none;
            padding: 0;
        }
        
        .color-picker:hover {
            border-color: #667eea;
        }
        
        .color-presets {
            display: flex;
            gap: 8px;
        }
        
        .preset-btn {
            padding: 6px 12px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            background: white;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
        }
        
        .preset-btn:hover {
            background: #f3f4f6;
            border-color: #667eea;
        }
        
        .template-actions {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
        }
        
        .template-btn {
            background: #f8f9fa;
            border: 1px solid #d1d5db;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
        }
        
        .template-btn:hover {
            background: #e5e7eb;
        }
    </style>
</head>
<body>
    <div class="pulse-app">
        <!-- Application Header -->
        <header class="app-header">
            <h1>Pulse Analytics Platform</h1>
            <div class="header-controls">
                <div class="data-selector">
                    <label for="data-select" style="color: white; margin-right: 8px;">Data:</label>
                    <select id="data-select">
                        <option value="saas">SaaS Company (Sample)</option>
                        <option value="manufacturing">Manufacturing Corp</option>
                        <option value="retail">Retail Chain</option>
                        <option value="custom">üìÅ Load Custom Data...</option>
                    </select>
                </div>
                <div class="chart-selector">
                    <label for="chart-type-select" style="color: white; margin-right: 8px;">Chart:</label>
                    <select id="chart-type-select">
                        <option value="sankey">üåä Sankey Flow</option>
                        <option value="bar">üìä Bar Chart</option>
                        <option value="line">üìà Line Chart</option>
                    </select>
                </div>
            </div>
        </header>

        <!-- Main Tabs Navigation -->
        <div class="main-tabs">
            <button class="main-tab" onclick="switchMainTab('data-builder')">
                üí∞ Flow Builder
            </button>
            <button class="main-tab active" onclick="switchMainTab('chart-view')">
                üìä Chart View
            </button>
        </div>

        <!-- Flow Builder Tab -->
        <div id="data-builder" class="tab-content">
            <div class="flow-builder-container">
                <!-- Real-time Controls -->
                <div class="realtime-controls">
                    <h4 style="margin: 0 0 10px 0; color: #0369a1;">
                        <span id="realtime-indicator" class="realtime-indicator live"></span>
                        Live Update Mode
                    </h4>
                    <div style="display: flex; gap: 12px; align-items: center;">
                        <button id="realtime-toggle" class="btn btn-secondary" onclick="toggleRealTimeMode()">
                            ‚ö™ Disable Live Updates
                        </button>
                        <div style="font-size: 12px; color: #6b7280;">
                            <strong>Manual:</strong> Changes apply when you click "Apply Changes"<br>
                            <strong>Live:</strong> Changes apply automatically as you type (500ms delay)
                        </div>
                    </div>
                </div>

                <!-- Quick Stats -->
                <div class="stats-bar">
                    <div class="stat-item">
                        <div class="stat-value" id="flow-count">0</div>
                        <div class="stat-label">Business Flows</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="node-count">0</div>
                        <div class="stat-label">Generated Nodes</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="layer-count">0</div>
                        <div class="stat-label">Layers</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="balance-score">0%</div>
                        <div class="stat-label">Balance Score</div>
                    </div>
                </div>

                <!-- Template Quick Actions -->
                <div class="template-actions">
                    <button class="template-btn" onclick="loadCurrentChartData()">üìä Load Chart Data</button>
                    <button class="template-btn" onclick="loadCompleteTemplate()">üìã Complete Template</button>
                    <button class="template-btn" onclick="loadBlankFlows()">üìÑ Blank Template</button>
                    <button class="template-btn" onclick="exportFlowsToCSV()">üìÑ Export CSV</button>
                    <button class="template-btn" onclick="importFlowsFromCSV()">üìÇ Import CSV</button>
                </div>

                <!-- Color Palette Controls -->
                <div class="color-palette-container">
                    <div class="color-palette-header">
                        <h3 class="flow-table-title">üé® Color Palette</h3>
                        <div class="color-presets">
                            <button class="preset-btn" onclick="applyColorPreset('professional')">Professional</button>
                            <button class="preset-btn" onclick="applyColorPreset('vibrant')">Vibrant</button>
                            <button class="preset-btn" onclick="applyColorPreset('monochrome')">Monochrome</button>
                            <button class="preset-btn" onclick="resetColors()">Reset</button>
                        </div>
                    </div>
                    <div class="color-grid">
                        <div class="color-control">
                            <label class="color-label">Revenue</label>
                            <div class="color-input-container">
                                <input type="color" class="color-picker" id="revenue-color" value="#3498db" onchange="updateColor('revenue', this.value)">
                            </div>
                        </div>
                        <div class="color-control">
                            <label class="color-label">Cost</label>
                            <div class="color-input-container">
                                <input type="color" class="color-picker" id="cost-color" value="#e74c3c" onchange="updateColor('cost', this.value)">
                            </div>
                        </div>
                        <div class="color-control">
                            <label class="color-label">Profit</label>
                            <div class="color-input-container">
                                <input type="color" class="color-picker" id="profit-color" value="#27ae60" onchange="updateColor('profit', this.value)">
                            </div>
                        </div>
                        <div class="color-control">
                            <label class="color-label">Expense</label>
                            <div class="color-input-container">
                                <input type="color" class="color-picker" id="expense-color" value="#e67e22" onchange="updateColor('expense', this.value)">
                            </div>
                        </div>
                        <div class="color-control">
                            <label class="color-label">Income</label>
                            <div class="color-input-container">
                                <input type="color" class="color-picker" id="income-color" value="#9b59b6" onchange="updateColor('income', this.value)">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Company Information -->
                <div class="flow-table-container">
                    <div class="flow-table-header">
                        <h3 class="flow-table-title">üè¢ Company Information</h3>
                    </div>
                    <div style="padding: 20px;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                            <div>
                                <label style="display: block; font-size: 12px; font-weight: 500; color: #374151; margin-bottom: 4px;">Company Name</label>
                                <input type="text" class="flow-input" id="company-name" value="TechFlow Corporation" onchange="updateMetadata()">
                            </div>
                            <div>
                                <label style="display: block; font-size: 12px; font-weight: 500; color: #374151; margin-bottom: 4px;">Period</label>
                                <input type="text" class="flow-input" id="period" value="Q3 2025" onchange="updateMetadata()">
                            </div>
                            <div>
                                <label style="display: block; font-size: 12px; font-weight: 500; color: #374151; margin-bottom: 4px;">Currency</label>
                                <select class="flow-select" id="currency" onchange="updateMetadata()">
                                    <option value="USD">USD ($)</option>
                                    <option value="EUR">EUR (‚Ç¨)</option>
                                    <option value="GBP">GBP (¬£)</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; font-size: 12px; font-weight: 500; color: #374151; margin-bottom: 4px;">Units</label>
                                <select class="flow-select" id="units" onchange="updateMetadata()">
                                    <option value="millions">Millions</option>
                                    <option value="billions">Billions</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Business Flows Table -->
                <div class="flow-table-container">
                    <div class="flow-table-header">
                        <h3 class="flow-table-title">
                            üí∞ Business Flows
                            <span style="background: #e7f3ff; color: #0369a1; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: 500;">Live Updates</span>
                        </h3>
                        <div>
                            <button class="add-flow-btn" onclick="addFlow()">+ Add Flow</button>
                        </div>
                    </div>
                    <div style="overflow-x: auto;">
                        <table class="flow-table">
                            <thead>
                                <tr>
                                    <th style="width: 30px;"></th>
                                    <th style="width: 180px;">From (Source)</th>
                                    <th style="width: 180px;">To (Target)</th>
                                    <th style="width: 80px;">Amount</th>
                                    <th style="width: 70px;">Src Layer</th>
                                    <th style="width: 70px;">Tgt Layer</th>
                                    <th style="width: 100px;">Flow Type</th>
                                    <th style="width: 90px;">Source Cat</th>
                                    <th style="width: 90px;">Target Cat</th>
                                    <th style="width: 200px;">Description</th>
                                    <th style="width: 50px;">‚úì</th>
                                </tr>
                            </thead>
                            <tbody id="flows-tbody">
                                <!-- Flows will be dynamically generated -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="applyFlowChanges()">üöÄ Apply Changes</button>
                    <button class="btn btn-secondary" onclick="validateFlows()">‚úÖ Validate</button>
                    <button class="btn btn-secondary" onclick="resetToChartData()">üîÑ Reset to Chart</button>
                </div>
            </div>
        </div>

        <!-- Chart View Tab (Original) -->
        <div id="chart-view" class="tab-content active">
            <div class="app-content">
                <!-- Chart Area -->
                <div class="chart-area">
                    <!-- Chart Toolbar -->
                    <div class="chart-toolbar">
                        <div class="data-controls">
                            <span id="data-status" class="status-indicator status-loading">Loading...</span>
                        </div>
                        
                        <div class="export-controls">
                            <button id="export-png" class="btn btn-primary">üñºÔ∏è PNG</button>
                            <button id="export-svg" class="btn btn-primary">üìê SVG</button>
                            <button id="export-data" class="btn btn-primary">üìä CSV</button>
                        </div>
                    </div>
                    
                    <!-- Chart Container -->
                    <div id="main-chart" class="chart-container">
                        <div class="chart-loading">
                            <div class="loading-spinner"></div>
                            <p>Initializing Pulse Analytics Platform...</p>
                        </div>
                    </div>
                </div>

                <!-- Enhanced Control Panel -->
                <div class="control-panel">
                    <div class="control-panel-header">
                        <h3>Chart Controls</h3>
                        <button id="reset-defaults" class="btn btn-outline">üîÑ Reset</button>
                    </div>
                    
                    <div id="dynamic-controls" class="control-panel-content">
                        <div style="padding: 40px 20px; text-align: center; color: #6b7280;">
                            <div style="font-size: 24px; margin-bottom: 8px;">‚öôÔ∏è</div>
                            <p>Loading chart controls...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden file input -->
    <input type="file" id="file-input" style="display: none;" accept=".json">
    <input type="file" id="csv-file-input" style="display: none;" accept=".csv,.json">

    <!-- Core Scripts -->
    <script src="js/core/DataManager.js"></script>
    <script src="js/core/ControlPanel.js"></script>
    <script src="js/charts/sankey/SankeyChart.js"></script>
    <script src="js/charts/sankey/SankeyControls.js"></script>
    
    <!-- Enhanced app.js -->
    <script src="js/app.js"></script>
    
    <!-- Data Bridge Integration -->
    <script>
        window.PulseDataBridge = {
            currentData: null,
            chartInstance: null,
            isInitialized: false,
            realTimeMode: true,
            appReadyCallbacks: [],
            
            init() {
                this.isInitialized = true;
                console.log('üåâ Real-time Data Bridge initialized');
                
                this.waitForAppReady().then(() => {
                    this.setupEventListeners();
                });
            },
            
            onAppReady(callback) {
                if (window.pulseApp) {
                    callback();
                } else {
                    this.appReadyCallbacks.push(callback);
                }
            },
            
            setData(data, source = 'unknown') {
                this.currentData = data;
                console.log(`üìä Data updated from ${source}:`, data);
                this.notifyDataChanged(source);
            },
            
            getData() {
                if (this.currentData) {
                    return this.currentData;
                }
                
                if (window.pulseApp?.getCurrentData()) {
                    this.currentData = window.pulseApp.getCurrentData();
                    return this.currentData;
                }
                
                if (window.pulseApp?.getCurrentChart()?.data) {
                    this.currentData = window.pulseApp.getCurrentChart().data;
                    return this.currentData;
                }
                
                return null;
            },
            
            setChartInstance(chart) {
                this.chartInstance = chart;
                console.log('üìà Chart instance registered');
            },
            
            setRealTimeMode(enabled) {
                this.realTimeMode = enabled;
                console.log(`üîÑ Real-time mode ${enabled ? 'ENABLED' : 'DISABLED'}`);
                this.updateRealTimeIndicator();
            },
            
            notifyDataChanged(source) {
                console.log(`üîÑ Broadcasting data change from ${source}`);
                
                if (this.chartInstance && this.currentData && source !== 'chart-update') {
                    console.log('üé® Updating chart with new data');
                    this.chartInstance.render(this.currentData);
                }
                
                if (window.currentMainTab === 'data-builder') {
                    this.refreshFlowBuilder();
                }
                
                if (window.pulseApp && source !== 'app' && source !== 'app-initial') {
                    window.pulseApp.currentData = this.currentData;
                }
                
                window.dispatchEvent(new CustomEvent('pulseDataChanged', {
                    detail: { data: this.currentData, source }
                }));
            },
            
            refreshFlowBuilder() {
                console.log('üîß Refreshing Flow Builder...');
                
                const data = this.getData();
                if (data && data.nodes && data.links) {
                    console.log('‚úÖ Found data for Flow Builder refresh:', data);
                    window.flowData = convertSankeyDataToFlows(data);
                    
                    if (typeof renderFlowTable === 'function') {
                        renderFlowTable();
                        updateAllStats();
                        console.log('‚úÖ Flow Builder refreshed successfully');
                    }
                } else {
                    console.warn('‚ö†Ô∏è No data available for Flow Builder refresh');
                }
            },
            
            updateRealTimeIndicator() {
                const indicator = document.getElementById('realtime-indicator');
                const button = document.getElementById('realtime-toggle');
                
                if (indicator && button) {
                    if (this.realTimeMode) {
                        indicator.className = 'realtime-indicator live';
                        button.textContent = '‚ö™ Disable Live Updates';
                        button.className = 'btn btn-secondary';
                    } else {
                        indicator.className = 'realtime-indicator manual';
                        button.textContent = 'üî¥ Enable Live Updates';
                        button.className = 'btn btn-primary';
                    }
                }
            },
            
            applyImmediateChange(newData) {
                if (this.realTimeMode) {
                    console.log('‚ö° Applying immediate change in real-time mode');
                    this.setData(newData, 'flow-builder-realtime');
                }
            },
            
            applyFlowBuilderChanges(newData) {
                console.log('‚úÖ Applying Flow Builder changes:', newData);
                this.setData(newData, 'flow-builder');
            },
            
            setupEventListeners() {
                window.addEventListener('pulseTabSwitch', (e) => {
                    this.handleTabSwitch(e.detail.tabName);
                });
            },
            
            async waitForAppReady() {
                const maxAttempts = 100;
                const checkInterval = 100;
                let attempts = 0;
                
                return new Promise((resolve, reject) => {
                    const checkApp = () => {
                        attempts++;
                        
                        if (window.pulseApp && window.pulseApp.chart) {
                            console.log('‚úÖ Main app found and ready, hooking into data flow');
                            this.hookIntoApp();
                            
                            this.appReadyCallbacks.forEach(callback => callback());
                            this.appReadyCallbacks = [];
                            
                            resolve();
                            return;
                        }
                        
                        if (attempts >= maxAttempts) {
                            console.warn('‚ö†Ô∏è Main app not found after maximum attempts');
                            resolve();
                            return;
                        }
                        
                        setTimeout(checkApp, checkInterval);
                    };
                    
                    checkApp();
                });
            },
            
            hookIntoApp() {
                const app = window.pulseApp;
                if (!app) return;
                
                const originalLoadDataset = app.loadDataset.bind(app);
                app.loadDataset = async function(datasetKey) {
                    const result = await originalLoadDataset(datasetKey);
                    window.PulseDataBridge.setData(result, `dataset-${datasetKey}`);
                    return result;
                };
                
                if (app.chart) {
                    this.setChartInstance(app.chart);
                }
                
                const initialData = app.getCurrentData();
                if (initialData) {
                    this.setData(initialData, 'app-initial');
                }
                
                console.log('üîó Successfully hooked into main app');
            },
            
            handleTabSwitch(tabName) {
                console.log(`üîÑ Tab switched to: ${tabName}`);
                
                if (tabName === 'data-builder') {
                    if (!this.currentData && window.pulseApp) {
                        const appData = window.pulseApp.getCurrentData();
                        if (appData) {
                            this.currentData = appData;
                            console.log('üìä Retrieved data from app for flow builder');
                        }
                    }
                    
                    setTimeout(() => {
                        this.refreshFlowBuilder();
                    }, 50);
                } else if (tabName === 'chart-view') {
                    const data = this.getData();
                    if (data && this.chartInstance) {
                        this.chartInstance.render(data);
                    }
                }
            }
        };

        window.PulseDataBridge.init();
    </script>
    
    <!-- Flow Builder Implementation -->
    <script>
        let currentMainTab = 'chart-view';
        let flowData = {
            metadata: {
                title: "Financial Flow",
                subtitle: "Current Data", 
                currency: "USD",
                unit: "millions",
                company: "Your Company",
                period: "Current Period"
            },
            flows: []
        };

        let colorPalette = {
            revenue: '#3498db',
            cost: '#e74c3c',
            profit: '#27ae60',
            expense: '#e67e22',
            income: '#9b59b6'
        };

        let flowIdCounter = 0;

        // Flow structure definition
        class BusinessFlow {
            constructor(options = {}) {
                this.id = options.id || `flow_${++flowIdCounter}`;
                this.source = options.source || '';
                this.target = options.target || '';
                this.value = options.value || 0;
                this.flowType = options.flowType || 'revenue_flow';
                this.sourceLayer = options.sourceLayer || 0;
                this.targetLayer = options.targetLayer || 1;
                this.sourceOrder = options.sourceOrder || 1;
                this.targetOrder = options.targetOrder || 1;
                this.sourceCategory = options.sourceCategory || 'revenue';
                this.targetCategory = options.targetCategory || 'revenue';
                this.description = options.description || '';
            }
        }

        // Debounce function for real-time updates
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        const debouncedRealTimeUpdate = debounce(() => {
            if (window.PulseDataBridge.realTimeMode) {
                console.log('‚ö° Triggering debounced real-time update');
                const sankeyData = generateNodesAndLinksFromFlows();
                window.PulseDataBridge.applyImmediateChange(sankeyData);
            }
        }, 500);

        function toggleRealTimeMode() {
            const currentMode = window.PulseDataBridge.realTimeMode;
            const newMode = !currentMode;
            window.PulseDataBridge.setRealTimeMode(newMode);
            
            console.log(`üîÑ Real-time mode ${newMode ? 'ENABLED' : 'DISABLED'}`);
        }

        function switchMainTab(tabName) {
            console.log(`üéØ Switching to tab: ${tabName}`);
            
            document.querySelectorAll('.main-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            const targetTab = document.querySelector(`[onclick="switchMainTab('${tabName}')"]`);
            if (targetTab) {
                targetTab.classList.add('active');
            }
            
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            const targetContent = document.getElementById(tabName);
            if (targetContent) {
                targetContent.classList.add('active');
            }
            
            currentMainTab = tabName;
            
            window.dispatchEvent(new CustomEvent('pulseTabSwitch', {
                detail: { tabName }
            }));
            
            if (tabName === 'data-builder') {
                setTimeout(() => {
                    initializeFlowBuilder();
                }, 100);
            }
        }

        function initializeFlowBuilder() {
            console.log('üîß Initializing Flow Builder...');
            
            let data = null;
            
            if (window.PulseDataBridge && window.PulseDataBridge.currentData) {
                data = window.PulseDataBridge.currentData;
                console.log('üìä Found data from Data Bridge:', data);
            } else if (window.pulseApp && window.pulseApp.getCurrentData()) {
                data = window.pulseApp.getCurrentData();
                console.log('üìä Found data from pulseApp:', data);
                if (window.PulseDataBridge) {
                    window.PulseDataBridge.currentData = data;
                }
            }
            
            if (data && data.nodes && data.links) {
                console.log('‚úÖ Successfully found data for Flow Builder');
                
                flowData = convertSankeyDataToFlows(data);
                updateMetadataInputs();
                renderFlowTable();
                updateAllStats();
                
                if (!window.PulseDataBridge.realTimeMode) {
                    toggleRealTimeMode();
                }
                
                console.log('‚úÖ Flow Builder initialized with live data');
            } else {
                console.log('‚ö†Ô∏è No data found - Flow Builder ready for manual input');
            }
        }

        function convertSankeyDataToFlows(sankeyData) {
            const flows = [];
            
            sankeyData.links.forEach((link, index) => {
                const sourceNode = sankeyData.nodes.find(n => n.id === link.source);
                const targetNode = sankeyData.nodes.find(n => n.id === link.target);
                
                if (sourceNode && targetNode) {
                    flows.push(new BusinessFlow({
                        source: link.source,
                        target: link.target,
                        value: link.value,
                        flowType: link.type || 'revenue_flow',
                        sourceLayer: sourceNode.depth,
                        targetLayer: targetNode.depth,
                        sourceCategory: sourceNode.category,
                        targetCategory: targetNode.category,
                        description: link.description || targetNode.description || ''
                    }));
                }
            });
            
            return {
                metadata: {
                    title: sankeyData.metadata?.title || "Financial Flow",
                    subtitle: sankeyData.metadata?.subtitle || "Live Chart Data",
                    currency: sankeyData.metadata?.currency || "USD",
                    unit: sankeyData.metadata?.unit || "millions",
                    company: sankeyData.metadata?.company || "Your Company",
                    period: sankeyData.metadata?.period || "Current Period"
                },
                flows: flows
            };
        }

        function generateNodesAndLinksFromFlows() {
            const nodeMap = new Map();
            const links = [];
            
            flowData.flows.forEach(flow => {
                if (!nodeMap.has(flow.source)) {
                    nodeMap.set(flow.source, {
                        id: flow.source,
                        depth: flow.sourceLayer,
                        value: 0,
                        category: flow.sourceCategory,
                        description: `Source: ${flow.description}`,
                        sort_order: flow.sourceOrder || 1
                    });
                }
                
                if (!nodeMap.has(flow.target)) {
                    nodeMap.set(flow.target, {
                        id: flow.target,
                        depth: flow.targetLayer,
                        value: 0,
                        category: flow.targetCategory,
                        description: `Target: ${flow.description}`,
                        sort_order: flow.targetOrder || 1
                    });
                }
                
                const targetNode = nodeMap.get(flow.target);
                targetNode.value += flow.value;
                
                links.push({
                    source: flow.source,
                    target: flow.target,
                    value: flow.value,
                    type: flow.flowType,
                    description: flow.description
                });
            });
            
            flowData.flows.forEach(flow => {
                const sourceNode = nodeMap.get(flow.source);
                if (sourceNode.value === 0) {
                    const outflows = flowData.flows.filter(f => f.source === flow.source);
                    sourceNode.value = outflows.reduce((sum, f) => sum + f.value, 0);
                }
            });
            
            return {
                metadata: {
                    ...flowData.metadata,
                    colorPalette: colorPalette
                },
                nodes: Array.from(nodeMap.values()),
                links: links
            };
        }

        function loadCurrentChartData() {
            const data = window.PulseDataBridge.getData();
            if (data) {
                flowData = convertSankeyDataToFlows(data);
                updateMetadataInputs();
                renderFlowTable();
                updateAllStats();
                
                alert('‚úÖ Successfully loaded current chart data for editing!');
            } else {
                alert('‚ùå No chart data available. Please load a dataset in Chart View first.');
            }
        }

        function loadCompleteTemplate() {
            flowData.metadata.company = "TechFlow Corporation";
            flowData.metadata.title = "TechFlow Financial Flow";
            flowData.metadata.subtitle = "Multi-Layer Business Model";
            
            flowData.flows = [
                new BusinessFlow({
                    source: "Subscription Revenue",
                    target: "Total Revenue",
                    value: 300,
                    flowType: "revenue_flow",
                    sourceLayer: 0,
                    targetLayer: 1,
                    sourceCategory: "revenue",
                    targetCategory: "revenue",
                    description: "Recurring subscription income"
                }),
                new BusinessFlow({
                    source: "Professional Services",
                    target: "Total Revenue",
                    value: 60,
                    flowType: "revenue_flow",
                    sourceLayer: 0,
                    targetLayer: 1,
                    sourceCategory: "revenue",
                    targetCategory: "revenue",
                    description: "Implementation and consulting"
                }),
                new BusinessFlow({
                    source: "Platform & Other",
                    target: "Total Revenue",
                    value: 135,
                    flowType: "revenue_flow",
                    sourceLayer: 0,
                    targetLayer: 1,
                    sourceCategory: "revenue",
                    targetCategory: "revenue",
                    description: "Platform fees and other revenue"
                }),
                new BusinessFlow({
                    source: "Total Revenue",
                    target: "Gross Profit",
                    value: 340,
                    flowType: "profit_flow",
                    sourceLayer: 1,
                    targetLayer: 2,
                    sourceCategory: "revenue",
                    targetCategory: "profit",
                    description: "Revenue after cost of revenue"
                }),
                new BusinessFlow({
                    source: "Total Revenue",
                    target: "Cost of Revenue",
                    value: 55,
                    flowType: "cost_flow",
                    sourceLayer: 1,
                    targetLayer: 2,
                    sourceCategory: "revenue",
                    targetCategory: "cost",
                    description: "Direct costs to deliver services"
                }),
                new BusinessFlow({
                    source: "Gross Profit",
                    target: "Operating Profit",
                    value: 65,
                    flowType: "profit_flow",
                    sourceLayer: 2,
                    targetLayer: 3,
                    sourceCategory: "profit",
                    targetCategory: "profit",
                    description: "Profit from core operations"
                }),
                new BusinessFlow({
                    source: "Gross Profit",
                    target: "Operating Expenses",
                    value: 155,
                    flowType: "expense_flow",
                    sourceLayer: 2,
                    targetLayer: 3,
                    sourceCategory: "profit",
                    targetCategory: "expense",
                    description: "Total operating expenses"
                }),
                new BusinessFlow({
                    source: "Operating Expenses",
                    target: "Sales & Marketing",
                    value: 85,
                    flowType: "expense_flow",
                    sourceLayer: 3,
                    targetLayer: 4,
                    sourceCategory: "expense",
                    targetCategory: "expense",
                    description: "Customer acquisition costs"
                }),
                new BusinessFlow({
                    source: "Operating Expenses",
                    target: "R&D",
                    value: 45,
                    flowType: "expense_flow",
                    sourceLayer: 3,
                    targetLayer: 4,
                    sourceCategory: "expense",
                    targetCategory: "expense",
                    description: "Research and development"
                }),
                new BusinessFlow({
                    source: "Operating Expenses",
                    target: "G&A",
                    value: 20,
                    flowType: "expense_flow",
                    sourceLayer: 3,
                    targetLayer: 4,
                    sourceCategory: "expense",
                    targetCategory: "expense",
                    description: "General and administrative"
                }),
                new BusinessFlow({
                    source: "Operating Profit",
                    target: "Net Income",
                    value: 50,
                    flowType: "final_flow",
                    sourceLayer: 3,
                    targetLayer: 4,
                    sourceCategory: "profit",
                    targetCategory: "income",
                    description: "Final net income"
                }),
                new BusinessFlow({
                    source: "Operating Profit",
                    target: "Tax Expense",
                    value: 12,
                    flowType: "expense_flow",
                    sourceLayer: 3,
                    targetLayer: 4,
                    sourceCategory: "profit",
                    targetCategory: "expense",
                    description: "Income tax expense"
                })
            ];
            
            document.getElementById('company-name').value = flowData.metadata.company;
            renderFlowTable();
            updateAllStats();
            debouncedRealTimeUpdate();
        }

        function loadBlankFlows() {
            if (confirm('This will clear all current flows. Continue?')) {
                flowData.flows = [
                    new BusinessFlow({
                        source: "Revenue Source",
                        target: "Total Revenue",
                        value: 100,
                        description: "Start building your flow here"
                    })
                ];
                
                renderFlowTable();
                updateAllStats();
                debouncedRealTimeUpdate();
            }
        }

        function resetToChartData() {
            const proceed = confirm('This will reset all your changes to match the current chart data. Continue?');
            if (proceed) {
                loadCurrentChartData();
            }
        }

        function updateMetadataInputs() {
            const fields = [
                { id: 'company-name', value: flowData.metadata.company },
                { id: 'period', value: flowData.metadata.period },
                { id: 'currency', value: flowData.metadata.currency },
                { id: 'units', value: flowData.metadata.unit }
            ];
            
            fields.forEach(({ id, value }) => {
                const element = document.getElementById(id);
                if (element && value) {
                    element.value = value;
                }
            });
        }

        function renderFlowTable() {
            const tbody = document.getElementById('flows-tbody');
            tbody.innerHTML = '';
            
            if (flowData.flows.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="11" style="text-align: center; padding: 40px; color: #6b7280;">
                            <div style="font-size: 16px; margin-bottom: 8px;">üí°</div>
                            <div>No flows defined. Click "Add Flow" to start building your financial structure.</div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            flowData.flows.forEach((flow, index) => {
                const row = createFlowRow(flow, index);
                tbody.appendChild(row);
            });
        }

        function createFlowRow(flow, index) {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>
                    <button class="remove-flow-btn" onclick="removeFlow(${index})" title="Remove Flow">√ó</button>
                </td>
                <td>
                    <input type="text" class="flow-input" value="${flow.source}" 
                           onchange="updateFlow(${index}, 'source', this.value)">
                </td>
                <td>
                    <input type="text" class="flow-input" value="${flow.target}" 
                           onchange="updateFlow(${index}, 'target', this.value)">
                </td>
                <td>
                    <input type="number" class="flow-input number" value="${flow.value}" 
                           onchange="updateFlow(${index}, 'value', parseFloat(this.value) || 0)">
                </td>
                <td>
                    <input type="number" class="flow-input number" value="${flow.sourceLayer}" min="0" max="20"
                           onchange="updateFlow(${index}, 'sourceLayer', parseInt(this.value) || 0)">
                </td>
                <td>
                    <input type="number" class="flow-input number" value="${flow.targetLayer}" min="0" max="20"
                           onchange="updateFlow(${index}, 'targetLayer', parseInt(this.value) || 0)">
                </td>
                <td>
                    <select class="flow-select" onchange="updateFlow(${index}, 'flowType', this.value)">
                        <option value="revenue_flow" ${flow.flowType === 'revenue_flow' ? 'selected' : ''}>Revenue</option>
                        <option value="cost_flow" ${flow.flowType === 'cost_flow' ? 'selected' : ''}>Cost</option>
                        <option value="profit_flow" ${flow.flowType === 'profit_flow' ? 'selected' : ''}>Profit</option>
                        <option value="expense_flow" ${flow.flowType === 'expense_flow' ? 'selected' : ''}>Expense</option>
                        <option value="final_flow" ${flow.flowType === 'final_flow' ? 'selected' : ''}>Final</option>
                    </select>
                </td>
                <td>
                    <select class="flow-select" onchange="updateFlow(${index}, 'sourceCategory', this.value)">
                        <option value="revenue" ${flow.sourceCategory === 'revenue' ? 'selected' : ''}>Revenue</option>
                        <option value="cost" ${flow.sourceCategory === 'cost' ? 'selected' : ''}>Cost</option>
                        <option value="profit" ${flow.sourceCategory === 'profit' ? 'selected' : ''}>Profit</option>
                        <option value="expense" ${flow.sourceCategory === 'expense' ? 'selected' : ''}>Expense</option>
                        <option value="income" ${flow.sourceCategory === 'income' ? 'selected' : ''}>Income</option>
                    </select>
                </td>
                <td>
                    <select class="flow-select" onchange="updateFlow(${index}, 'targetCategory', this.value)">
                        <option value="revenue" ${flow.targetCategory === 'revenue' ? 'selected' : ''}>Revenue</option>
                        <option value="cost" ${flow.targetCategory === 'cost' ? 'selected' : ''}>Cost</option>
                        <option value="profit" ${flow.targetCategory === 'profit' ? 'selected' : ''}>Profit</option>
                        <option value="expense" ${flow.targetCategory === 'expense' ? 'selected' : ''}>Expense</option>
                        <option value="income" ${flow.targetCategory === 'income' ? 'selected' : ''}>Income</option>
                    </select>
                </td>
                <td>
                    <input type="text" class="flow-input" value="${flow.description}" 
                           onchange="updateFlow(${index}, 'description', this.value)"
                           placeholder="Flow description">
                </td>
                <td>
                    ${getFlowBalanceIndicator(flow)}
                </td>
            `;
            return tr;
        }

        function getFlowBalanceIndicator(flow) {
            const isValid = flow.source && flow.target && flow.value > 0 && flow.sourceLayer < flow.targetLayer;
            return `<div class="balance-indicator ${isValid ? 'balanced' : 'unbalanced'}">${isValid ? '‚úì' : '‚ö†'}</div>`;
        }

        function addFlow() {
            const newFlow = new BusinessFlow({
                source: "New Source",
                target: "New Target",
                value: 100,
                sourceLayer: 0,
                targetLayer: 1
            });
            
            flowData.flows.push(newFlow);
            renderFlowTable();
            updateAllStats();
            debouncedRealTimeUpdate();
        }

        function removeFlow(index) {
            flowData.flows.splice(index, 1);
            renderFlowTable();
            updateAllStats();
            debouncedRealTimeUpdate();
        }

        function updateFlow(index, field, value) {
            if (flowData.flows[index]) {
                flowData.flows[index][field] = value;
                updateAllStats();
                debouncedRealTimeUpdate();
                
                const row = document.querySelectorAll('#flows-tbody tr')[index];
                if (row) {
                    const balanceCell = row.lastElementChild;
                    balanceCell.innerHTML = getFlowBalanceIndicator(flowData.flows[index]);
                }
            }
        }

        function updateMetadata() {
            flowData.metadata.company = document.getElementById('company-name').value;
            flowData.metadata.period = document.getElementById('period').value;
            flowData.metadata.currency = document.getElementById('currency').value;
            flowData.metadata.unit = document.getElementById('units').value;
            flowData.metadata.title = `${flowData.metadata.company} Financial Flow`;
            flowData.metadata.subtitle = `${flowData.metadata.period} Business Model`;
            
            debouncedRealTimeUpdate();
        }

        function updateAllStats() {
            const nodeMap = new Map();
            
            flowData.flows.forEach(flow => {
                nodeMap.set(flow.source, flow.sourceLayer);
                nodeMap.set(flow.target, flow.targetLayer);
            });
            
            const flowCount = flowData.flows.length;
            const nodeCount = nodeMap.size;
            const layerCount = new Set(Array.from(nodeMap.values())).size;
            
            let balancedFlows = 0;
            flowData.flows.forEach(flow => {
                const isValid = flow.source && flow.target && flow.value > 0 && flow.sourceLayer < flow.targetLayer;
                if (isValid) balancedFlows++;
            });
            
            const balanceScore = flowCount > 0 ? Math.round((balancedFlows / flowCount) * 100) : 0;
            
            document.getElementById('flow-count').textContent = flowCount;
            document.getElementById('node-count').textContent = nodeCount;
            document.getElementById('layer-count').textContent = layerCount;
            document.getElementById('balance-score').textContent = balanceScore + '%';
        }

        function applyFlowChanges() {
            console.log('üöÄ Applying Flow Builder changes...');
            
            flowData.metadata.company = document.getElementById('company-name').value;
            flowData.metadata.period = document.getElementById('period').value;
            flowData.metadata.currency = document.getElementById('currency').value;
            flowData.metadata.unit = document.getElementById('units').value;
            flowData.metadata.title = `${flowData.metadata.company} Financial Flow`;
            
            const sankeyData = generateNodesAndLinksFromFlows();
            window.PulseDataBridge.applyFlowBuilderChanges(sankeyData);
            
            switchMainTab('chart-view');
            
            console.log('‚úÖ Changes applied and switched to Chart View');
        }

        function validateFlows() {
            const errors = [];
            const warnings = [];
            
            if (flowData.flows.length === 0) {
                errors.push('No flows defined');
            }
            
            flowData.flows.forEach((flow, index) => {
                if (!flow.source || !flow.target) {
                    errors.push(`Flow ${index + 1}: Missing source or target`);
                }
                
                if (flow.value <= 0) {
                    errors.push(`Flow ${index + 1}: Invalid value (${flow.value})`);
                }
                
                if (flow.sourceLayer >= flow.targetLayer) {
                    errors.push(`Flow ${index + 1}: Source layer must be less than target layer`);
                }
                
                if (flow.source === flow.target) {
                    errors.push(`Flow ${index + 1}: Source and target cannot be the same`);
                }
            });
            
            let message = '‚úÖ Flow Validation Results\n\n';
            
            if (errors.length > 0) {
                message += '‚ùå Errors:\n' + errors.map(e => `‚Ä¢ ${e}`).join('\n') + '\n\n';
            }
            
            if (warnings.length > 0) {
                message += '‚ö†Ô∏è Warnings:\n' + warnings.map(w => `‚Ä¢ ${w}`).join('\n') + '\n\n';
            }
            
            if (errors.length === 0 && warnings.length === 0) {
                message += 'Perfect! All flows are valid.\n\n';
            }
            
            const balanceScore = document.getElementById('balance-score').textContent;
            message += `üìä Summary:\n‚Ä¢ ${flowData.flows.length} flows\n‚Ä¢ Balance Score: ${balanceScore}`;
            
            alert(message);
        }

        function exportFlowsToCSV() {
            let csv = 'Source,Target,Amount,Flow Type,Source Layer,Target Layer,Source Category,Target Category,Description\n';
            
            flowData.flows.forEach(flow => {
                csv += `"${flow.source}","${flow.target}",${flow.value},"${flow.flowType}",${flow.sourceLayer},${flow.targetLayer},"${flow.sourceCategory}","${flow.targetCategory}","${flow.description}"\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `${flowData.metadata.company.replace(/[^a-zA-Z0-9]/g, '').toLowerCase()}-flows.csv`;
            link.click();
            URL.revokeObjectURL(url);
        }

        function importFlowsFromCSV() {
            document.getElementById('csv-file-input').click();
        }

        function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                const content = e.target.result;
                
                if (file.name.endsWith('.json')) {
                    try {
                        const data = JSON.parse(content);
                        if (data.flows) {
                            flowData = data;
                        } else if (data.nodes && data.links) {
                            flowData = convertSankeyDataToFlows(data);
                        }
                        renderFlowTable();
                        updateAllStats();
                        debouncedRealTimeUpdate();
                        alert('‚úÖ Successfully imported flows!');
                    } catch (error) {
                        alert('‚ùå Error parsing JSON: ' + error.message);
                    }
                } else if (file.name.endsWith('.csv')) {
                    parseCSVFlows(content);
                }
            };
            reader.readAsText(file);
        }

        function parseCSVFlows(csvContent) {
            const lines = csvContent.split('\n').filter(line => line.trim());
            if (lines.length < 2) {
                alert('‚ùå CSV file must have header and at least one data row');
                return;
            }
            
            const flows = [];
            
            for (let i = 1; i < lines.length; i++) {
                const values = parseCSVLine(lines[i]);
                if (values.length >= 9) {
                    flows.push(new BusinessFlow({
                        source: values[0],
                        target: values[1],
                        value: parseFloat(values[2]) || 0,
                        flowType: values[3] || 'revenue_flow',
                        sourceLayer: parseInt(values[4]) || 0,
                        targetLayer: parseInt(values[5]) || 1,
                        sourceCategory: values[6] || 'revenue',
                        targetCategory: values[7] || 'revenue',
                        description: values[8] || ''
                    }));
                }
            }
            
            if (flows.length > 0) {
                flowData.flows = flows;
                renderFlowTable();
                updateAllStats();
                debouncedRealTimeUpdate();
                alert(`‚úÖ Successfully imported ${flows.length} flows from CSV!`);
            } else {
                alert('‚ùå No valid flows found in CSV file');
            }
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current.trim());
            return result.map(field => field.replace(/^"|"$/g, ''));
        }

        function updateColor(category, color) {
            colorPalette[category] = color;
            debouncedRealTimeUpdate();
        }

        function applyColorPreset(presetName) {
            const presets = {
                professional: {
                    revenue: '#2c3e50',
                    cost: '#95a5a6',
                    profit: '#27ae60',
                    expense: '#e67e22',
                    income: '#3498db'
                },
                vibrant: {
                    revenue: '#ff6b6b',
                    cost: '#4ecdc4',
                    profit: '#45b7d1',
                    expense: '#f9ca24',
                    income: '#6c5ce7'
                },
                monochrome: {
                    revenue: '#2c3e50',
                    cost: '#7f8c8d',
                    profit: '#34495e',
                    expense: '#95a5a6',
                    income: '#2c3e50'
                }
            };

            if (presets[presetName]) {
                colorPalette = { ...presets[presetName] };
                updateColorInputs();
                debouncedRealTimeUpdate();
            }
        }

        function resetColors() {
            colorPalette = {
                revenue: '#3498db',
                cost: '#e74c3c',
                profit: '#27ae60',
                expense: '#e67e22',
                income: '#9b59b6'
            };
            updateColorInputs();
            debouncedRealTimeUpdate();
        }

        function updateColorInputs() {
            Object.entries(colorPalette).forEach(([category, color]) => {
                const colorInput = document.getElementById(`${category}-color`);
                if (colorInput) {
                    colorInput.value = color;
                }
            });
        }

        // Setup file import handler
        document.addEventListener('DOMContentLoaded', function() {
            const csvFileInput = document.getElementById('csv-file-input');
            if (csvFileInput) {
                csvFileInput.addEventListener('change', handleFileImport);
            }
            updateColorInputs();
        });
    </script>
</body>
</html>
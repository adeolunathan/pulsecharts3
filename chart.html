<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pulse Analytics Platform</title>
    
    <!-- External Dependencies -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-sankey/0.12.3/d3-sankey.min.js"></script>
    
    <!-- Consolidated Application Styles -->
    <link rel="stylesheet" href="css/pulse-analytics.css">
    
    <!-- Styles moved to css/pulse-analytics.css -->
</head>
<body>
    <div class="pulse-app">
        <!-- Application Header -->
        <header class="app-header">
            <h1>Pulse Analytics Platform</h1>
            <div class="header-controls">
                <div class="chart-selector">
                    <label for="chart-type-select" style="color: white; margin-right: 8px;">Chart:</label>
                    <select id="chart-type-select">
                        <option value="sankey">üåä Sankey Flow</option>
                        <option value="bar">üìä Bar Chart</option>
                        <option value="line">üìà Line Chart</option>
                    </select>
                </div>
            </div>
        </header>

        <!-- Main Tabs Navigation -->
        <div class="main-tabs">
            <button class="main-tab" onclick="switchMainTab('data-builder')">
                üí∞ Flow Builder
            </button>
            <button class="main-tab active" onclick="switchMainTab('chart-view')">
                üìä Chart View
            </button>
        </div>

        <!-- Flow Builder Tab -->
        <div id="data-builder" class="tab-content">
            <div class="flow-builder-container">
                <!-- Real-time Controls -->
                <div class="realtime-controls">
                    <h4 style="margin: 0 0 10px 0; color: #0369a1;">
                        <span id="realtime-indicator" class="realtime-indicator live"></span>
                        Live Update Mode
                    </h4>
                    <div style="display: flex; gap: 12px; align-items: center; margin-bottom: 12px;">
                        <button id="realtime-toggle" class="btn btn-secondary" onclick="toggleRealTimeMode()">
                            ‚ö™ Disable Live Updates
                        </button>
                        <div style="font-size: 12px; color: #6b7280;">
                            <strong>Manual:</strong> Changes apply when you click "Apply Changes"<br>
                            <strong>Live:</strong> Changes apply automatically as you type (500ms delay)
                        </div>
                    </div>
                    
                    <!-- Comparison Mode Toggle -->
                    <div style="display: flex; align-items: center; gap: 12px; padding-top: 12px; border-top: 1px solid #0ea5e9;">
                        <input type="checkbox" id="comparison-mode-toggle" onchange="toggleComparisonMode()" style="width: 16px; height: 16px;">
                        <label for="comparison-mode-toggle" style="font-weight: 600; color: #0369a1; font-size: 14px;">
                            üìà Period-over-Period Comparison
                        </label>
                        <div style="font-size: 11px; color: #6b7280;">
                            Shows variance % and trends
                        </div>
                    </div>
                </div>

                <!-- Quick Stats -->
                <div class="stats-bar">
                    <div class="stat-item">
                        <div class="stat-value" id="flow-count">0</div>
                        <div class="stat-label">Business Flows</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="node-count">0</div>
                        <div class="stat-label">Generated Nodes</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="layer-count">0</div>
                        <div class="stat-label">Layers</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="balance-score">0%</div>
                        <div class="stat-label">Balance Score</div>
                    </div>
                </div>

                <!-- Template Quick Actions -->
                <div class="template-actions">
                    <button class="template-btn" onclick="loadCurrentChartData()">üìä Load Chart Data</button>
                    <button class="template-btn" onclick="loadCompleteTemplate()">üìã Complete Template</button>
                    <button class="template-btn" onclick="loadBlankFlows()">üìÑ Blank Template</button>
                    <button class="template-btn" onclick="exportFlowsToCSV()">üìÑ Export CSV</button>
                    <button class="template-btn" onclick="importFlowsFromCSV()">üìÇ Import CSV</button>
                </div>

                <!-- Company Information Section -->
                <div class="collapsible-section">
                    <div class="collapsible-header" onclick="toggleSection('company')">
                        <h3 class="collapsible-title">üè¢ Company Information</h3>
                        <span class="collapsible-chevron">‚ñº</span>
                    </div>
                    <div class="collapsible-content" id="company-content">
                        <div style="padding: 20px;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                                <div>
                                    <label style="display: block; font-size: 12px; font-weight: 500; color: #374151; margin-bottom: 4px;">Company Name</label>
                                    <input type="text" class="flow-input" id="company-name" value="TechFlow Corporation" onchange="updateMetadata()">
                                </div>
                                <div>
                                    <label style="display: block; font-size: 12px; font-weight: 500; color: #374151; margin-bottom: 4px;">Period</label>
                                    <input type="text" class="flow-input" id="period" value="Q3 2025" onchange="updateMetadata()">
                                </div>
                                <div>
                                    <label style="display: block; font-size: 12px; font-weight: 500; color: #374151; margin-bottom: 4px;">Currency</label>
                                    <select class="flow-select" id="currency" onchange="updateMetadata()">
                                        <option value="USD">USD ($)</option>
                                        <option value="EUR">EUR (‚Ç¨)</option>
                                        <option value="GBP">GBP (¬£)</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="display: block; font-size: 12px; font-weight: 500; color: #374151; margin-bottom: 4px;">Units</label>
                                    <select class="flow-select" id="units" onchange="updateMetadata()">
                                        <option value="millions">Millions</option>
                                        <option value="billions">Billions</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Business Flows Section -->
                <div class="collapsible-section">
                    <div class="collapsible-header" onclick="toggleSection('flows')">
                        <h3 class="collapsible-title">
                            üí∞ Business Flows
                            <span style="background: #e7f3ff; color: #0369a1; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: 500;">Live Updates</span>
                        </h3>
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <button class="add-flow-btn" onclick="addFlow()">+ Add Flow</button>
                            <span class="collapsible-chevron">‚ñº</span>
                        </div>
                    </div>
                    <div class="collapsible-content" id="flows-content">
                        <div style="overflow-x: auto;">
                            <table class="flow-table">
                                <thead>
                                    <tr>
                                        <th style="width: 50px;">Actions</th>
                                        <th style="width: 180px;">From (Source)</th>
                                        <th style="width: 180px;">To (Target)</th>
                                        <th style="width: 80px;">Current Value</th>
                                        <th style="width: 80px;" id="previous-value-col">Previous Value</th>
                                        <th style="width: 70px;" id="variance-col">Variance</th>
                                        <th style="width: 70px;">Src Layer</th>
                                        <th style="width: 70px;">Tgt Layer</th>
                                        <th style="width: 100px;">Flow Type</th>
                                        <th style="width: 90px;">Source Cat</th>
                                        <th style="width: 90px;">Target Cat</th>
                                        <th style="width: 200px;">Description</th>
                                        <th style="width: 50px;">‚úì</th>
                                    </tr>
                                </thead>
                                <tbody id="flows-tbody">
                                    <!-- Flows will be dynamically generated -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="applyFlowChanges()">üöÄ Apply Changes</button>
                    <button class="btn btn-secondary" onclick="validateFlows()">‚úÖ Validate</button>
                    <button class="btn btn-secondary" onclick="resetToChartData()">üîÑ Reset to Chart</button>
                </div>
            </div>
        </div>

        <!-- Chart View Tab (Original) -->
        <div id="chart-view" class="tab-content active">
            <div class="app-content">
                <!-- Chart Area -->
                <div class="chart-area">
                    <!-- Chart Toolbar -->
                    <div class="chart-toolbar">
                        <div class="data-controls">
                            <span id="data-status" class="status-indicator status-loading">Loading...</span>
                        </div>
                        
                        <div class="export-controls">
                            <button id="export-png" class="btn btn-primary">üñºÔ∏è PNG</button>
                            <button id="export-svg" class="btn btn-primary">üìê SVG</button>
                            <button id="export-data" class="btn btn-primary">üìä CSV</button>
                        </div>
                    </div>
                    
                    <!-- Chart Container -->
                    <div id="main-chart" class="chart-container">
                        <div class="chart-loading">
                            <div class="loading-spinner"></div>
                            <p>Initializing Pulse Analytics Platform...</p>
                        </div>
                    </div>
                </div>

                <!-- Enhanced Control Panel -->
                <div class="control-panel">
                    <div class="control-panel-header">
                        <h3>Chart Controls</h3>
                        <button id="reset-defaults" class="btn btn-outline">üîÑ Reset</button>
                    </div>
                    
                    <div id="dynamic-controls" class="control-panel-content">
                        <div style="padding: 40px 20px; text-align: center; color: #6b7280;">
                            <div style="font-size: 24px; margin-bottom: 8px;">‚öôÔ∏è</div>
                            <p>Loading chart controls...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden file input -->
    <input type="file" id="file-input" style="display: none;" accept=".json">
    <input type="file" id="csv-file-input" style="display: none;" accept=".csv,.json">

    <!-- Core Scripts -->
    <script src="js/core/DataManager.js"></script>
    <script src="js/core/ControlPanel.js"></script>
    <script src="js/charts/sankey/SankeyChart.js"></script>
    <script src="js/charts/sankey/SankeyControls.js"></script>
    
    <!-- Enhanced app.js -->
    <script src="js/app.js"></script>
    
    <!-- Data Bridge Integration -->
    <script>
        window.PulseDataBridge = {
            currentData: null,
            chartInstance: null,
            isInitialized: false,
            realTimeMode: true,
            appReadyCallbacks: [],
            
            init() {
                this.isInitialized = true;
                console.log('üåâ Real-time Data Bridge initialized');
                
                this.waitForAppReady().then(() => {
                    this.setupEventListeners();
                });
            },
            
            onAppReady(callback) {
                if (window.pulseApp) {
                    callback();
                } else {
                    this.appReadyCallbacks.push(callback);
                }
            },
            
            setData(data, source = 'unknown') {
                this.currentData = data;
                console.log(`üìä Data updated from ${source}:`, data);
                this.notifyDataChanged(source);
            },
            
            getData() {
                if (this.currentData) {
                    return this.currentData;
                }
                
                if (window.pulseApp?.getCurrentData()) {
                    this.currentData = window.pulseApp.getCurrentData();
                    return this.currentData;
                }
                
                if (window.pulseApp?.getCurrentChart()?.data) {
                    this.currentData = window.pulseApp.getCurrentChart().data;
                    return this.currentData;
                }
                
                return null;
            },
            
            setChartInstance(chart) {
                this.chartInstance = chart;
                console.log('üìà Chart instance registered');
            },
            
            setRealTimeMode(enabled) {
                this.realTimeMode = enabled;
                console.log(`üîÑ Real-time mode ${enabled ? 'ENABLED' : 'DISABLED'}`);
                this.updateRealTimeIndicator();
            },
            
            notifyDataChanged(source) {
                console.log(`üîÑ Broadcasting data change from ${source}`);
                
                if (this.chartInstance && this.currentData && source !== 'chart-update') {
                    console.log('üé® Updating chart with new data');
                    this.chartInstance.render(this.currentData);
                }
                
                if (window.currentMainTab === 'data-builder') {
                    this.refreshFlowBuilder();
                }
                
                if (window.pulseApp && source !== 'app' && source !== 'app-initial') {
                    window.pulseApp.currentData = this.currentData;
                }
                
                window.dispatchEvent(new CustomEvent('pulseDataChanged', {
                    detail: { data: this.currentData, source }
                }));
            },
            
            refreshFlowBuilder() {
                console.log('üîß Refreshing Flow Builder...');
                
                const data = this.getData();
                if (data && data.nodes && data.links) {
                    console.log('‚úÖ Found data for Flow Builder refresh:', data);
                    window.flowData = convertSankeyDataToFlows(data);
                    
                    if (typeof renderFlowTable === 'function') {
                        renderFlowTable();
                        updateAllStats();
                        console.log('‚úÖ Flow Builder refreshed successfully');
                    }
                } else {
                    console.warn('‚ö†Ô∏è No data available for Flow Builder refresh');
                }
            },
            
            updateRealTimeIndicator() {
                const indicator = document.getElementById('realtime-indicator');
                const button = document.getElementById('realtime-toggle');
                
                if (indicator && button) {
                    if (this.realTimeMode) {
                        indicator.className = 'realtime-indicator live';
                        button.textContent = '‚ö™ Disable Live Updates';
                        button.className = 'btn btn-secondary';
                    } else {
                        indicator.className = 'realtime-indicator manual';
                        button.textContent = 'üî¥ Enable Live Updates';
                        button.className = 'btn btn-primary';
                    }
                }
            },
            
            applyImmediateChange(newData) {
                if (this.realTimeMode) {
                    console.log('‚ö° Applying immediate change in real-time mode');
                    this.setData(newData, 'flow-builder-realtime');
                }
            },
            
            applyFlowBuilderChanges(newData) {
                console.log('‚úÖ Applying Flow Builder changes:', newData);
                this.setData(newData, 'flow-builder');
            },
            
            setupEventListeners() {
                window.addEventListener('pulseTabSwitch', (e) => {
                    this.handleTabSwitch(e.detail.tabName);
                });
            },
            
            async waitForAppReady() {
                const maxAttempts = 100;
                const checkInterval = 100;
                let attempts = 0;
                
                return new Promise((resolve, reject) => {
                    const checkApp = () => {
                        attempts++;
                        
                        if (window.pulseApp && window.pulseApp.chart) {
                            console.log('‚úÖ Main app found and ready, hooking into data flow');
                            this.hookIntoApp();
                            
                            this.appReadyCallbacks.forEach(callback => callback());
                            this.appReadyCallbacks = [];
                            
                            resolve();
                            return;
                        }
                        
                        if (attempts >= maxAttempts) {
                            console.warn('‚ö†Ô∏è Main app not found after maximum attempts');
                            resolve();
                            return;
                        }
                        
                        setTimeout(checkApp, checkInterval);
                    };
                    
                    checkApp();
                });
            },
            
            hookIntoApp() {
                const app = window.pulseApp;
                if (!app) return;
                
                const originalLoadDataset = app.loadDataset.bind(app);
                app.loadDataset = async function(datasetKey) {
                    const result = await originalLoadDataset(datasetKey);
                    window.PulseDataBridge.setData(result, `dataset-${datasetKey}`);
                    return result;
                };
                
                if (app.chart) {
                    this.setChartInstance(app.chart);
                }
                
                const initialData = app.getCurrentData();
                if (initialData) {
                    this.setData(initialData, 'app-initial');
                }
                
                console.log('üîó Successfully hooked into main app');
            },
            
            handleTabSwitch(tabName) {
                console.log(`üîÑ Tab switched to: ${tabName}`);
                
                if (tabName === 'data-builder') {
                    if (!this.currentData && window.pulseApp) {
                        const appData = window.pulseApp.getCurrentData();
                        if (appData) {
                            this.currentData = appData;
                            console.log('üìä Retrieved data from app for flow builder');
                        }
                    }
                    
                    setTimeout(() => {
                        this.refreshFlowBuilder();
                    }, 50);
                } else if (tabName === 'chart-view') {
                    const data = this.getData();
                    if (data && this.chartInstance) {
                        this.chartInstance.render(data);
                    }
                }
            }
        };

        window.PulseDataBridge.init();
    </script>
    
    <!-- Flow Builder Implementation -->
    <script>
        let currentMainTab = 'chart-view';
        let flowData = {
            metadata: {
                title: "Financial Flow",
                subtitle: "Current Data", 
                currency: "USD",
                unit: "millions",
                company: "Your Company",
                period: "Current Period",
                colorPalette: {} // CRITICAL: Always preserve color palette
            },
            flows: []
        };

        let flowIdCounter = 0;

        // FIXED: Add missing convertSankeyDataToFlows function
        function convertSankeyDataToFlows(sankeyData) {
            const flows = [];
            
            sankeyData.links.forEach((link, index) => {
                const sourceNode = sankeyData.nodes.find(n => n.id === link.source);
                const targetNode = sankeyData.nodes.find(n => n.id === link.target);
                
                if (sourceNode && targetNode) {
                    flows.push(new BusinessFlow({
                        source: link.source,
                        target: link.target,
                        value: link.value,
                        previousValue: link.previousValue || 0,
                        flowType: link.type || 'revenue_flow',
                        sourceLayer: sourceNode.depth || 0,
                        targetLayer: targetNode.depth || 1,
                        sourceCategory: sourceNode.category || 'revenue',
                        targetCategory: targetNode.category || 'revenue',
                        description: link.description || targetNode.description || ''
                    }));
                }
            });

            return {
                metadata: {
                    title: sankeyData.metadata?.title || "Financial Flow",
                    subtitle: sankeyData.metadata?.subtitle || "Live Chart Data",
                    currency: sankeyData.metadata?.currency || "USD",
                    unit: sankeyData.metadata?.unit || "millions",
                    company: sankeyData.metadata?.company || "Your Company",
                    period: sankeyData.metadata?.period || "Current Period",
                    comparisonMode: sankeyData.metadata?.comparisonMode || false,
                    // CRITICAL: Preserve the existing color palette
                    colorPalette: sankeyData.metadata?.colorPalette || flowData.metadata?.colorPalette || {}
                },
                flows: flows
            };
        }

        // FIXED: Comparison Mode Toggle with color preservation
        function toggleComparisonMode() {
            const comparisonMode = document.getElementById('comparison-mode-toggle').checked;
            
            // CRITICAL: Store existing colors before any changes
            const existingColors = { ...flowData.metadata.colorPalette };
            
            // Show/hide comparison columns
            const previousCol = document.getElementById('previous-value-col');
            const varianceCol = document.getElementById('variance-col');
            
            if (comparisonMode) {
                previousCol.style.display = 'table-cell';
                varianceCol.style.display = 'table-cell';
            } else {
                previousCol.style.display = 'none';
                varianceCol.style.display = 'none';
            }
            
            // Update metadata with comparison mode but preserve colors
            flowData.metadata.comparisonMode = comparisonMode;
            flowData.metadata.colorPalette = existingColors; // CRITICAL: Restore colors
            
            // Re-render table
            renderFlowTable();
            
            // If in real-time mode, trigger update with color preservation
            if (window.PulseDataBridge.realTimeMode) {
                const sankeyData = generateNodesAndLinksFromFlows();
                // CRITICAL: Ensure colors are preserved in the generated data
                sankeyData.metadata.colorPalette = existingColors;
                debouncedRealTimeUpdate();
            }
            
            console.log(`üìà Comparison mode ${comparisonMode ? 'ENABLED' : 'DISABLED'} with colors preserved`);
        }

        // Flow structure definition
        class BusinessFlow {
            constructor(options = {}) {
                this.id = options.id || `flow_${++flowIdCounter}`;
                this.source = options.source || '';
                this.target = options.target || '';
                this.value = options.value || 0;
                this.previousValue = options.previousValue || 0;
                this.flowType = options.flowType || 'revenue_flow';
                this.sourceLayer = options.sourceLayer || 0;
                this.targetLayer = options.targetLayer || 1;
                this.sourceOrder = options.sourceOrder || 1;
                this.targetOrder = options.targetOrder || 1;
                this.sourceCategory = options.sourceCategory || 'revenue';
                this.targetCategory = options.targetCategory || 'revenue';
                this.description = options.description || '';
            }
            
            // Calculate variance between current and previous period
            getVariance() {
                if (this.previousValue === 0) {
                    return this.value > 0 ? { amount: this.value, percentage: 100, trend: 'new' } : { amount: 0, percentage: 0, trend: 'none' };
                }
                
                const amount = this.value - this.previousValue;
                const percentage = (amount / Math.abs(this.previousValue)) * 100;
                let trend = 'none';
                
                if (percentage > 0.1) trend = 'up';
                else if (percentage < -0.1) trend = 'down';
                
                return { amount, percentage, trend };
            }
            
            // Get formatted variance display
            getVarianceDisplay() {
                const variance = this.getVariance();
                if (variance.trend === 'none') return '‚Üí 0%';
                if (variance.trend === 'new') return 'üÜï';
                
                const symbol = variance.trend === 'up' ? '‚ÜóÔ∏è' : '‚ÜòÔ∏è';
                const sign = variance.percentage > 0 ? '+' : '';
                return `${symbol} ${sign}${variance.percentage.toFixed(1)}%`;
            }
        }

        // Debounce function for real-time updates
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        const debouncedRealTimeUpdate = debounce(() => {
            if (window.PulseDataBridge.realTimeMode) {
                console.log('‚ö° Triggering debounced real-time update');
                const sankeyData = generateNodesAndLinksFromFlows();
                window.PulseDataBridge.applyImmediateChange(sankeyData);
            }
        }, 500);

        // Collapsible Section Management
        function toggleSection(sectionName) {
            const header = document.querySelector(`[onclick="toggleSection('${sectionName}')"]`);
            const content = document.getElementById(`${sectionName}-content`);
            
            if (content.classList.contains('collapsed')) {
                content.classList.remove('collapsed');
                content.style.height = 'auto';
                header.classList.remove('collapsed');
            } else {
                content.style.height = content.scrollHeight + 'px';
                setTimeout(() => {
                    content.classList.add('collapsed');
                    header.classList.add('collapsed');
                }, 10);
            }
        }

        function toggleRealTimeMode() {
            const currentMode = window.PulseDataBridge.realTimeMode;
            const newMode = !currentMode;
            window.PulseDataBridge.setRealTimeMode(newMode);
            
            console.log(`üîÑ Real-time mode ${newMode ? 'ENABLED' : 'DISABLED'}`);
        }

        function switchMainTab(tabName) {
            console.log(`üéØ Switching to tab: ${tabName}`);
            
            document.querySelectorAll('.main-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            const targetTab = document.querySelector(`[onclick="switchMainTab('${tabName}')"]`);
            if (targetTab) {
                targetTab.classList.add('active');
            }
            
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            const targetContent = document.getElementById(tabName);
            if (targetContent) {
                targetContent.classList.add('active');
            }
            
            currentMainTab = tabName;
            
            window.dispatchEvent(new CustomEvent('pulseTabSwitch', {
                detail: { tabName }
            }));
            
            if (tabName === 'data-builder') {
                setTimeout(() => {
                    initializeFlowBuilder();
                }, 100);
            }
        }

        function initializeFlowBuilder() {
            console.log('üîß Initializing Flow Builder...');
            
            let data = null;
            
            if (window.PulseDataBridge && window.PulseDataBridge.currentData) {
                data = window.PulseDataBridge.currentData;
                console.log('üìä Found data from Data Bridge:', data);
            } else if (window.pulseApp && window.pulseApp.getCurrentData()) {
                data = window.pulseApp.getCurrentData();
                console.log('üìä Found data from pulseApp:', data);
                if (window.PulseDataBridge) {
                    window.PulseDataBridge.currentData = data;
                }
            }
            
            if (data && data.nodes && data.links) {
                console.log('‚úÖ Successfully found data for Flow Builder');
                
                // CRITICAL: Preserve existing colors before conversion
                const existingColors = { ...flowData.metadata.colorPalette };
                
                flowData = convertSankeyDataToFlows(data);
                
                // CRITICAL: Restore colors after conversion
                flowData.metadata.colorPalette = { ...existingColors, ...flowData.metadata.colorPalette };
                
                updateMetadataInputs();
                renderFlowTable();
                updateAllStats();
                
                if (!window.PulseDataBridge.realTimeMode) {
                    toggleRealTimeMode();
                }
                
                console.log('‚úÖ Flow Builder initialized with live data and preserved colors');
            } else {
                console.log('‚ö†Ô∏è No data found - Flow Builder ready for manual input');
            }
        }

        function loadCurrentChartData() {
            const data = window.PulseDataBridge.getData();
            if (data) {
                // CRITICAL: Preserve existing colors
                const existingColors = { ...flowData.metadata.colorPalette };
                
                flowData = convertSankeyDataToFlows(data);
                
                // CRITICAL: Restore colors
                flowData.metadata.colorPalette = { ...existingColors, ...flowData.metadata.colorPalette };
                
                updateMetadataInputs();
                renderFlowTable();
                updateAllStats();
                
                alert('‚úÖ Successfully loaded current chart data for editing!');
            } else {
                alert('‚ùå No chart data available. Please load a dataset in Chart View first.');
            }
        }

        function loadCompleteTemplate() {
            // CRITICAL: Preserve existing colors
            const existingColors = { ...flowData.metadata.colorPalette };
            
            flowData.metadata.company = "TechFlow Corporation";
            flowData.metadata.title = "TechFlow Financial Flow";
            flowData.metadata.subtitle = "Multi-Layer Business Model";
            
            // CRITICAL: Restore colors
            flowData.metadata.colorPalette = existingColors;
            
            flowData.flows = [
                new BusinessFlow({
                    source: "Subscription Revenue",
                    target: "Total Revenue",
                    value: 300,
                    previousValue: 250,
                    flowType: "revenue_flow",
                    sourceLayer: 0,
                    targetLayer: 1,
                    sourceCategory: "revenue",
                    targetCategory: "revenue",
                    description: "Recurring subscription income"
                }),
                new BusinessFlow({
                    source: "Professional Services",
                    target: "Total Revenue",
                    value: 60,
                    previousValue: 55,
                    flowType: "revenue_flow",
                    sourceLayer: 0,
                    targetLayer: 1,
                    sourceCategory: "revenue",
                    targetCategory: "revenue",
                    description: "Implementation and consulting"
                }),
                new BusinessFlow({
                    source: "Platform & Other",
                    target: "Total Revenue",
                    value: 135,
                    previousValue: 120,
                    flowType: "revenue_flow",
                    sourceLayer: 0,
                    targetLayer: 1,
                    sourceCategory: "revenue",
                    targetCategory: "revenue",
                    description: "Platform fees and other revenue"
                }),
                new BusinessFlow({
                    source: "Total Revenue",
                    target: "Gross Profit",
                    value: 340,
                    previousValue: 290,
                    flowType: "profit_flow",
                    sourceLayer: 1,
                    targetLayer: 2,
                    sourceCategory: "revenue",
                    targetCategory: "profit",
                    description: "Revenue after cost of revenue"
                }),
                new BusinessFlow({
                    source: "Total Revenue",
                    target: "Cost of Revenue",
                    value: 55,
                    previousValue: 50,
                    flowType: "expense_flow",
                    sourceLayer: 1,
                    targetLayer: 2,
                    sourceCategory: "revenue",
                    targetCategory: "expense",
                    description: "Direct costs to deliver services"
                }),
                new BusinessFlow({
                    source: "Gross Profit",
                    target: "Operating Profit",
                    value: 65,
                    previousValue: 55,
                    flowType: "profit_flow",
                    sourceLayer: 2,
                    targetLayer: 3,
                    sourceCategory: "profit",
                    targetCategory: "profit",
                    description: "Profit from core operations"
                }),
                new BusinessFlow({
                    source: "Gross Profit",
                    target: "Operating Expenses",
                    value: 155,
                    previousValue: 140,
                    flowType: "expense_flow",
                    sourceLayer: 2,
                    targetLayer: 3,
                    sourceCategory: "profit",
                    targetCategory: "expense",
                    description: "Total operating expenses"
                }),
                new BusinessFlow({
                    source: "Operating Expenses",
                    target: "Sales & Marketing",
                    value: 85,
                    previousValue: 75,
                    flowType: "expense_flow",
                    sourceLayer: 3,
                    targetLayer: 4,
                    sourceCategory: "expense",
                    targetCategory: "expense",
                    description: "Customer acquisition expenses"
                }),
                new BusinessFlow({
                    source: "Operating Expenses",
                    target: "R&D",
                    value: 45,
                    previousValue: 40,
                    flowType: "expense_flow",
                    sourceLayer: 3,
                    targetLayer: 4,
                    sourceCategory: "expense",
                    targetCategory: "expense",
                    description: "Research and development"
                }),
                new BusinessFlow({
                    source: "Operating Expenses",
                    target: "G&A",
                    value: 20,
                    previousValue: 18,
                    flowType: "expense_flow",
                    sourceLayer: 3,
                    targetLayer: 4,
                    sourceCategory: "expense",
                    targetCategory: "expense",
                    description: "General and administrative"
                }),
                new BusinessFlow({
                    source: "Operating Profit",
                    target: "Net Income",
                    value: 50,
                    previousValue: 42,
                    flowType: "profit",
                    sourceLayer: 3,
                    targetLayer: 4,
                    sourceCategory: "profit",
                    targetCategory: "profit",
                    description: "Final net income"
                }),
                new BusinessFlow({
                    source: "Operating Profit",
                    target: "Tax Expense",
                    value: 12,
                    previousValue: 10,
                    flowType: "expense_flow",
                    sourceLayer: 3,
                    targetLayer: 4,
                    sourceCategory: "profit",
                    targetCategory: "expense",
                    description: "Income tax expense"
                })
            ];
            
            document.getElementById('company-name').value = flowData.metadata.company;
            renderFlowTable();
            updateAllStats();
            debouncedRealTimeUpdate();
        }

        function loadBlankFlows() {
            if (confirm('This will clear all current flows. Continue?')) {
                // CRITICAL: Preserve existing colors
                const existingColors = { ...flowData.metadata.colorPalette };
                
                flowData.flows = [
                    new BusinessFlow({
                        source: "Revenue Source",
                        target: "Total Revenue",
                        value: 100,
                        previousValue: 0,
                        description: "Start building your flow here"
                    })
                ];
                
                // CRITICAL: Restore colors
                flowData.metadata.colorPalette = existingColors;
                
                renderFlowTable();
                updateAllStats();
                debouncedRealTimeUpdate();
            }
        }

        function resetToChartData() {
            const proceed = confirm('This will reset all your changes to match the current chart data. Continue?');
            if (proceed) {
                loadCurrentChartData();
            }
        }

        function updateMetadataInputs() {
            const fields = [
                { id: 'company-name', value: flowData.metadata.company },
                { id: 'period', value: flowData.metadata.period },
                { id: 'currency', value: flowData.metadata.currency },
                { id: 'units', value: flowData.metadata.unit }
            ];
            
            fields.forEach(({ id, value }) => {
                const element = document.getElementById(id);
                if (element && value) {
                    element.value = value;
                }
            });
        }

        function renderFlowTable() {
            const tbody = document.getElementById('flows-tbody');
            tbody.innerHTML = '';
            
            if (flowData.flows.length === 0) {
                const comparisonMode = document.getElementById('comparison-mode-toggle').checked;
                const colSpan = comparisonMode ? 13 : 11;
                tbody.innerHTML = `
                    <tr>
                        <td colspan="${colSpan}" style="text-align: center; padding: 40px; color: #6b7280;">
                            <div style="font-size: 16px; margin-bottom: 8px;">üí°</div>
                            <div>No flows defined. Click "Add Flow" to start building your financial structure.</div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            flowData.flows.forEach((flow, index) => {
                const row = createFlowRow(flow, index);
                tbody.appendChild(row);
            });
        }

        function createFlowRow(flow, index) {
            const tr = document.createElement('tr');
            
            const comparisonMode = document.getElementById('comparison-mode-toggle').checked;
            
            let rowHTML = `
                <td>
                    <div class="flow-controls">
                        <button class="flow-control-btn up" onclick="moveFlowUp(${index})" title="Move Up" ${index === 0 ? 'disabled' : ''}>‚Üë</button>
                        <button class="flow-control-btn down" onclick="moveFlowDown(${index})" title="Move Down" ${index === flowData.flows.length - 1 ? 'disabled' : ''}>‚Üì</button>
                        <button class="flow-control-btn duplicate" onclick="duplicateFlow(${index})" title="Duplicate">‚ßâ</button>
                        <button class="flow-control-btn remove" onclick="removeFlow(${index})" title="Remove">√ó</button>
                    </div>
                </td>
                <td>
                    <input type="text" class="flow-input" value="${flow.source}" 
                           onchange="updateFlow(${index}, 'source', this.value)">
                </td>
                <td>
                    <input type="text" class="flow-input" value="${flow.target}" 
                           onchange="updateFlow(${index}, 'target', this.value)">
                </td>
                <td>
                    <input type="number" class="flow-input number" value="${flow.value}" 
                           onchange="updateFlow(${index}, 'value', parseFloat(this.value) || 0)">
                </td>`;
            
            // Add previous value and variance columns if comparison mode is enabled
            if (comparisonMode) {
                rowHTML += `
                <td>
                    <input type="number" class="flow-input number" value="${flow.previousValue || 0}" 
                           onchange="updateFlow(${index}, 'previousValue', parseFloat(this.value) || 0)">
                </td>
                <td>
                    <div style="font-size: 11px; font-weight: 600; text-align: center;">${flow.getVarianceDisplay()}</div>
                </td>`;
            }
            
            rowHTML += `
                <td>
                    <input type="number" class="flow-input number" value="${flow.sourceLayer}" min="0" max="20"
                           onchange="updateFlow(${index}, 'sourceLayer', parseInt(this.value) || 0)">
                </td>
                <td>
                    <input type="number" class="flow-input number" value="${flow.targetLayer}" min="0" max="20"
                           onchange="updateFlow(${index}, 'targetLayer', parseInt(this.value) || 0)">
                </td>
                <td>
                    <select class="flow-select" onchange="updateFlow(${index}, 'flowType', this.value)">
                        <option value="revenue_flow" ${flow.flowType === 'revenue_flow' ? 'selected' : ''}>Revenue</option>
                        <option value="expense_flow" ${flow.flowType === 'expense_flow' ? 'selected' : ''}>expense</option>
                        <option value="profit_flow" ${flow.flowType === 'profit_flow' ? 'selected' : ''}>Profit</option>
                        <option value="expense_flow" ${flow.flowType === 'expense_flow' ? 'selected' : ''}>Expense</option>
                        <option value="profit_flow" ${flow.flowType === 'profit_flow' ? 'selected' : ''}>profit</option>
                    </select>
                </td>
                <td>
                    <select class="flow-select" onchange="updateFlow(${index}, 'sourceCategory', this.value)">
                        <option value="revenue" ${flow.sourceCategory === 'revenue' ? 'selected' : ''}>Revenue</option>
                        <option value="expense" ${flow.sourceCategory === 'expense' ? 'selected' : ''}>expense</option>
                        <option value="profit" ${flow.sourceCategory === 'profit' ? 'selected' : ''}>Profit</option>
                        <option value="expense" ${flow.sourceCategory === 'expense' ? 'selected' : ''}>Expense</option>
                        <option value="income" ${flow.sourceCategory === 'income' ? 'selected' : ''}>Income</option>
                    </select>
                </td>
                <td>
                    <select class="flow-select" onchange="updateFlow(${index}, 'targetCategory', this.value)">
                        <option value="revenue" ${flow.targetCategory === 'revenue' ? 'selected' : ''}>Revenue</option>
                        <option value="expense" ${flow.targetCategory === 'expense' ? 'selected' : ''}>expense</option>
                        <option value="profit" ${flow.targetCategory === 'profit' ? 'selected' : ''}>Profit</option>
                        <option value="expense" ${flow.targetCategory === 'expense' ? 'selected' : ''}>Expense</option>
                        <option value="income" ${flow.targetCategory === 'income' ? 'selected' : ''}>Income</option>
                    </select>
                </td>
                <td>
                    <input type="text" class="flow-input" value="${flow.description}" 
                           onchange="updateFlow(${index}, 'description', this.value)"
                           placeholder="Flow description">
                </td>
                <td>
                    ${getFlowBalanceIndicator(flow)}
                </td>
            `;
            
            tr.innerHTML = rowHTML;
            return tr;
        }

        function getFlowBalanceIndicator(flow) {
            const isValid = flow.source && flow.target && flow.value > 0 && flow.sourceLayer < flow.targetLayer;
            return `<div class="balance-indicator ${isValid ? 'balanced' : 'unbalanced'}">${isValid ? '‚úì' : '‚ö†'}</div>`;
        }

        function addFlow() {
            const newFlow = new BusinessFlow({
                source: "New Source",
                target: "New Target",
                value: 100,
                previousValue: 0,
                sourceLayer: 0,
                targetLayer: 1
            });
            
            flowData.flows.push(newFlow);
            renderFlowTable();
            updateAllStats();
            debouncedRealTimeUpdate();
        }

        function removeFlow(index) {
            flowData.flows.splice(index, 1);
            renderFlowTable();
            updateAllStats();
            debouncedRealTimeUpdate();
        }

        function moveFlowUp(index) {
            if (index > 0) {
                [flowData.flows[index], flowData.flows[index - 1]] = [flowData.flows[index - 1], flowData.flows[index]];
                renderFlowTable();
                updateAllStats();
                debouncedRealTimeUpdate();
            }
        }

        function moveFlowDown(index) {
            if (index < flowData.flows.length - 1) {
                [flowData.flows[index], flowData.flows[index + 1]] = [flowData.flows[index + 1], flowData.flows[index]];
                renderFlowTable();
                updateAllStats();
                debouncedRealTimeUpdate();
            }
        }

        function duplicateFlow(index) {
            const originalFlow = flowData.flows[index];
            const duplicatedFlow = new BusinessFlow({
                source: originalFlow.source + " Copy",
                target: originalFlow.target,
                value: originalFlow.value,
                previousValue: originalFlow.previousValue,
                flowType: originalFlow.flowType,
                sourceLayer: originalFlow.sourceLayer,
                targetLayer: originalFlow.targetLayer,
                sourceCategory: originalFlow.sourceCategory,
                targetCategory: originalFlow.targetCategory,
                description: originalFlow.description + " (Copy)"
            });
            
            flowData.flows.splice(index + 1, 0, duplicatedFlow);
            renderFlowTable();
            updateAllStats();
            debouncedRealTimeUpdate();
        }

        function updateFlow(index, field, value) {
            if (flowData.flows[index]) {
                flowData.flows[index][field] = value;
                updateAllStats();
                debouncedRealTimeUpdate();
                
                const row = document.querySelectorAll('#flows-tbody tr')[index];
                if (row) {
                    const balanceCell = row.lastElementChild;
                    balanceCell.innerHTML = getFlowBalanceIndicator(flowData.flows[index]);
                }
            }
        }

        function updateMetadata() {
            flowData.metadata.company = document.getElementById('company-name').value;
            flowData.metadata.period = document.getElementById('period').value;
            flowData.metadata.currency = document.getElementById('currency').value;
            flowData.metadata.unit = document.getElementById('units').value;
            flowData.metadata.title = `${flowData.metadata.company} Financial Flow`;
            flowData.metadata.subtitle = `${flowData.metadata.period} Business Model`;
            
            debouncedRealTimeUpdate();
        }

        function updateAllStats() {
            const nodeMap = new Map();
            
            flowData.flows.forEach(flow => {
                nodeMap.set(flow.source, flow.sourceLayer);
                nodeMap.set(flow.target, flow.targetLayer);
            });
            
            const flowCount = flowData.flows.length;
            const nodeCount = nodeMap.size;
            const layerCount = new Set(Array.from(nodeMap.values())).size;
            
            let balancedFlows = 0;
            flowData.flows.forEach(flow => {
                const isValid = flow.source && flow.target && flow.value > 0 && flow.sourceLayer < flow.targetLayer;
                if (isValid) balancedFlows++;
            });
            
            const balanceScore = flowCount > 0 ? Math.round((balancedFlows / flowCount) * 100) : 0;
            
            document.getElementById('flow-count').textContent = flowCount;
            document.getElementById('node-count').textContent = nodeCount;
            document.getElementById('layer-count').textContent = layerCount;
            document.getElementById('balance-score').textContent = balanceScore + '%';
        }

        function applyFlowChanges() {
            console.log('üöÄ Applying Flow Builder changes...');
            
            flowData.metadata.company = document.getElementById('company-name').value;
            flowData.metadata.period = document.getElementById('period').value;
            flowData.metadata.currency = document.getElementById('currency').value;
            flowData.metadata.unit = document.getElementById('units').value;
            flowData.metadata.title = `${flowData.metadata.company} Financial Flow`;
            
            const sankeyData = generateNodesAndLinksFromFlows();
            window.PulseDataBridge.applyFlowBuilderChanges(sankeyData);
            
            switchMainTab('chart-view');
            
            console.log('‚úÖ Changes applied and switched to Chart View');
        }

        function validateFlows() {
            const errors = [];
            const warnings = [];
            
            if (flowData.flows.length === 0) {
                errors.push('No flows defined');
            }
            
            flowData.flows.forEach((flow, index) => {
                if (!flow.source || !flow.target) {
                    errors.push(`Flow ${index + 1}: Missing source or target`);
                }
                
                if (flow.value <= 0) {
                    errors.push(`Flow ${index + 1}: Invalid value (${flow.value})`);
                }
                
                if (flow.sourceLayer >= flow.targetLayer) {
                    errors.push(`Flow ${index + 1}: Source layer must be less than target layer`);
                }
                
                if (flow.source === flow.target) {
                    errors.push(`Flow ${index + 1}: Source and target cannot be the same`);
                }
            });
            
            let message = '‚úÖ Flow Validation Results\n\n';
            
            if (errors.length > 0) {
                message += '‚ùå Errors:\n' + errors.map(e => `‚Ä¢ ${e}`).join('\n') + '\n\n';
            }
            
            if (warnings.length > 0) {
                message += '‚ö†Ô∏è Warnings:\n' + warnings.map(w => `‚Ä¢ ${w}`).join('\n') + '\n\n';
            }
            
            if (errors.length === 0 && warnings.length === 0) {
                message += 'Perfect! All flows are valid.\n\n';
            }
            
            const balanceScore = document.getElementById('balance-score').textContent;
            message += `üìä Summary:\n‚Ä¢ ${flowData.flows.length} flows\n‚Ä¢ Balance Score: ${balanceScore}`;
            
            alert(message);
        }

        function exportFlowsToCSV() {
            let csv = 'Source,Target,Current Value,Previous Value,Flow Type,Source Layer,Target Layer,Source Category,Target Category,Description\n';
            
            flowData.flows.forEach(flow => {
                csv += `"${flow.source}","${flow.target}",${flow.value},${flow.previousValue || 0},"${flow.flowType}",${flow.sourceLayer},${flow.targetLayer},"${flow.sourceCategory}","${flow.targetCategory}","${flow.description}"\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `${flowData.metadata.company.replace(/[^a-zA-Z0-9]/g, '').toLowerCase()}-flows.csv`;
            link.click();
            URL.revokeObjectURL(url);
        }

        function importFlowsFromCSV() {
            document.getElementById('csv-file-input').click();
        }

        function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                const content = e.target.result;
                
                if (file.name.endsWith('.json')) {
                    try {
                        const data = JSON.parse(content);
                        
                        // CRITICAL: Preserve existing colors before import
                        const existingColors = { ...flowData.metadata.colorPalette };
                        
                        if (data.flows) {
                            flowData = data;
                        } else if (data.nodes && data.links) {
                            flowData = convertSankeyDataToFlows(data);
                        }
                        
                        // CRITICAL: Restore colors after import
                        flowData.metadata.colorPalette = { ...existingColors, ...flowData.metadata.colorPalette };
                        
                        renderFlowTable();
                        updateAllStats();
                        debouncedRealTimeUpdate();
                        alert('‚úÖ Successfully imported flows!');
                    } catch (error) {
                        alert('‚ùå Error parsing JSON: ' + error.message);
                    }
                } else if (file.name.endsWith('.csv')) {
                    parseCSVFlows(content);
                }
            };
            reader.readAsText(file);
        }

        function parseCSVFlows(csvContent) {
            const lines = csvContent.split('\n').filter(line => line.trim() && !line.startsWith('#'));
            if (lines.length < 2) {
                alert('‚ùå CSV file must have header and at least one data row');
                return;
            }
            
            // Parse header to detect column positions
            const headers = parseCSVLine(lines[0]).map(h => h.toLowerCase().trim());
            const columnMap = {
                source: Math.max(headers.indexOf('source'), headers.indexOf('from')),
                target: Math.max(headers.indexOf('target'), headers.indexOf('to')),
                amount: Math.max(headers.indexOf('amount'), headers.indexOf('current value'), headers.indexOf('value')),
                previousAmount: Math.max(headers.indexOf('previous amount'), headers.indexOf('previous value')),
                flowType: headers.indexOf('flow type'),
                sourceLayer: headers.indexOf('source layer'),
                targetLayer: headers.indexOf('target layer'),
                sourceCategory: headers.indexOf('source category'),
                targetCategory: headers.indexOf('target category'),
                description: headers.indexOf('description')
            };
            
            // CRITICAL: Preserve existing colors before import
            const existingColors = { ...flowData.metadata.colorPalette };
            
            const flows = [];
            
            for (let i = 1; i < lines.length; i++) {
                const values = parseCSVLine(lines[i]);
                if (values.length >= 6) {
                    const previousValue = columnMap.previousAmount >= 0 && values[columnMap.previousAmount] 
                        ? parseFloat(values[columnMap.previousAmount]) || 0 
                        : 0;
                    
                    flows.push(new BusinessFlow({
                        source: values[columnMap.source] || '',
                        target: values[columnMap.target] || '',
                        value: parseFloat(values[columnMap.amount]) || 0,
                        previousValue: previousValue,
                        flowType: values[columnMap.flowType] || 'revenue_flow',
                        sourceLayer: parseInt(values[columnMap.sourceLayer]) || 0,
                        targetLayer: parseInt(values[columnMap.targetLayer]) || 1,
                        sourceCategory: values[columnMap.sourceCategory] || 'revenue',
                        targetCategory: values[columnMap.targetCategory] || 'revenue',
                        description: values[columnMap.description] || ''
                    }));
                }
            }
            
            if (flows.length > 0) {
                flowData.flows = flows;
                
                // CRITICAL: Restore colors after import
                flowData.metadata.colorPalette = existingColors;
                
                // Enable comparison mode if any previous values exist
                const hasPreviousValues = flows.some(flow => flow.previousValue > 0);
                if (hasPreviousValues) {
                    document.getElementById('comparison-mode-toggle').checked = true;
                    toggleComparisonMode();
                }
                
                renderFlowTable();
                updateAllStats();
                console.log('‚úÖ Flow Builder refreshed successfully');
                alert(`‚úÖ Successfully imported ${flows.length} flows from CSV!`);
            } else {
                alert('‚ùå No valid flows found in CSV file');
            }
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current.trim());
            return result.map(field => field.replace(/^"|"$/g, ''));
        }

        // FIXED: Generate nodes and links with proper color preservation
        function generateNodesAndLinksFromFlows() {
            const comparisonMode = document.getElementById('comparison-mode-toggle').checked;
            const result = PulseSankeyChart.generateNodesAndLinksFromFlows(flowData, comparisonMode);
            
            // Preserve the comparison mode in metadata
            result.metadata.comparisonMode = comparisonMode;
            
            return result;
        }

        // Setup file import handler
        document.addEventListener('DOMContentLoaded', function() {
            const csvFileInput = document.getElementById('csv-file-input');
            if (csvFileInput) {
                csvFileInput.addEventListener('change', handleFileImport);
            }
            
            // Initialize comparison columns as hidden
            const previousCol = document.getElementById('previous-value-col');
            const varianceCol = document.getElementById('variance-col');
            if (previousCol) previousCol.style.display = 'none';
            if (varianceCol) varianceCol.style.display = 'none';
        });
    </script>
</body>
</html>
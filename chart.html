<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pulse Analytics Platform</title>
    
    <!-- External Dependencies -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-sankey/0.12.3/d3-sankey.min.js"></script>
    
    <!-- Consolidated Application Styles -->
    <link rel="stylesheet" href="css/pulse-analytics.css">
    
    <style>
        .main-tabs {
            display: flex;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 0 20px;
        }
        
        .main-tab {
            background: transparent;
            border: none;
            color: rgba(255,255,255,0.7);
            padding: 16px 24px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
            border-bottom: 3px solid transparent;
        }
        
        .main-tab:hover {
            color: rgba(255,255,255,0.9);
            background: rgba(255,255,255,0.1);
        }
        
        .main-tab.active {
            color: white;
            border-bottom-color: #f59e0b;
            background: rgba(255,255,255,0.1);
        }
        
        .tab-content {
            display: none;
            min-height: calc(100vh - 140px);
        }
        
        .tab-content.active {
            display: block;
        }

        .realtime-controls {
            background: #f0f9ff;
            border: 1px solid #0ea5e9;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .realtime-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }

        .realtime-indicator.live {
            background-color: #ef4444;
        }

        .realtime-indicator.manual {
            background-color: #6b7280;
            animation: none;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="pulse-app">
        <!-- Application Header -->
        <header class="app-header">
            <h1>Pulse Analytics Platform</h1>
            <div class="header-controls">
                <div class="data-selector">
                    <label for="data-select" style="color: white; margin-right: 8px;">Data:</label>
                    <select id="data-select">
                        <option value="saas">SaaS Company (Sample)</option>
                        <option value="manufacturing">Manufacturing Corp</option>
                        <option value="retail">Retail Chain</option>
                        <option value="custom">üìÅ Load Custom Data...</option>
                    </select>
                </div>
                <div class="chart-selector">
                    <label for="chart-type-select" style="color: white; margin-right: 8px;">Chart:</label>
                    <select id="chart-type-select">
                        <option value="sankey">üåä Sankey Flow</option>
                        <option value="bar">üìä Bar Chart</option>
                        <option value="line">üìà Line Chart</option>
                    </select>
                </div>
            </div>
        </header>

        <!-- Main Tabs Navigation -->
        <div class="main-tabs">
            <button class="main-tab" onclick="switchMainTab('data-builder')">
                üìã Data Builder
            </button>
            <button class="main-tab active" onclick="switchMainTab('chart-view')">
                üìä Chart View
            </button>
        </div>

        <!-- Data Builder Tab -->
        <div id="data-builder" class="tab-content" style="background: #f8f9fa;">
            <div style="display: flex; justify-content: center; min-height: calc(100vh - 140px); padding: 20px;">
                <div style="max-width: 1200px; width: 100%;">
                    <div class="template-header" style="text-align: center; margin-bottom: 30px;">
                        <h1>üìä Real-time Data Builder</h1>
                        <span class="feature-badge">‚ö° Live Updates</span>
                        <p>Edit chart data with instant live preview synchronization</p>
                    </div>

                    <!-- Real-time Controls -->
                    <div class="realtime-controls">
                        <h4 style="margin: 0 0 10px 0; color: #0369a1;">
                            <span id="realtime-indicator" class="realtime-indicator live"></span>
                            Live Update Mode
                        </h4>
                        <div style="display: flex; gap: 12px; align-items: center;">
                            <button id="realtime-toggle" class="btn btn-secondary" onclick="toggleRealTimeMode()">
                                ‚ö™ Disable Live Updates
                            </button>
                            <div style="font-size: 12px; color: #6b7280;">
                                <strong>Manual:</strong> Changes apply when you click "Apply Changes"<br>
                                <strong>Live:</strong> Changes apply automatically as you type (500ms delay)
                            </div>
                        </div>
                    </div>

                    <div class="template-content">
                        <!-- Quick Actions -->
                        <div class="layer-management">
                            <h3 style="margin: 0 0 10px 0; color: #92400e;">‚ö° Quick Actions</h3>
                            <div class="layer-controls">
                                <button class="layer-btn" onclick="loadCurrentChartData()">üìä Load Chart Data</button>
                                <button class="layer-btn" onclick="loadAdobeTemplate()">Adobe Template</button>
                                <button class="layer-btn secondary" onclick="loadBlankTemplate()">Blank Template</button>
                            </div>
                        </div>

                        <!-- Metadata Section -->
                        <div class="data-section">
                            <div class="section-header">
                                <h3 class="section-title">üìã Company Information</h3>
                            </div>
                            <div class="section-content">
                                <div class="metadata-grid" style="grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));">
                                    <div class="field-group">
                                        <label class="field-label">Company Name</label>
                                        <input type="text" class="field-input" id="company-name" value="" placeholder="Your Company Name">
                                    </div>
                                    <div class="field-group">
                                        <label class="field-label">Subtitle</label>
                                        <input type="text" class="field-input" id="subtitle" value="" placeholder="Multi-Layer Subscription Model">
                                    </div>
                                    <div class="field-group">
                                        <label class="field-label">Period</label>
                                        <input type="text" class="field-input" id="period" value="" placeholder="Q3 2025">
                                    </div>
                                    <div class="field-group">
                                        <label class="field-label">Currency</label>
                                        <select class="field-input" id="currency">
                                            <option value="USD">USD ($)</option>
                                            <option value="EUR">EUR (‚Ç¨)</option>
                                            <option value="GBP">GBP (¬£)</option>
                                        </select>
                                    </div>
                                    <div class="field-group">
                                        <label class="field-label">Units</label>
                                        <select class="field-input" id="units">
                                            <option value="millions">Millions</option>
                                            <option value="billions">Billions</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Nodes Editor -->
                        <div class="data-section">
                            <div class="section-header">
                                <h3 class="section-title">üéØ Nodes</h3>
                                <button class="add-item-btn" onclick="addNode()">+ Add Node</button>
                            </div>
                            <div class="section-content">
                                <div id="nodes-container">
                                    <div style="text-align: center; padding: 40px; color: #6b7280;">
                                        üìä No chart data loaded. Switch to Chart View first, then come back here to edit.
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Links Editor -->
                        <div class="data-section">
                            <div class="section-header">
                                <h3 class="section-title">üîó Flow Connections</h3>
                                <button class="add-item-btn" onclick="addCustomLink()">+ Add Connection</button>
                            </div>
                            <div class="section-content">
                                <div id="links-container">
                                    <div style="text-align: center; padding: 40px; color: #6b7280;">
                                        üîó No connections available. Load chart data first.
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="action-buttons">
                            <button class="btn btn-primary" onclick="applyDataAndSwitchToChart()">üöÄ Apply Changes</button>
                            <button class="btn btn-secondary" onclick="validateStructure()">‚úÖ Validate</button>
                            <button class="btn btn-secondary" onclick="exportCurrentData()">üíæ Export</button>
                            <button class="btn btn-secondary" onclick="resetToChartData()">üîÑ Reset to Chart</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chart View Tab (Original) -->
        <div id="chart-view" class="tab-content active">
            <div class="app-content">
                <!-- Chart Area -->
                <div class="chart-area">
                    <!-- Chart Toolbar -->
                    <div class="chart-toolbar">
                        <div class="data-controls">
                            <span id="data-status" class="status-indicator status-loading">Loading...</span>
                        </div>
                        
                        <div class="export-controls">
                            <button id="export-png" class="btn btn-primary">üñºÔ∏è PNG</button>
                            <button id="export-svg" class="btn btn-primary">üìê SVG</button>
                            <button id="export-data" class="btn btn-primary">üìä CSV</button>
                        </div>
                    </div>
                    
                    <!-- Chart Container -->
                    <div id="main-chart" class="chart-container">
                        <div class="chart-loading">
                            <div class="loading-spinner"></div>
                            <p>Initializing Pulse Analytics Platform...</p>
                        </div>
                    </div>
                </div>

                <!-- Enhanced Control Panel with Colors -->
                <div class="control-panel">
                    <div class="control-panel-header">
                        <h3>Chart Controls</h3>
                        <button id="reset-defaults" class="btn btn-outline">üîÑ Reset</button>
                    </div>
                    
                    <div id="dynamic-controls" class="control-panel-content">
                        <div style="padding: 40px 20px; text-align: center; color: #6b7280;">
                            <div style="font-size: 24px; margin-bottom: 8px;">‚öôÔ∏è</div>
                            <p>Loading chart controls...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden file input -->
    <input type="file" id="file-input" style="display: none;" accept=".json">

    <!-- Core Scripts -->
    <script src="js/core/DataManager.js"></script>
    <script src="js/core/ControlPanel.js"></script>
    <script src="js/charts/sankey/SankeyChart.js"></script>
    <script src="js/charts/sankey/SankeyControls.js"></script>
    
    <!-- Enhanced app.js with Data Bridge support -->
    <script src="js/app.js"></script>
    
    <!-- FIXED: Data Bridge Integration with proper timing -->
    <script>
        // Enhanced Data Bridge with FIXED timing and DEFAULT LIVE UPDATES
        window.PulseDataBridge = {
            currentData: null,
            chartInstance: null,
            isInitialized: false,
            realTimeMode: true, // DEFAULT: Start with live updates enabled
            appReadyCallbacks: [],
            
            init() {
                this.isInitialized = true;
                console.log('üåâ Real-time Data Bridge initialized');
                
                // Wait for app to be ready before setting up listeners
                this.waitForAppReady().then(() => {
                    this.setupEventListeners();
                });
            },
            
            // NEW: Register callback for when app is ready
            onAppReady(callback) {
                if (window.pulseApp) {
                    callback();
                } else {
                    this.appReadyCallbacks.push(callback);
                }
            },
            
            setData(data, source = 'unknown') {
                this.currentData = data;
                console.log(`üìä Data updated from ${source}:`, data);
                this.notifyDataChanged(source);
            },
            
            getData() {
                if (this.currentData) {
                    return this.currentData;
                }
                
                if (window.pulseApp?.getCurrentData()) {
                    this.currentData = window.pulseApp.getCurrentData();
                    return this.currentData;
                }
                
                if (window.pulseApp?.getCurrentChart()?.data) {
                    this.currentData = window.pulseApp.getCurrentChart().data;
                    return this.currentData;
                }
                
                return null;
            },
            
            setChartInstance(chart) {
                this.chartInstance = chart;
                console.log('üìà Chart instance registered');
            },
            
            setRealTimeMode(enabled) {
                this.realTimeMode = enabled;
                console.log(`üîÑ Real-time mode ${enabled ? 'ENABLED' : 'DISABLED'}`);
                this.updateRealTimeIndicator();
            },
            
            notifyDataChanged(source) {
                console.log(`üîÑ Broadcasting data change from ${source}`);
                
                if (this.chartInstance && this.currentData && source !== 'chart-update') {
                    console.log('üé® Updating chart with new data');
                    this.chartInstance.render(this.currentData);
                }
                
                if (window.currentMainTab === 'data-builder') {
                    this.refreshDataBuilder();
                }
                
                if (window.pulseApp && source !== 'app' && source !== 'app-initial') {
                    window.pulseApp.currentData = this.currentData;
                }
                
                window.dispatchEvent(new CustomEvent('pulseDataChanged', {
                    detail: { data: this.currentData, source }
                }));
            },
            
            refreshDataBuilder() {
                console.log('üîß Refreshing Data Builder...');
                
                const data = this.getData();
                if (data && data.nodes && data.links) {
                    console.log('‚úÖ Found data for Data Builder refresh:', data);
                    window.templateData = {
                        metadata: data.metadata || {},
                        nodes: JSON.parse(JSON.stringify(data.nodes || [])),
                        links: JSON.parse(JSON.stringify(data.links || []))
                    };
                    
                    if (typeof renderTemplateData === 'function') {
                        renderTemplateData();
                        console.log('‚úÖ Data Builder refreshed successfully');
                    }
                } else {
                    console.warn('‚ö†Ô∏è No data available for Data Builder refresh');
                }
            },
            
            updateRealTimeIndicator() {
                const indicator = document.getElementById('realtime-indicator');
                const button = document.getElementById('realtime-toggle');
                
                if (indicator && button) {
                    if (this.realTimeMode) {
                        indicator.className = 'realtime-indicator live';
                        button.textContent = '‚ö™ Disable Live Updates';
                        button.className = 'btn btn-secondary';
                    } else {
                        indicator.className = 'realtime-indicator manual';
                        button.textContent = 'üî¥ Enable Live Updates';
                        button.className = 'btn btn-primary';
                    }
                }
            },
            
            applyImmediateChange(newData) {
                if (this.realTimeMode) {
                    console.log('‚ö° Applying immediate change in real-time mode');
                    this.setData(newData, 'data-builder-realtime');
                }
            },
            
            applyDataBuilderChanges(newData) {
                console.log('‚úÖ Applying Data Builder changes:', newData);
                this.setData(newData, 'data-builder');
            },
            
            setupEventListeners() {
                window.addEventListener('pulseTabSwitch', (e) => {
                    this.handleTabSwitch(e.detail.tabName);
                });
                
                // Listen for data changes from main app
                window.addEventListener('pulseDataChanged', (event) => {
                    // Already handled in notifyDataChanged
                });
            },
            
            // FIXED: Improved app waiting with better error handling
            async waitForAppReady() {
                const maxAttempts = 100; // Increased attempts
                const checkInterval = 100; // Check every 100ms
                let attempts = 0;
                
                return new Promise((resolve, reject) => {
                    const checkApp = () => {
                        attempts++;
                        
                        if (window.pulseApp && window.pulseApp.chart) {
                            console.log('‚úÖ Main app found and ready, hooking into data flow');
                            this.hookIntoApp();
                            
                            // Execute any pending callbacks
                            this.appReadyCallbacks.forEach(callback => callback());
                            this.appReadyCallbacks = [];
                            
                            resolve();
                            return;
                        }
                        
                        if (attempts >= maxAttempts) {
                            console.warn('‚ö†Ô∏è Main app not found after maximum attempts');
                            // Don't reject, just continue without app connection
                            resolve();
                            return;
                        }
                        
                        // Continue checking
                        setTimeout(checkApp, checkInterval);
                    };
                    
                    checkApp();
                });
            },
            
            hookIntoApp() {
                const app = window.pulseApp;
                if (!app) return;
                
                // Hook into dataset loading
                const originalLoadDataset = app.loadDataset.bind(app);
                app.loadDataset = async function(datasetKey) {
                    const result = await originalLoadDataset(datasetKey);
                    window.PulseDataBridge.setData(result, `dataset-${datasetKey}`);
                    return result;
                };
                
                // Register chart instance
                if (app.chart) {
                    this.setChartInstance(app.chart);
                }
                
                // Get initial data if available
                const initialData = app.getCurrentData();
                if (initialData) {
                    this.setData(initialData, 'app-initial');
                }
                
                console.log('üîó Successfully hooked into main app');
            },
            
            handleTabSwitch(tabName) {
                console.log(`üîÑ Tab switched to: ${tabName}`);
                
                if (tabName === 'data-builder') {
                    // Ensure data is available when switching to data builder
                    if (!this.currentData && window.pulseApp) {
                        const appData = window.pulseApp.getCurrentData();
                        if (appData) {
                            this.currentData = appData;
                            console.log('üìä Retrieved data from app for data builder');
                        }
                    }
                    
                    // Short delay to ensure tab switch is complete, then refresh
                    setTimeout(() => {
                        this.refreshDataBuilder();
                    }, 50);
                } else if (tabName === 'chart-view') {
                    const data = this.getData();
                    if (data && this.chartInstance) {
                        this.chartInstance.render(data);
                    }
                }
            }
        };

        // Initialize Data Bridge immediately
        window.PulseDataBridge.init();
    </script>
    
    <!-- Real-time Data Builder Functions -->
    <script>
        let currentMainTab = 'chart-view';
        let templateData = {
            metadata: {
                title: "Financial Flow",
                subtitle: "Current Data", 
                currency: "USD",
                unit: "millions",
                company: "Your Company",
                period: "Current Period"
            },
            nodes: [],
            links: []
        };

        // Debounce function for real-time updates
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Debounced real-time update function
        const debouncedRealTimeUpdate = debounce(() => {
            if (window.PulseDataBridge.realTimeMode) {
                console.log('‚ö° Triggering debounced real-time update');
                window.PulseDataBridge.applyImmediateChange(templateData);
            }
        }, 500);

        // Toggle real-time mode
        function toggleRealTimeMode() {
            const currentMode = window.PulseDataBridge.realTimeMode;
            const newMode = !currentMode;
            window.PulseDataBridge.setRealTimeMode(newMode);
            
            // Update UI to reflect current state
            const indicator = document.getElementById('realtime-indicator');
            const button = document.getElementById('realtime-toggle');
            
            if (indicator && button) {
                if (newMode) {
                    indicator.className = 'realtime-indicator live';
                    button.textContent = '‚ö™ Disable Live Updates';
                    button.className = 'btn btn-secondary';
                } else {
                    indicator.className = 'realtime-indicator manual';
                    button.textContent = 'üî¥ Enable Live Updates';
                    button.className = 'btn btn-primary';
                }
            }
            
            console.log(`üîÑ Real-time mode ${newMode ? 'ENABLED' : 'DISABLED'}`);
        }

        // Enhanced tab switching
        function switchMainTab(tabName) {
            console.log(`üéØ Switching to tab: ${tabName}`);
            
            document.querySelectorAll('.main-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            const targetTab = document.querySelector(`[onclick="switchMainTab('${tabName}')"]`);
            if (targetTab) {
                targetTab.classList.add('active');
            }
            
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            const targetContent = document.getElementById(tabName);
            if (targetContent) {
                targetContent.classList.add('active');
            }
            
            currentMainTab = tabName;
            
            window.dispatchEvent(new CustomEvent('pulseTabSwitch', {
                detail: { tabName }
            }));
            
            if (tabName === 'data-builder') {
                // Immediately try to initialize, with better error handling
                setTimeout(() => {
                    initializeDataBuilder();
                }, 100); // Small delay to ensure tab is fully switched
            }
        }

        function initializeDataBuilder() {
            console.log('üîß Initializing Data Builder...');
            
            // Try multiple methods to get data with better debugging
            let data = null;
            
            // Method 1: Direct from Data Bridge
            if (window.PulseDataBridge && window.PulseDataBridge.currentData) {
                data = window.PulseDataBridge.currentData;
                console.log('üìä Found data from Data Bridge currentData:', data);
            }
            
            // Method 2: From main app
            else if (window.pulseApp && window.pulseApp.getCurrentData()) {
                data = window.pulseApp.getCurrentData();
                console.log('üìä Found data from pulseApp.getCurrentData():', data);
                // Store in bridge for future use
                if (window.PulseDataBridge) {
                    window.PulseDataBridge.currentData = data;
                }
            }
            
            // Method 3: From chart instance
            else if (window.pulseApp && window.pulseApp.getCurrentChart() && window.pulseApp.getCurrentChart().data) {
                data = window.pulseApp.getCurrentChart().data;
                console.log('üìä Found data from chart instance:', data);
                // Store in bridge for future use
                if (window.PulseDataBridge) {
                    window.PulseDataBridge.currentData = data;
                }
            }
            
            if (data && data.nodes && data.links) {
                console.log('‚úÖ Successfully found data for Data Builder');
                
                templateData = {
                    metadata: {
                        title: data.metadata?.title || "Financial Flow",
                        subtitle: data.metadata?.subtitle || "Live Chart Data",
                        currency: data.metadata?.currency || "USD",
                        unit: data.metadata?.unit || "millions",
                        company: data.metadata?.company || "Your Company",
                        period: data.metadata?.period || "Current Period"
                    },
                    nodes: JSON.parse(JSON.stringify(data.nodes || [])),
                    links: JSON.parse(JSON.stringify(data.links || []))
                };
                
                updateMetadataInputs();
                renderTemplateData();
                
                // Turn on live updates by default
                if (!window.PulseDataBridge.realTimeMode) {
                    toggleRealTimeMode();
                }
                
                console.log('‚úÖ Data Builder initialized with live data and live updates enabled');
            } else {
                console.log('‚ö†Ô∏è No data found - checking if app is still loading...');
                
                // If app exists but no data, it might still be loading
                if (window.pulseApp) {
                    console.log('üì± App exists but no data - will retry in 500ms');
                    
                    // Retry once after a short delay
                    setTimeout(() => {
                        const retryData = window.pulseApp.getCurrentData();
                        if (retryData) {
                            console.log('‚úÖ Found data on retry!');
                            initializeDataBuilder(); // Recursive call with data now available
                        } else {
                            console.log('üìù Still no data after retry - Data Builder ready for manual input');
                        }
                    }, 500);
                } else {
                    console.log('üìù No app found - Data Builder ready for manual input');
                }
            }
        }

        function loadCurrentChartData() {
            const data = window.PulseDataBridge.getData();
            if (data) {
                templateData = {
                    metadata: {
                        title: data.metadata?.title || "Financial Flow",
                        subtitle: data.metadata?.subtitle || "From Chart View",
                        currency: data.metadata?.currency || "USD",
                        unit: data.metadata?.unit || "millions",
                        company: data.metadata?.company || "Your Company",
                        period: data.metadata?.period || "Current Period"
                    },
                    nodes: JSON.parse(JSON.stringify(data.nodes || [])),
                    links: JSON.parse(JSON.stringify(data.links || []))
                };
                
                updateMetadataInputs();
                renderTemplateData();
                
                // Hide the load button since data is now loaded
                const loadButton = document.querySelector('[onclick="loadCurrentChartData()"]');
                if (loadButton) {
                    loadButton.style.display = 'none';
                }
                
                alert('‚úÖ Successfully loaded current chart data for editing!');
            } else {
                alert('‚ùå No chart data available. Please load a dataset in Chart View first.');
            }
        }

        function resetToChartData() {
            const proceed = confirm('This will reset all your changes to match the current chart data. Continue?');
            if (proceed) {
                loadCurrentChartData();
            }
        }

        function updateMetadataInputs() {
            const fields = [
                { id: 'company-name', value: templateData.metadata.company },
                { id: 'subtitle', value: templateData.metadata.subtitle },
                { id: 'period', value: templateData.metadata.period },
                { id: 'currency', value: templateData.metadata.currency },
                { id: 'units', value: templateData.metadata.unit }
            ];
            
            fields.forEach(({ id, value }) => {
                const element = document.getElementById(id);
                if (element && value) {
                    element.value = value;
                }
            });
        }

        function applyDataAndSwitchToChart() {
            console.log('üöÄ Applying Data Builder changes...');
            
            templateData.metadata.company = document.getElementById('company-name').value;
            templateData.metadata.subtitle = document.getElementById('subtitle').value;
            templateData.metadata.period = document.getElementById('period').value;
            templateData.metadata.currency = document.getElementById('currency').value;
            templateData.metadata.unit = document.getElementById('units').value;
            templateData.metadata.title = `${templateData.metadata.company} Financial Flow`;
            
            window.PulseDataBridge.applyDataBuilderChanges(templateData);
            
            switchMainTab('chart-view');
            
            console.log('‚úÖ Changes applied and switched to Chart View');
        }

        // Template functions
        function loadAdobeTemplate() {
            templateData = {
                metadata: {
                    title: "Adobe Financial Flow",
                    subtitle: "Multi-Layer Subscription Model",
                    currency: "USD",
                    unit: "millions",
                    company: "Adobe Inc.",
                    period: "Q3 2025"
                },
                nodes: [
                    // Layer 0: Revenue Sources
                    {id: "Creative Cloud", depth: 0, value: 2800, category: "revenue", description: "Photoshop, Illustrator, etc."},
                    {id: "Document Cloud", depth: 0, value: 600, category: "revenue", description: "Acrobat, Sign, etc."},
                    {id: "Experience Cloud", depth: 0, value: 1200, category: "revenue", description: "Analytics, Commerce, etc."},
                    
                    // Layer 1: Total Revenue
                    {id: "Total Revenue", depth: 1, value: 4600, category: "revenue", description: "All revenue combined"},
                    
                    // Layer 2: Profit/Cost Split
                    {id: "Gross Profit", depth: 2, value: 3800, category: "profit", description: "Revenue minus direct costs"},
                    {id: "Cost of Revenue", depth: 2, value: 800, category: "cost", description: "Direct service costs"},
                    
                    // Layer 3: Operating Results
                    {id: "Operating Profit", depth: 3, value: 1400, category: "profit", description: "Profit from operations"},
                    {id: "Operating Expenses", depth: 3, value: 2400, category: "expense", description: "Total operating expenses"},
                    
                    // Layer 4: Final Results & Expense Breakdown
                    {id: "Net Income", depth: 4, value: 1100, category: "income", description: "Final net income"},
                    {id: "Taxes & Other", depth: 4, value: 300, category: "expense", description: "Taxes and other expenses"},
                    {id: "R&D", depth: 4, value: 1200, category: "expense", description: "Research and development"},
                    {id: "Sales & Marketing", depth: 4, value: 800, category: "expense", description: "Customer acquisition"},
                    {id: "General & Admin", depth: 4, value: 400, category: "expense", description: "Administrative costs"}
                ],
                links: [
                    // Revenue to Total
                    {source: "Creative Cloud", target: "Total Revenue", value: 2800, type: "revenue_flow"},
                    {source: "Document Cloud", target: "Total Revenue", value: 600, type: "revenue_flow"},
                    {source: "Experience Cloud", target: "Total Revenue", value: 1200, type: "revenue_flow"},
                    
                    // Total Revenue split
                    {source: "Total Revenue", target: "Gross Profit", value: 3800, type: "profit_flow"},
                    {source: "Total Revenue", target: "Cost of Revenue", value: 800, type: "cost_flow"},
                    
                    // Gross Profit split
                    {source: "Gross Profit", target: "Operating Profit", value: 1400, type: "profit_flow"},
                    {source: "Gross Profit", target: "Operating Expenses", value: 2400, type: "expense_flow"},
                    
                    // Operating Profit split
                    {source: "Operating Profit", target: "Net Income", value: 1100, type: "final_flow"},
                    {source: "Operating Profit", target: "Taxes & Other", value: 300, type: "expense_flow"},
                    
                    // Operating Expenses breakdown
                    {source: "Operating Expenses", target: "R&D", value: 1200, type: "expense_flow"},
                    {source: "Operating Expenses", target: "Sales & Marketing", value: 800, type: "expense_flow"},
                    {source: "Operating Expenses", target: "General & Admin", value: 400, type: "expense_flow"}
                ]
            };
            
            updateMetadataInputs();
            renderTemplateData();
            console.log('‚úÖ Loaded Adobe template');
        }

        function loadBlankTemplate() {
            if (confirm('This will clear all current data and start fresh. Continue?')) {
                templateData = {
                    metadata: {
                        title: "Your Company Financial Flow",
                        subtitle: "Financial Performance",
                        currency: "USD",
                        unit: "millions",
                        company: "Your Company",
                        period: "Q3 2025"
                    },
                    nodes: [
                        {id: "Revenue Source", depth: 0, value: 100, category: "revenue", description: "Start building your structure here"}
                    ],
                    links: []
                };
                
                updateMetadataInputs();
                renderTemplateData();
                console.log('‚úÖ Loaded blank template');
            }
        }

        function renderTemplateData() {
            renderNodes();
            renderLinks();
            
            // Hide the manual load button since data loaded automatically
            const loadButton = document.querySelector('[onclick="loadCurrentChartData()"]');
            if (loadButton && templateData.nodes.length > 0) {
                loadButton.style.display = 'none';
            } else if (loadButton) {
                loadButton.style.display = 'block';
            }
        }

        function renderNodes() {
            const container = document.getElementById('nodes-container');
            container.innerHTML = '';
            
            if (templateData.nodes.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: #6b7280;">No nodes available. Load template or chart data first.</div>';
                return;
            }
            
            templateData.nodes.forEach((node, index) => {
                const nodeDiv = createNodeEditor(node, index);
                container.appendChild(nodeDiv);
            });
        }

        function renderLinks() {
            const container = document.getElementById('links-container');
            container.innerHTML = '';
            
            if (templateData.links.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: #6b7280;">No connections available. Add nodes first, then create connections.</div>';
                return;
            }
            
            templateData.links.forEach((link, index) => {
                const linkDiv = createLinkEditor(link, index);
                container.appendChild(linkDiv);
            });
        }

        function createNodeEditor(node, index) {
            const div = document.createElement('div');
            div.className = 'data-item';
            div.innerHTML = `
                <button class="remove-item" onclick="removeNode(${index})" title="Remove Node">√ó</button>
                <div class="item-fields">
                    <div class="field-group">
                        <label class="field-label">Name</label>
                        <input type="text" class="field-input" value="${node.id}" 
                               oninput="updateNode(${index}, 'id', this.value)">
                    </div>
                    <div class="field-group">
                        <label class="field-label">Value</label>
                        <input type="number" class="field-input" value="${node.value}" 
                               oninput="updateNode(${index}, 'value', parseFloat(this.value) || 0)">
                    </div>
                    <div class="field-group">
                        <label class="field-label">Layer</label>
                        <input type="number" class="field-input depth-input" value="${node.depth}" 
                               min="0" max="20"
                               oninput="updateNode(${index}, 'depth', parseInt(this.value) || 0)">
                    </div>
                    <div class="field-group">
                        <label class="field-label">Category</label>
                        <select class="field-input" onchange="updateNode(${index}, 'category', this.value)">
                            <option value="revenue" ${node.category === 'revenue' ? 'selected' : ''}>Revenue</option>
                            <option value="cost" ${node.category === 'cost' ? 'selected' : ''}>Cost</option>
                            <option value="profit" ${node.category === 'profit' ? 'selected' : ''}>Profit</option>
                            <option value="expense" ${node.category === 'expense' ? 'selected' : ''}>Expense</option>
                            <option value="income" ${node.category === 'income' ? 'selected' : ''}>Income</option>
                        </select>
                    </div>
                </div>
            `;
            return div;
        }

        function createLinkEditor(link, index) {
            const div = document.createElement('div');
            div.className = 'link-item';
            div.innerHTML = `
                <button class="remove-item" onclick="removeLink(${index})" title="Remove Link">√ó</button>
                <div class="link-fields">
                    <div class="field-group">
                        <label class="field-label">Source</label>
                        <select class="node-selector" onchange="updateLink(${index}, 'source', this.value)">
                            ${templateData.nodes.map(node => 
                                `<option value="${node.id}" ${node.id === link.source ? 'selected' : ''}>${node.id}</option>`
                            ).join('')}
                        </select>
                    </div>
                    <div class="field-group">
                        <label class="field-label">Target</label>
                        <select class="node-selector" onchange="updateLink(${index}, 'target', this.value)">
                            ${templateData.nodes.map(node => 
                                `<option value="${node.id}" ${node.id === link.target ? 'selected' : ''}>${node.id}</option>`
                            ).join('')}
                        </select>
                    </div>
                    <div class="field-group">
                        <label class="field-label">Value</label>
                        <input type="number" class="field-input" value="${link.value}" 
                               onchange="updateLink(${index}, 'value', parseFloat(this.value) || 0)">
                    </div>
                </div>
            `;
            return div;
        }

        function updateNode(index, field, value) {
            if (templateData.nodes[index]) {
                templateData.nodes[index][field] = value;
                
                if (field === 'id') {
                    const oldId = templateData.nodes[index].id;
                    templateData.links.forEach(link => {
                        if (link.source === oldId) link.source = value;
                        if (link.target === oldId) link.target = value;
                    });
                    renderLinks();
                }
                
                debouncedRealTimeUpdate();
            }
        }

        function updateLink(index, field, value) {
            if (templateData.links[index]) {
                templateData.links[index][field] = value;
                debouncedRealTimeUpdate();
            }
        }

        function addNode() {
            const newNode = {
                id: `New Node ${Date.now()}`,
                depth: Math.max(...templateData.nodes.map(n => n.depth), -1) + 1,
                value: 100,
                category: "revenue"
            };
            templateData.nodes.push(newNode);
            renderTemplateData();
            debouncedRealTimeUpdate();
        }

        function removeNode(index) {
            const nodeId = templateData.nodes[index].id;
            templateData.nodes.splice(index, 1);
            templateData.links = templateData.links.filter(l => l.source !== nodeId && l.target !== nodeId);
            renderTemplateData();
            debouncedRealTimeUpdate();
        }

        function addCustomLink() {
            if (templateData.nodes.length >= 2) {
                const newLink = {
                    source: templateData.nodes[0].id,
                    target: templateData.nodes[1].id,
                    value: 100,
                    type: "revenue_flow"
                };
                templateData.links.push(newLink);
                renderTemplateData();
                debouncedRealTimeUpdate();
            } else {
                alert('Need at least 2 nodes to create a connection');
            }
        }

        function removeLink(index) {
            templateData.links.splice(index, 1);
            renderTemplateData();
            debouncedRealTimeUpdate();
        }

        function validateStructure() {
            const errors = [];
            if (templateData.nodes.length === 0) errors.push('No nodes defined');
            if (templateData.links.length === 0) errors.push('No links defined');
            
            const linkedNodes = new Set();
            templateData.links.forEach(link => {
                linkedNodes.add(link.source);
                linkedNodes.add(link.target);
            });
            
            const orphans = templateData.nodes.filter(node => !linkedNodes.has(node.id));
            if (orphans.length > 0) {
                errors.push(`Orphaned nodes: ${orphans.map(n => n.id).join(', ')}`);
            }
            
            if (errors.length > 0) {
                alert('‚ùå Validation errors:\n' + errors.join('\n'));
            } else {
                alert('‚úÖ Structure validation passed!');
            }
        }

        function exportCurrentData() {
            const dataStr = JSON.stringify(templateData, null, 2);
            const blob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'pulse-chart-data.json';
            link.click();
            URL.revokeObjectURL(url);
        }

        // Setup metadata change listeners with real-time support
        document.addEventListener('DOMContentLoaded', function() {
            const metadataFields = ['company-name', 'subtitle', 'period', 'currency', 'units'];
            const fieldMapping = {
                'company-name': 'company',
                'subtitle': 'subtitle',
                'period': 'period', 
                'currency': 'currency',
                'units': 'unit'
            };
            
            metadataFields.forEach(fieldId => {
                const element = document.getElementById(fieldId);
                if (element) {
                    element.addEventListener('input', function() {
                        templateData.metadata[fieldMapping[fieldId]] = this.value;
                        if (fieldId === 'company-name') {
                            templateData.metadata.title = `${this.value} Financial Flow`;
                        }
                        debouncedRealTimeUpdate();
                    });
                }
            });
        });
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pulse Analytics Platform</title>
    
    <!-- External Dependencies -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-sankey/0.12.3/d3-sankey.min.js"></script>
    
    <!-- Consolidated Application Styles -->
    <link rel="stylesheet" href="css/pulse-analytics.css">
    
    <style>
        .main-tabs {
            display: flex;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 0 20px;
        }
        
        .main-tab {
            background: transparent;
            border: none;
            color: rgba(255,255,255,0.7);
            padding: 16px 24px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
            border-bottom: 3px solid transparent;
        }
        
        .main-tab:hover {
            color: rgba(255,255,255,0.9);
            background: rgba(255,255,255,0.1);
        }
        
        .main-tab.active {
            color: white;
            border-bottom-color: #f59e0b;
            background: rgba(255,255,255,0.1);
        }
        
        .tab-content {
            display: none;
            min-height: calc(100vh - 140px);
        }
        
        .tab-content.active {
            display: block;
        }

        /* Simplified status styles - removed confusing ones */
        .data-builder-status {
            background: #d1fae5;
            border: 1px solid #a7f3d0;
            border-radius: 6px;
            padding: 12px 16px;
            margin-bottom: 20px;
            font-size: 13px;
            color: #065f46;
            display: none; /* Hide by default - only show when needed */
        }

        .realtime-controls {
            background: #f0f9ff;
            border: 1px solid #0ea5e9;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .realtime-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }

        .realtime-indicator.live {
            background-color: #ef4444;
        }

        .realtime-indicator.manual {
            background-color: #6b7280;
            animation: none;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="pulse-app">
        <!-- Application Header -->
        <header class="app-header">
            <h1>Pulse Analytics Platform</h1>
            <div class="header-controls">
                <div class="data-selector">
                    <label for="data-select" style="color: white; margin-right: 8px;">Data:</label>
                    <select id="data-select">
                        <option value="saas">SaaS Company (Sample)</option>
                        <option value="manufacturing">Manufacturing Corp</option>
                        <option value="retail">Retail Chain</option>
                        <option value="custom">üìÅ Load Custom Data...</option>
                    </select>
                </div>
                <div class="chart-selector">
                    <label for="chart-type-select" style="color: white; margin-right: 8px;">Chart:</label>
                    <select id="chart-type-select">
                        <option value="sankey">üåä Sankey Flow</option>
                        <option value="bar">üìä Bar Chart</option>
                        <option value="line">üìà Line Chart</option>
                    </select>
                </div>
            </div>
        </header>

        <!-- Main Tabs Navigation -->
        <div class="main-tabs">
            <button class="main-tab" onclick="switchMainTab('data-builder')">
                üìã Data Builder
            </button>
            <button class="main-tab active" onclick="switchMainTab('chart-view')">
                üìä Chart View
            </button>
        </div>

        <!-- Data Builder Tab -->
        <div id="data-builder" class="tab-content" style="background: #f8f9fa;">
            <div class="template-container">
                <div class="template-main">
                    <div class="template-header">
                        <h1>üìä Real-time Data Builder</h1>
                        <span class="feature-badge">‚ö° Live Updates</span>
                        <p>Edit chart data with instant live preview synchronization</p>
                    </div>

                    <!-- Simplified Status (only shown when there's actually no data) -->
                    <div id="data-builder-status" class="data-builder-status">
                        <strong>‚ùå No Chart Data Available</strong>
                        <div>Load a dataset in Chart View first, then return here to edit</div>
                    </div>

                    <!-- Real-time Controls -->
                    <div class="realtime-controls">
                        <h4 style="margin: 0 0 10px 0; color: #0369a1;">
                            <span id="realtime-indicator" class="realtime-indicator manual"></span>
                            Live Update Mode
                        </h4>
                        <div style="display: flex; gap: 12px; align-items: center;">
                            <button id="realtime-toggle" class="btn btn-primary" onclick="toggleRealTimeMode()">
                                üî¥ Enable Live Updates
                            </button>
                            <div style="font-size: 12px; color: #6b7280;">
                                <strong>Manual:</strong> Changes apply when you click "Apply Changes"<br>
                                <strong>Live:</strong> Changes apply automatically as you type (500ms delay)
                            </div>
                        </div>
                    </div>

                    <div class="template-content">
                        <!-- Quick Actions -->
                        <div class="layer-management">
                            <h3 style="margin: 0 0 10px 0; color: #92400e;">‚ö° Quick Actions</h3>
                            <div class="layer-controls">
                                <button class="layer-btn" onclick="loadSaaSTemplate()">SaaS Template</button>
                                <button class="layer-btn" onclick="loadManufacturingTemplate()">Manufacturing</button>
                                <button class="layer-btn" onclick="loadRetailTemplate()">Retail Chain</button>
                                <button class="layer-btn secondary" onclick="loadBlankTemplate()">Blank Template</button>
                            </div>
                        </div>

                        <!-- Metadata Section -->
                        <div class="data-section">
                            <div class="section-header">
                                <h3 class="section-title">üìã Company Information</h3>
                            </div>
                            <div class="section-content">
                                <div class="metadata-grid">
                                    <div class="field-group">
                                        <label class="field-label">Company Name</label>
                                        <input type="text" class="field-input" id="company-name" value="" placeholder="Your Company Name">
                                    </div>
                                    <div class="field-group">
                                        <label class="field-label">Period</label>
                                        <input type="text" class="field-input" id="period" value="" placeholder="Q3 2025">
                                    </div>
                                    <div class="field-group">
                                        <label class="field-label">Currency</label>
                                        <select class="field-input" id="currency">
                                            <option value="USD">USD ($)</option>
                                            <option value="EUR">EUR (‚Ç¨)</option>
                                            <option value="GBP">GBP (¬£)</option>
                                        </select>
                                    </div>
                                    <div class="field-group">
                                        <label class="field-label">Units</label>
                                        <select class="field-input" id="units">
                                            <option value="millions">Millions</option>
                                            <option value="billions">Billions</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Nodes Editor -->
                        <div class="data-section">
                            <div class="section-header">
                                <h3 class="section-title">üéØ Nodes</h3>
                                <button class="add-item-btn" onclick="addNode()">+ Add Node</button>
                            </div>
                            <div class="section-content">
                                <div id="nodes-container">
                                    <div style="text-align: center; padding: 40px; color: #6b7280;">
                                        üìä Load a dataset in Chart View to start editing.
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Links Editor -->
                        <div class="data-section">
                            <div class="section-header">
                                <h3 class="section-title">üîó Flow Connections</h3>
                                <button class="add-item-btn" onclick="addCustomLink()">+ Add Connection</button>
                            </div>
                            <div class="section-content">
                                <div id="links-container">
                                    <div style="text-align: center; padding: 40px; color: #6b7280;">
                                        üîó No connections available. Load chart data first.
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="action-buttons">
                            <button class="btn btn-primary" onclick="applyDataAndSwitchToChart()">üöÄ Apply Changes</button>
                            <button class="btn btn-secondary" onclick="validateStructure()">‚úÖ Validate</button>
                            <button class="btn btn-secondary" onclick="exportCurrentData()">üíæ Export</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chart View Tab (Original) -->
        <div id="chart-view" class="tab-content active">
            <div class="app-content">
                <!-- Chart Area -->
                <div class="chart-area">
                    <!-- Chart Toolbar -->
                    <div class="chart-toolbar">
                        <div class="data-controls">
                            <span id="data-status" class="status-indicator status-loading">Loading...</span>
                        </div>
                        
                        <div class="export-controls">
                            <button id="export-png" class="btn btn-primary">üñºÔ∏è PNG</button>
                            <button id="export-svg" class="btn btn-primary">üìê SVG</button>
                            <button id="export-data" class="btn btn-primary">üìä CSV</button>
                        </div>
                    </div>
                    
                    <!-- Chart Container -->
                    <div id="main-chart" class="chart-container">
                        <div class="chart-loading">
                            <div class="loading-spinner"></div>
                            <p>Initializing Pulse Analytics Platform...</p>
                        </div>
                    </div>
                </div>

                <!-- Enhanced Control Panel with Colors -->
                <div class="control-panel">
                    <div class="control-panel-header">
                        <h3>Chart Controls</h3>
                        <button id="reset-defaults" class="btn btn-outline">üîÑ Reset</button>
                    </div>
                    
                    <div id="dynamic-controls" class="control-panel-content">
                        <div style="padding: 40px 20px; text-align: center; color: #6b7280;">
                            <div style="font-size: 24px; margin-bottom: 8px;">‚öôÔ∏è</div>
                            <p>Loading chart controls...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden file input -->
    <input type="file" id="file-input" style="display: none;" accept=".json">

    <!-- Core Scripts -->
    <script src="js/core/DataManager.js"></script>
    <script src="js/core/ControlPanel.js"></script>
    <script src="js/charts/sankey/SankeyChart.js"></script>
    <script src="js/charts/sankey/SankeyControls.js"></script>
    
    <!-- Enhanced app.js with Data Bridge support -->
    <script src="js/app.js"></script>
    
    <!-- SIMPLIFIED Data Bridge - Auto-loading Fixed -->
    <script>
        // Simplified Data Bridge with working auto-loading
        window.PulseDataBridge = {
            currentData: null,
            chartInstance: null,
            realTimeMode: false,
            
            init() {
                console.log('üåâ Simplified Data Bridge initialized');
                this.setupEventListeners();
            },
            
            setData(data, source = 'unknown') {
                this.currentData = data;
                console.log(`üìä Data updated from ${source}:`, data);
                
                // If we're on data builder tab, auto-update it
                if (window.currentMainTab === 'data-builder') {
                    this.autoLoadDataBuilder();
                }
            },
            
            getData() {
                // Try multiple sources to get current data
                if (this.currentData) {
                    return this.currentData;
                }
                
                if (window.pulseApp?.getCurrentData) {
                    this.currentData = window.pulseApp.getCurrentData();
                    return this.currentData;
                }
                
                return null;
            },
            
            setChartInstance(chart) {
                this.chartInstance = chart;
                console.log('üìà Chart instance registered');
            },
            
            // FIXED: Auto-loading function that actually works
            autoLoadDataBuilder() {
                console.log('üîß Auto-loading Data Builder...');
                
                const data = this.getData();
                
                if (data && data.nodes && data.links) {
                    console.log('‚úÖ Found data, loading into Data Builder:', data);
                    
                    // Update global template data
                    window.templateData = {
                        metadata: data.metadata || {
                            title: "Financial Flow",
                            subtitle: "Live Chart Data",
                            currency: "USD",
                            unit: "millions",
                            company: "Your Company",
                            period: "Current Period"
                        },
                        nodes: JSON.parse(JSON.stringify(data.nodes || [])),
                        links: JSON.parse(JSON.stringify(data.links || []))
                    };
                    
                    // Update the UI
                    this.updateMetadataInputs();
                    this.renderTemplateData();
                    this.hideNoDataStatus();
                    
                } else {
                    console.log('üìù No data available, showing no-data status');
                    this.showNoDataStatus();
                }
            },
            
            updateMetadataInputs() {
                const fields = [
                    { id: 'company-name', value: window.templateData.metadata.company },
                    { id: 'period', value: window.templateData.metadata.period },
                    { id: 'currency', value: window.templateData.metadata.currency },
                    { id: 'units', value: window.templateData.metadata.unit }
                ];
                
                fields.forEach(({ id, value }) => {
                    const element = document.getElementById(id);
                    if (element && value) {
                        element.value = value;
                    }
                });
            },
            
            renderTemplateData() {
                if (typeof renderTemplateData === 'function') {
                    renderTemplateData();
                } else {
                    // Fallback rendering
                    this.renderNodes();
                    this.renderLinks();
                }
            },
            
            renderNodes() {
                const container = document.getElementById('nodes-container');
                if (!container) return;
                
                container.innerHTML = '';
                
                if (!window.templateData.nodes || window.templateData.nodes.length === 0) {
                    container.innerHTML = '<div style="text-align: center; padding: 40px; color: #6b7280;">No nodes available.</div>';
                    return;
                }
                
                window.templateData.nodes.forEach((node, index) => {
                    const nodeDiv = this.createNodeEditor(node, index);
                    container.appendChild(nodeDiv);
                });
            },
            
            renderLinks() {
                const container = document.getElementById('links-container');
                if (!container) return;
                
                container.innerHTML = '';
                
                if (!window.templateData.links || window.templateData.links.length === 0) {
                    container.innerHTML = '<div style="text-align: center; padding: 40px; color: #6b7280;">No connections available.</div>';
                    return;
                }
                
                window.templateData.links.forEach((link, index) => {
                    const linkDiv = this.createLinkEditor(link, index);
                    container.appendChild(linkDiv);
                });
            },
            
            createNodeEditor(node, index) {
                const div = document.createElement('div');
                div.className = 'data-item';
                div.innerHTML = `
                    <button class="remove-item" onclick="removeNode(${index})" title="Remove Node">√ó</button>
                    <div class="item-fields">
                        <div class="field-group">
                            <label class="field-label">Name</label>
                            <input type="text" class="field-input" value="${node.id}" 
                                   oninput="updateNode(${index}, 'id', this.value)">
                        </div>
                        <div class="field-group">
                            <label class="field-label">Value</label>
                            <input type="number" class="field-input" value="${node.value}" 
                                   oninput="updateNode(${index}, 'value', parseFloat(this.value) || 0)">
                        </div>
                        <div class="field-group">
                            <label class="field-label">Layer</label>
                            <input type="number" class="field-input depth-input" value="${node.depth}" 
                                   min="0" max="20"
                                   oninput="updateNode(${index}, 'depth', parseInt(this.value) || 0)">
                        </div>
                        <div class="field-group">
                            <label class="field-label">Category</label>
                            <select class="field-input" onchange="updateNode(${index}, 'category', this.value)">
                                <option value="revenue" ${node.category === 'revenue' ? 'selected' : ''}>Revenue</option>
                                <option value="cost" ${node.category === 'cost' ? 'selected' : ''}>Cost</option>
                                <option value="profit" ${node.category === 'profit' ? 'selected' : ''}>Profit</option>
                                <option value="expense" ${node.category === 'expense' ? 'selected' : ''}>Expense</option>
                                <option value="income" ${node.category === 'income' ? 'selected' : ''}>Income</option>
                            </select>
                        </div>
                    </div>
                `;
                return div;
            },
            
            createLinkEditor(link, index) {
                const div = document.createElement('div');
                div.className = 'link-item';
                div.innerHTML = `
                    <button class="remove-item" onclick="removeLink(${index})" title="Remove Link">√ó</button>
                    <div class="link-fields">
                        <div class="field-group">
                            <label class="field-label">Source</label>
                            <select class="node-selector" onchange="updateLink(${index}, 'source', this.value)">
                                ${window.templateData.nodes.map(node => 
                                    `<option value="${node.id}" ${node.id === link.source ? 'selected' : ''}>${node.id}</option>`
                                ).join('')}
                            </select>
                        </div>
                        <div class="field-group">
                            <label class="field-label">Target</label>
                            <select class="node-selector" onchange="updateLink(${index}, 'target', this.value)">
                                ${window.templateData.nodes.map(node => 
                                    `<option value="${node.id}" ${node.id === link.target ? 'selected' : ''}>${node.id}</option>`
                                ).join('')}
                            </select>
                        </div>
                        <div class="field-group">
                            <label class="field-label">Value</label>
                            <input type="number" class="field-input" value="${link.value}" 
                                   onchange="updateLink(${index}, 'value', parseFloat(this.value) || 0)">
                        </div>
                    </div>
                `;
                return div;
            },
            
            showNoDataStatus() {
                const status = document.getElementById('data-builder-status');
                if (status) {
                    status.style.display = 'block';
                }
            },
            
            hideNoDataStatus() {
                const status = document.getElementById('data-builder-status');
                if (status) {
                    status.style.display = 'none';
                }
            },
            
            setRealTimeMode(enabled) {
                this.realTimeMode = enabled;
                console.log(`üîÑ Real-time mode ${enabled ? 'ENABLED' : 'DISABLED'}`);
                this.updateRealTimeIndicator();
            },
            
            updateRealTimeIndicator() {
                const indicator = document.getElementById('realtime-indicator');
                const button = document.getElementById('realtime-toggle');
                
                if (indicator && button) {
                    if (this.realTimeMode) {
                        indicator.className = 'realtime-indicator live';
                        button.textContent = '‚ö™ Disable Live Updates';
                        button.className = 'btn btn-secondary';
                    } else {
                        indicator.className = 'realtime-indicator manual';
                        button.textContent = 'üî¥ Enable Live Updates';
                        button.className = 'btn btn-primary';
                    }
                }
            },
            
            setupEventListeners() {
                // Listen for app ready events
                if (window.pulseApp) {
                    this.connectToApp();
                } else {
                    // Wait for app to be ready
                    const checkApp = setInterval(() => {
                        if (window.pulseApp) {
                            clearInterval(checkApp);
                            this.connectToApp();
                        }
                    }, 100);
                    
                    // Stop checking after 10 seconds
                    setTimeout(() => clearInterval(checkApp), 10000);
                }
            },
            
            connectToApp() {
                console.log('üîó Connecting to main app...');
                
                // Register chart instance
                if (window.pulseApp.chart) {
                    this.setChartInstance(window.pulseApp.chart);
                }
                
                // Get initial data
                const initialData = window.pulseApp.getCurrentData();
                if (initialData) {
                    this.setData(initialData, 'app-initial');
                }
                
                // Hook into app data loading
                const originalLoadDataset = window.pulseApp.loadDataset.bind(window.pulseApp);
                window.pulseApp.loadDataset = async function(datasetKey) {
                    const result = await originalLoadDataset(datasetKey);
                    window.PulseDataBridge.setData(result, `dataset-${datasetKey}`);
                    return result;
                };
                
                console.log('‚úÖ Connected to main app');
            }
        };

        // Initialize Data Bridge
        window.PulseDataBridge.init();
    </script>
    
    <!-- FIXED Data Builder Functions -->
    <script>
        let currentMainTab = 'chart-view';
        let templateData = {
            metadata: {
                title: "Financial Flow",
                subtitle: "Current Data", 
                currency: "USD",
                unit: "millions",
                company: "Your Company",
                period: "Current Period"
            },
            nodes: [],
            links: []
        };

        // Debounce function for real-time updates
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Debounced real-time update function
        const debouncedRealTimeUpdate = debounce(() => {
            if (window.PulseDataBridge.realTimeMode) {
                console.log('‚ö° Triggering debounced real-time update');
                window.PulseDataBridge.setData(templateData, 'data-builder-realtime');
            }
        }, 500);

        // Toggle real-time mode
        function toggleRealTimeMode() {
            const currentMode = window.PulseDataBridge.realTimeMode;
            window.PulseDataBridge.setRealTimeMode(!currentMode);
        }

        // FIXED: Tab switching with automatic data loading
        function switchMainTab(tabName) {
            console.log(`üéØ Switching to tab: ${tabName}`);
            
            document.querySelectorAll('.main-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            const targetTab = document.querySelector(`[onclick="switchMainTab('${tabName}')"]`);
            if (targetTab) {
                targetTab.classList.add('active');
            }
            
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            const targetContent = document.getElementById(tabName);
            if (targetContent) {
                targetContent.classList.add('active');
            }
            
            currentMainTab = tabName;
            
            // FIXED: Auto-load data when switching to data-builder
            if (tabName === 'data-builder') {
                setTimeout(() => {
                    window.PulseDataBridge.autoLoadDataBuilder();
                }, 100); // Small delay to ensure DOM is ready
            }
        }

        function updateNode(index, field, value) {
            if (templateData.nodes[index]) {
                if (field === 'id') {
                    const oldId = templateData.nodes[index].id;
                    templateData.links.forEach(link => {
                        if (link.source === oldId) link.source = value;
                        if (link.target === oldId) link.target = value;
                    });
                    window.PulseDataBridge.renderLinks();
                }
                
                templateData.nodes[index][field] = value;
                debouncedRealTimeUpdate();
            }
        }

        function updateLink(index, field, value) {
            if (templateData.links[index]) {
                templateData.links[index][field] = value;
                debouncedRealTimeUpdate();
            }
        }

        function addNode() {
            const newNode = {
                id: `New Node ${Date.now()}`,
                depth: Math.max(...templateData.nodes.map(n => n.depth), -1) + 1,
                value: 100,
                category: "revenue"
            };
            templateData.nodes.push(newNode);
            window.PulseDataBridge.renderTemplateData();
            debouncedRealTimeUpdate();
        }

        function removeNode(index) {
            const nodeId = templateData.nodes[index].id;
            templateData.nodes.splice(index, 1);
            templateData.links = templateData.links.filter(l => l.source !== nodeId && l.target !== nodeId);
            window.PulseDataBridge.renderTemplateData();
            debouncedRealTimeUpdate();
        }

        function addCustomLink() {
            if (templateData.nodes.length >= 2) {
                const newLink = {
                    source: templateData.nodes[0].id,
                    target: templateData.nodes[1].id,
                    value: 100,
                    type: "revenue_flow"
                };
                templateData.links.push(newLink);
                window.PulseDataBridge.renderTemplateData();
                debouncedRealTimeUpdate();
            } else {
                alert('Need at least 2 nodes to create a connection');
            }
        }

        function removeLink(index) {
            templateData.links.splice(index, 1);
            window.PulseDataBridge.renderTemplateData();
            debouncedRealTimeUpdate();
        }

        function applyDataAndSwitchToChart() {
            console.log('üöÄ Applying Data Builder changes...');
            
            templateData.metadata.company = document.getElementById('company-name').value;
            templateData.metadata.period = document.getElementById('period').value;
            templateData.metadata.currency = document.getElementById('currency').value;
            templateData.metadata.unit = document.getElementById('units').value;
            templateData.metadata.title = `${templateData.metadata.company} Financial Flow`;
            
            window.PulseDataBridge.setData(templateData, 'data-builder-apply');
            
            switchMainTab('chart-view');
            
            console.log('‚úÖ Changes applied and switched to Chart View');
        }

        // Template functions
        function loadSaaSTemplate() {
            templateData = {
                metadata: {
                    title: "SaaS Company Financial Flow",
                    subtitle: "Q3 2025 Financial Performance",
                    currency: "USD",
                    unit: "millions",
                    company: "TechFlow SaaS Corp",
                    period: "Q3 2025"
                },
                nodes: [
                    {id: "Subscription Revenue", depth: 0, value: 300, category: "revenue"},
                    {id: "Professional Services", depth: 0, value: 60, category: "revenue"},
                    {id: "Total Revenue", depth: 1, value: 360, category: "revenue"},
                    {id: "Gross Profit", depth: 2, value: 300, category: "profit"},
                    {id: "Operating Profit", depth: 3, value: 100, category: "profit"},
                    {id: "Net Income", depth: 4, value: 75, category: "income"}
                ],
                links: [
                    {source: "Subscription Revenue", target: "Total Revenue", value: 300, type: "revenue_flow"},
                    {source: "Professional Services", target: "Total Revenue", value: 60, type: "revenue_flow"},
                    {source: "Total Revenue", target: "Gross Profit", value: 300, type: "profit_flow"},
                    {source: "Gross Profit", target: "Operating Profit", value: 100, type: "profit_flow"},
                    {source: "Operating Profit", target: "Net Income", value: 75, type: "final_flow"}
                ]
            };
            window.PulseDataBridge.updateMetadataInputs();
            window.PulseDataBridge.renderTemplateData();
            window.PulseDataBridge.hideNoDataStatus();
        }

        function loadManufacturingTemplate() {
            templateData = {
                metadata: {
                    title: "Manufacturing Corp Financial Flow",
                    subtitle: "Q3 2025 Operations",
                    currency: "USD", 
                    unit: "millions",
                    company: "Manufacturing Corp",
                    period: "Q3 2025"
                },
                nodes: [
                    {id: "Product Sales", depth: 0, value: 400, category: "revenue"},
                    {id: "Total Revenue", depth: 1, value: 400, category: "revenue"},
                    {id: "Gross Profit", depth: 2, value: 280, category: "profit"},
                    {id: "Operating Profit", depth: 3, value: 120, category: "profit"},
                    {id: "Net Income", depth: 4, value: 90, category: "income"}
                ],
                links: [
                    {source: "Product Sales", target: "Total Revenue", value: 400, type: "revenue_flow"},
                    {source: "Total Revenue", target: "Gross Profit", value: 280, type: "profit_flow"},
                    {source: "Gross Profit", target: "Operating Profit", value: 120, type: "profit_flow"},
                    {source: "Operating Profit", target: "Net Income", value: 90, type: "final_flow"}
                ]
            };
            window.PulseDataBridge.updateMetadataInputs();
            window.PulseDataBridge.renderTemplateData();
            window.PulseDataBridge.hideNoDataStatus();
        }

        function loadRetailTemplate() {
            templateData = {
                metadata: {
                    title: "Retail Chain Financial Flow",
                    subtitle: "Q3 2025 Performance",
                    currency: "USD",
                    unit: "millions", 
                    company: "Retail Chain Corp",
                    period: "Q3 2025"
                },
                nodes: [
                    {id: "Store Sales", depth: 0, value: 250, category: "revenue"},
                    {id: "Online Sales", depth: 0, value: 150, category: "revenue"},
                    {id: "Total Revenue", depth: 1, value: 400, category: "revenue"},
                    {id: "Gross Profit", depth: 2, value: 200, category: "profit"},
                    {id: "Operating Profit", depth: 3, value: 80, category: "profit"},
                    {id: "Net Income", depth: 4, value: 60, category: "income"}
                ],
                links: [
                    {source: "Store Sales", target: "Total Revenue", value: 250, type: "revenue_flow"},
                    {source: "Online Sales", target: "Total Revenue", value: 150, type: "revenue_flow"},
                    {source: "Total Revenue", target: "Gross Profit", value: 200, type: "profit_flow"},
                    {source: "Gross Profit", target: "Operating Profit", value: 80, type: "profit_flow"},
                    {source: "Operating Profit", target: "Net Income", value: 60, type: "final_flow"}
                ]
            };
            window.PulseDataBridge.updateMetadataInputs();
            window.PulseDataBridge.renderTemplateData();
            window.PulseDataBridge.hideNoDataStatus();
        }

        function loadBlankTemplate() {
            templateData = {
                metadata: {
                    title: "Your Company Financial Flow",
                    subtitle: "Financial Performance",
                    currency: "USD",
                    unit: "millions",
                    company: "Your Company",
                    period: "Q3 2025"
                },
                nodes: [
                    {id: "Revenue Source", depth: 0, value: 100, category: "revenue"}
                ],
                links: []
            };
            window.PulseDataBridge.updateMetadataInputs();
            window.PulseDataBridge.renderTemplateData();
            window.PulseDataBridge.hideNoDataStatus();
        }

        function validateStructure() {
            const errors = [];
            if (templateData.nodes.length === 0) errors.push('No nodes defined');
            if (templateData.links.length === 0) errors.push('No links defined');
            
            const linkedNodes = new Set();
            templateData.links.forEach(link => {
                linkedNodes.add(link.source);
                linkedNodes.add(link.target);
            });
            
            const orphans = templateData.nodes.filter(node => !linkedNodes.has(node.id));
            if (orphans.length > 0) {
                errors.push(`Orphaned nodes: ${orphans.map(n => n.id).join(', ')}`);
            }
            
            if (errors.length > 0) {
                alert('‚ùå Validation errors:\n' + errors.join('\n'));
            } else {
                alert('‚úÖ Structure validation passed!');
            }
        }

        function exportCurrentData() {
            const dataStr = JSON.stringify(templateData, null, 2);
            const blob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'pulse-chart-data.json';
            link.click();
            URL.revokeObjectURL(url);
        }

        // Setup metadata change listeners with real-time support
        document.addEventListener('DOMContentLoaded', function() {
            const metadataFields = ['company-name', 'period', 'currency', 'units'];
            const fieldMapping = {
                'company-name': 'company',
                'period': 'period', 
                'currency': 'currency',
                'units': 'unit'
            };
            
            metadataFields.forEach(fieldId => {
                const element = document.getElementById(fieldId);
                if (element) {
                    element.addEventListener('input', function() {
                        templateData.metadata[fieldMapping[fieldId]] = this.value;
                        if (fieldId === 'company-name') {
                            templateData.metadata.title = `${this.value} Financial Flow`;
                        }
                        debouncedRealTimeUpdate();
                    });
                }
            });
        });
    </script>
</body>
</html>
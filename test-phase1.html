<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phase 1 Category System Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 3px;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
    </style>
</head>
<body>
    <h1>Phase 1 Category Management System Test</h1>
    
    <div class="test-section">
        <h2>Test Status</h2>
        <div id="test-results">
            <div class="test-result info">Loading tests...</div>
        </div>
    </div>
    
    <div class="test-section">
        <h2>Category System Tests</h2>
        <button onclick="testCategoryManager()">Test Category Manager</button>
        <button onclick="testCategoryMethods()">Test Category Methods</button>
        <button onclick="testMetadataIntegration()">Test Metadata Integration</button>
        <button onclick="testBackwardsCompatibility()">Test Backwards Compatibility</button>
    </div>
    
    <div class="test-section">
        <h2>Manual Tests</h2>
        <button onclick="testModal()">Test Category Assignment Modal</button>
        <p><strong>Instructions:</strong> Click the "Test Category Assignment Modal" button to open the modal interface.</p>
    </div>
    
    <div class="test-section">
        <h2>Test Results</h2>
        <div id="detailed-results"></div>
    </div>

    <!-- Include required scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <script src="js/charts/sankey/SankeyChartConfig.js"></script>
    <script src="js/charts/sankey/SankeyChart.js"></script>
    <script src="js/charts/sankey/CategoryAssignmentModal.js"></script>

    <script>
        // Test results container
        const resultsContainer = document.getElementById('detailed-results');
        const testResults = document.getElementById('test-results');
        
        // Mock data for testing
        const mockData = {
            nodes: [
                { id: 'Revenue', category: 'revenue', depth: 0 },
                { id: 'Expenses', category: 'expense', depth: 1 },
                { id: 'Profit', category: 'profit', depth: 2 }
            ],
            links: [
                { source: 'Revenue', target: 'Expenses', value: 1000 },
                { source: 'Revenue', target: 'Profit', value: 500 }
            ],
            metadata: {}
        };

        // Initialize chart for testing
        let testChart = null;

        function addResult(test, success, message) {
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result ${success ? 'success' : 'error'}`;
            resultDiv.innerHTML = `<strong>${test}:</strong> ${message}`;
            resultsContainer.appendChild(resultDiv);
        }

        function testCategoryManager() {
            try {
                // Create a test chart
                const container = document.createElement('div');
                container.id = 'test-chart';
                document.body.appendChild(container);
                
                testChart = new PulseSankeyChart('test-chart');
                
                // Test 1: Check if categoryManager exists
                if (testChart.categoryManager) {
                    addResult('Category Manager Initialization', true, 'Category manager initialized successfully');
                    
                    // Test 2: Check default categories
                    const defaultCategories = testChart.categoryManager.defaultCategories;
                    const expectedCategories = ['revenue', 'expense', 'profit', 'asset', 'liability'];
                    const hasAllCategories = expectedCategories.every(cat => defaultCategories.hasOwnProperty(cat));
                    
                    if (hasAllCategories) {
                        addResult('Default Categories', true, `All ${expectedCategories.length} default categories found`);
                    } else {
                        addResult('Default Categories', false, 'Some default categories are missing');
                    }
                    
                    // Test 3: Check data structures
                    if (testChart.categoryManager.userCategories instanceof Map && 
                        testChart.categoryManager.nodeCategories instanceof Map) {
                        addResult('Data Structures', true, 'Maps initialized correctly');
                    } else {
                        addResult('Data Structures', false, 'Maps not initialized correctly');
                    }
                    
                } else {
                    addResult('Category Manager Initialization', false, 'Category manager not found');
                }
                
                // Clean up
                container.remove();
                
            } catch (error) {
                addResult('Category Manager Test', false, `Error: ${error.message}`);
            }
        }

        function testCategoryMethods() {
            try {
                if (!testChart) {
                    const container = document.createElement('div');
                    container.id = 'test-chart-2';
                    document.body.appendChild(container);
                    testChart = new PulseSankeyChart('test-chart-2');
                }
                
                // Test data
                testChart.data = mockData;
                
                // Test 1: getCategoryForNode
                const category = testChart.getCategoryForNode('Revenue');
                addResult('getCategoryForNode', category === null, 'Returns null for unassigned node (expected)');
                
                // Test 2: assignNodeToCategory
                testChart.assignNodeToCategory('Revenue', 'revenue');
                const assignedCategory = testChart.getCategoryForNode('Revenue');
                addResult('assignNodeToCategory', assignedCategory === 'revenue', 'Node assigned to category successfully');
                
                // Test 3: createCustomCategory
                const success = testChart.createCustomCategory('Marketing', '#ff6b6b', 'ðŸ“¢', 'Marketing expenses');
                addResult('createCustomCategory', success, 'Custom category created successfully');
                
                // Test 4: getAllCategories
                const allCategories = testChart.getAllCategories();
                const hasCustomCategory = allCategories.hasOwnProperty('Marketing');
                addResult('getAllCategories', hasCustomCategory, 'Custom category found in all categories');
                
                // Test 5: deleteCategory
                const deleteSuccess = testChart.deleteCategory('Marketing');
                addResult('deleteCategory', deleteSuccess, 'Custom category deleted successfully');
                
            } catch (error) {
                addResult('Category Methods Test', false, `Error: ${error.message}`);
            }
        }

        function testMetadataIntegration() {
            try {
                if (!testChart) {
                    const container = document.createElement('div');
                    container.id = 'test-chart-3';
                    document.body.appendChild(container);
                    testChart = new PulseSankeyChart('test-chart-3');
                }
                
                // Test metadata saving
                testChart.data = mockData;
                testChart.createCustomCategory('Test Category', '#123456', 'ðŸ§ª', 'Test category');
                testChart.assignNodeToCategory('Revenue', 'Test Category');
                
                // Check if metadata was saved
                const hasUserCategories = testChart.data.metadata.userCategories && 
                                         testChart.data.metadata.userCategories['Test Category'];
                const hasNodeCategories = testChart.data.metadata.nodeCategories && 
                                         testChart.data.metadata.nodeCategories['Revenue'];
                
                addResult('Metadata Saving', hasUserCategories && hasNodeCategories, 
                         'Categories saved to metadata successfully');
                
                // Test metadata loading
                const newChart = new PulseSankeyChart('test-chart-3');
                newChart.data = { ...mockData };
                newChart.loadCategoriesFromMetadata();
                
                const loadedCategory = newChart.getCategoryForNode('Revenue');
                addResult('Metadata Loading', loadedCategory === 'Test Category', 
                         'Categories loaded from metadata successfully');
                
            } catch (error) {
                addResult('Metadata Integration Test', false, `Error: ${error.message}`);
            }
        }

        function testBackwardsCompatibility() {
            try {
                if (!testChart) {
                    const container = document.createElement('div');
                    container.id = 'test-chart-4';
                    document.body.appendChild(container);
                    testChart = new PulseSankeyChart('test-chart-4');
                }
                
                // Test legacy data with node.category
                const legacyData = {
                    nodes: [
                        { id: 'Revenue', category: 'revenue', depth: 0 },
                        { id: 'Expenses', category: 'expense', depth: 1 }
                    ],
                    links: [],
                    metadata: {}
                };
                
                testChart.data = legacyData;
                testChart.migrateLegacyCategories();
                
                // Check if legacy categories were migrated
                const migratedRevenue = testChart.getCategoryForNode('Revenue');
                const migratedExpenses = testChart.getCategoryForNode('Expenses');
                
                addResult('Legacy Migration', 
                         migratedRevenue === 'revenue' && migratedExpenses === 'expense',
                         'Legacy categories migrated successfully');
                
                // Test getNodeColor with new system
                const color = testChart.getNodeColor({ id: 'Revenue' });
                addResult('Color Integration', color === '#1e40af', 
                         'Category colors work with new system');
                
            } catch (error) {
                addResult('Backwards Compatibility Test', false, `Error: ${error.message}`);
            }
        }

        function testModal() {
            try {
                if (!testChart) {
                    const container = document.createElement('div');
                    container.id = 'test-chart-5';
                    document.body.appendChild(container);
                    testChart = new PulseSankeyChart('test-chart-5');
                }
                
                testChart.data = mockData;
                testChart.testCategoryAssignment('Revenue');
                
                addResult('Modal Test', true, 'Category assignment modal opened successfully');
                
            } catch (error) {
                addResult('Modal Test', false, `Error: ${error.message}`);
            }
        }

        // Auto-run basic tests on page load
        window.onload = function() {
            testResults.innerHTML = '<div class="test-result success">Tests ready to run</div>';
            
            // Run basic initialization test
            setTimeout(() => {
                testCategoryManager();
            }, 500);
        };
    </script>
</body>
</html>
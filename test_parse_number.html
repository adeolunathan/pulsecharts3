<!DOCTYPE html>
<html>
<head>
    <title>parseNumber Test</title>
</head>
<body>
    <h1>Testing parseNumber function</h1>
    <div id="output"></div>
    
    <script src="js/core/SpreadsheetEditor.js"></script>
    
    <script>
        // Create a dummy spreadsheet editor instance to test parseNumber
        const testEditor = {
            parseNumber: function(value) {
                console.log('ðŸ”¢ parseNumber called with:', JSON.stringify(value), 'type:', typeof value);
                
                if (value === null || value === undefined || value === '') {
                    console.log('ðŸ”¢ parseNumber: empty value, returning 0');
                    return 0;
                }
                
                let cleanValue = String(value).trim();
                console.log('ðŸ”¢ parseNumber: initial cleanValue:', JSON.stringify(cleanValue));
                
                // Remove currency symbols
                const beforeCurrency = cleanValue;
                cleanValue = cleanValue.replace(/[$â‚¬Â£Â¥â‚¹â‚½â‚¿â‚©â‚½â‚´â‚¸â‚ºâ‚¼â‚¾â‚¨â‚¦â‚¡â‚±â‚ªâ‚¡]/g, '');
                if (beforeCurrency !== cleanValue) {
                    console.log('ðŸ”¢ parseNumber: removed currency symbols:', JSON.stringify(beforeCurrency), '->', JSON.stringify(cleanValue));
                }
                
                // Handle percentage
                if (cleanValue.endsWith('%')) {
                    cleanValue = cleanValue.slice(0, -1);
                    const num = parseFloat(cleanValue);
                    const result = isNaN(num) ? 0 : Math.trunc(num / 100);
                    console.log('ðŸ”¢ parseNumber: percentage value:', JSON.stringify(cleanValue), 'result:', result);
                    return result;
                }
                
                // Handle parentheses as negative
                if (cleanValue.startsWith('(') && cleanValue.endsWith(')')) {
                    cleanValue = '-' + cleanValue.slice(1, -1);
                    console.log('ðŸ”¢ parseNumber: converted parentheses to negative:', JSON.stringify(cleanValue));
                }
                
                // Handle thousands separators - be more careful
                if (cleanValue.includes(',')) {
                    console.log('ðŸ”¢ parseNumber: contains comma, original:', JSON.stringify(cleanValue));
                    
                    // Handle thousands separators with flexibility
                    // Standard format: 1,234,567 (1-3 digits, then groups of 3)
                    // Also support: 57,405 (any digits before comma, then any digits after)
                    const standardThousandsRegex = /^-?\d{1,3}(,\d{3})*(\.\d+)?$/;
                    const flexibleCommaRegex = /^-?\d+(,\d+)*(\.\d+)?$/;
                    console.log('ðŸ”¢ parseNumber: testing thousands separator regex against:', JSON.stringify(cleanValue));
                    const standardMatch = standardThousandsRegex.test(cleanValue);
                    const flexibleMatch = flexibleCommaRegex.test(cleanValue);
                    console.log('ðŸ”¢ parseNumber: standard regex test result:', standardMatch);
                    console.log('ðŸ”¢ parseNumber: flexible regex test result:', flexibleMatch);
                    
                    if (standardMatch || flexibleMatch) {
                        const before = cleanValue;
                        cleanValue = cleanValue.replace(/,/g, '');
                        console.log('ðŸ”¢ parseNumber: removed thousands separators:', JSON.stringify(before), '->', JSON.stringify(cleanValue));
                    }
                    // European style (1.234.567,50) - but only if we detect this pattern
                    else {
                        const europeanRegex = /^-?\d{1,3}(\.\d{3})*(,\d+)?$/;
                        console.log('ðŸ”¢ parseNumber: testing European format regex against:', JSON.stringify(cleanValue));
                        console.log('ðŸ”¢ parseNumber: European regex test result:', europeanRegex.test(cleanValue));
                        
                        if (europeanRegex.test(cleanValue)) {
                            const before = cleanValue;
                            cleanValue = cleanValue.replace(/\./g, '').replace(',', '.');
                            console.log('ðŸ”¢ parseNumber: converted European format:', JSON.stringify(before), '->', JSON.stringify(cleanValue));
                        } else {
                            console.log('ðŸ”¢ parseNumber: comma found but no pattern matched - might be a different format');
                            // Try removing commas anyway as a fallback
                            const before = cleanValue;
                            cleanValue = cleanValue.replace(/,/g, '');
                            console.log('ðŸ”¢ parseNumber: fallback comma removal:', JSON.stringify(before), '->', JSON.stringify(cleanValue));
                        }
                    }
                }
                
                // Parse the cleaned value
                console.log('ðŸ”¢ parseNumber: about to parse:', JSON.stringify(cleanValue));
                const num = parseFloat(cleanValue);
                console.log('ðŸ”¢ parseNumber: parseFloat result:', num, 'isNaN:', isNaN(num));
                
                if (isNaN(num)) {
                    console.log('ðŸ”¢ parseNumber: NaN detected, returning 0');
                    return 0;
                }
                
                // Return whole number (truncate decimals completely)
                const result = Math.trunc(num);
                console.log('ðŸ”¢ parseNumber: final result:', result);
                return result;
            }
        };
        
        // Test cases
        const testCases = [
            "57,405",
            "57405",
            "1,234,567",
            "1234567",
            "12,34",
            "1,2,3,4",
            "57.405", 
            "57,405.50",
            "$57,405",
            "â‚¬1.234.567,50",
            "1.234.567",
            "1,234.56"
        ];
        
        const output = document.getElementById('output');
        
        testCases.forEach(testCase => {
            console.log('\n============ TESTING:', JSON.stringify(testCase), '============');
            const result = testEditor.parseNumber(testCase);
            const div = document.createElement('div');
            div.innerHTML = `Input: "${testCase}" â†’ Output: ${result}`;
            output.appendChild(div);
            console.log('FINAL RESULT for', JSON.stringify(testCase), ':', result);
        });
    </script>
</body>
</html>
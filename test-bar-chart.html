<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bar Chart Test - Pulse Analytics</title>
    
    <!-- External Dependencies -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    
    <!-- Load all reusable utilities first -->
    <script src="js/utils/ChartZoom.js"></script>
    <script src="js/utils/ChartColorPicker.js"></script>
    <script src="js/utils/ChartBrandingUtils.js"></script>
    <script src="js/utils/ChartUtils.js"></script>
    <script src="js/utils/ChartExports.js"></script>
    
    <!-- Load Bar Chart components -->
    <script src="js/charts/bar/BarChartConfig.js"></script>
    <script src="js/charts/bar/BarChart.js"></script>
    <script src="js/charts/bar/BarControls.js"></script>
    
    <style>
        body {
            font-family: Inter, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f8f9fa;
        }
        
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .controls {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 6px;
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .controls button {
            padding: 8px 16px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .controls button:hover {
            background: #2980b9;
        }
        
        .chart-container {
            width: 100%;
            height: 600px;
            border: 1px solid #e1e5e9;
            border-radius: 4px;
        }
        
        .status {
            margin-top: 15px;
            padding: 10px;
            background: #e8f4fd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>🧪 Bar Chart Test - Reusable Architecture</h1>
        <p>Testing the new bar chart implementation using all extracted reusable modules.</p>
        
        <div class="controls">
            <button onclick="loadSampleData()">📊 Load Sample Data</button>
            <button onclick="loadCustomData()">🎯 Load Custom Data</button>
            <button onclick="testExports()">📁 Test Exports</button>
            <button onclick="testZoom()">🔍 Test Zoom</button>
            <button onclick="testColorPicker()">🎨 Test Colors</button>
        </div>
        
        <div id="bar-chart-container" class="chart-container"></div>
        
        <div id="status" class="status">
            Ready to test bar chart functionality...
        </div>
    </div>

    <script>
        let barChart = null;
        let barControls = null;
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🧪 Starting Bar Chart Test');
            updateStatus('Initializing bar chart test...', 'info');
            
            // Verify all dependencies are loaded
            verifyDependencies();
            
            // Initialize bar chart
            initializeBarChart();
        });
        
        function verifyDependencies() {
            console.log('🔍 Verifying dependencies:');
            const deps = {
                'd3': typeof d3,
                'ChartZoom': typeof window.ChartZoom,
                'ChartColorPicker': typeof window.ChartColorPicker,
                'ChartBrandingUtils': typeof window.ChartBrandingUtils,
                'ChartUtils': typeof window.ChartUtils,
                'ChartExports': typeof window.ChartExports,
                'BarChartConfig': typeof window.BarChartConfig,
                'PulseBarChart': typeof window.PulseBarChart,
                'BarControlModule': typeof window.BarControlModule
            };
            
            let allGood = true;
            for (const [name, type] of Object.entries(deps)) {
                const available = type !== 'undefined';
                console.log(`- ${name}: ${type} ${available ? '✅' : '❌'}`);
                if (!available) allGood = false;
            }
            
            if (allGood) {
                updateStatus('All dependencies loaded successfully! 🎉', 'success');
            } else {
                updateStatus('Some dependencies are missing. Check console for details.', 'error');
            }
        }
        
        function initializeBarChart() {
            try {
                console.log('📊 Initializing PulseBarChart...');
                barChart = new PulseBarChart('bar-chart-container');
                
                console.log('🎛️ Initializing BarControlModule...');
                barControls = new BarControlModule();
                
                updateStatus('Bar chart initialized successfully! 🎉', 'success');
            } catch (error) {
                console.error('❌ Bar chart initialization failed:', error);
                updateStatus(`Initialization failed: ${error.message}`, 'error');
            }
        }
        
        function loadSampleData() {
            console.log('📁 Loading sample data...');
            updateStatus('Loading sample data...', 'info');
            
            fetch('data/samples/bar-chart-sample.json')
                .then(response => response.json())
                .then(data => {
                    console.log('✅ Sample data loaded:', data);
                    
                    if (barChart) {
                        barChart.render(data);
                        updateStatus('Sample data loaded and rendered! 📊', 'success');
                        
                        // Test control module with the chart
                        if (barControls) {
                            barControls.populateDynamicColors(barChart);
                            console.log('🎨 Dynamic colors populated');
                        }
                    } else {
                        updateStatus('Bar chart not initialized', 'error');
                    }
                })
                .catch(error => {
                    console.error('❌ Failed to load sample data:', error);
                    updateStatus(`Failed to load sample data: ${error.message}`, 'error');
                });
        }
        
        function loadCustomData() {
            console.log('🎯 Loading custom test data...');
            updateStatus('Loading custom test data...', 'info');
            
            // Create simple test data
            const customData = {
                metadata: {
                    company: "Test Company",
                    period: "Q4 2024",
                    title: "Custom Test Data"
                },
                categories: ["Product A", "Product B", "Product C", "Product D"],
                values: [150000, 120000, 80000, 65000],
                labels: ["Product A", "Product B", "Product C", "Product D"]
            };
            
            if (barChart) {
                barChart.render(customData);
                updateStatus('Custom data loaded and rendered! 🎯', 'success');
                
                // Test control module
                if (barControls) {
                    barControls.populateDynamicColors(barChart);
                    console.log('🎨 Dynamic colors populated for custom data');
                }
            } else {
                updateStatus('Bar chart not initialized', 'error');
            }
        }
        
        function testExports() {
            console.log('📁 Testing export functionality...');
            updateStatus('Testing export functionality...', 'info');
            
            if (!barChart) {
                updateStatus('Bar chart not initialized', 'error');
                return;
            }
            
            try {
                // Test PNG export
                console.log('📸 Testing PNG export...');
                barChart.exportToPNG('test-bar-chart.png');
                
                // Test SVG export
                console.log('🖼️ Testing SVG export...');
                barChart.exportToSVG('test-bar-chart.svg');
                
                // Test CSV export
                console.log('📋 Testing CSV export...');
                barChart.exportToCSV('test-bar-chart.csv');
                
                updateStatus('Export functionality tested! Check downloads. 📁', 'success');
            } catch (error) {
                console.error('❌ Export test failed:', error);
                updateStatus(`Export test failed: ${error.message}`, 'error');
            }
        }
        
        function testZoom() {
            console.log('🔍 Testing zoom functionality...');
            updateStatus('Testing zoom functionality...', 'info');
            
            if (!barChart) {
                updateStatus('Bar chart not initialized', 'error');
                return;
            }
            
            try {
                console.log('🔄 Testing zoom reset...');
                barChart.resetZoom();
                updateStatus('Zoom functionality tested! Try zooming and panning on the chart. 🔍', 'success');
            } catch (error) {
                console.error('❌ Zoom test failed:', error);
                updateStatus(`Zoom test failed: ${error.message}`, 'error');
            }
        }
        
        function testColorPicker() {
            console.log('🎨 Testing color picker functionality...');
            updateStatus('Testing color picker - click on any bar to change its color! 🎨', 'info');
            
            if (!barChart) {
                updateStatus('Bar chart not initialized', 'error');
                return;
            }
            
            // The color picker is already integrated into the bar chart
            // Users can click on bars to test it
            updateStatus('Color picker ready! Click on any bar to test color selection. 🎨', 'success');
        }
        
        function updateStatus(message, type = 'info') {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
            console.log(`📢 Status: ${message}`);
        }
    </script>
</body>
</html>